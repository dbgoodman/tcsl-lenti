---
title: "fig4_compiled.Rmd"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Fig4

Plots adapted from plots_incucyte.Rmd.

```{r cars}
library(ggplot2)
library(data.table)
library(scales)
library(RColorBrewer)
library(ggrepel)
library(plyr)
library(ggpubr)
library(cowplot)
library(rstatix)

output_dir <- file.path(here::here('..','figs'))

data_dir <- here::here('..','data')

# data.output.dir <- file.path(here::here(
#   '..','..',
#   's3-roybal-tcsl',
#   'lenti_screen_compiled_data','data'))

s3.data.dir <- '/Volumes/s3/roybal-tcsl/lenti_screen_compiled_data/data'
data.output.dir <- s3.data.dir
  
load(file=file.path(data.output.dir, 'incucyte_plot_data.Rdata'))

# add 'd' in front of days
incucyte_new_dt[, day_f := factor(day, levels=c(0,8,15,22,29), labels=paste0('d',c(0,8,15,22,29)))]
incucyte_new_dt[, t_type := factor(t_type, labels=toupper(unique(t_type)))]

car_set <- c('41BB','CD28','BAFF-R','CD40','TACI','TNR8','KLRG1','zeta')
chosen_measure <- 'redintensity'
source(here::here('r','fig_colors.R'))

```

## Killing Intensity Means

```{r, echo=FALSE}

plot_set_time <- function(df, elapsed_hr, cast_y=donor, switch_facet=NULL, pt_size=2){
  

  df_plot <- unique(df[Elapsed==elapsed_hr,
    list(k562, day, t_type, donor, car, mean_value_none,
         std_dev_value_none, day_f, Elapsed)])
  
  # add 'd' in front of days
  df_plot[, t_type := toupper(t_type)]

  
  # use % killed insted of % remaning
  df_plot[, mean_pct_killed := 1-mean_value_none]

  t_type <- df_plot[, unique(t_type)]
  stopifnot(length(t_type) == 1)
  df_plot[, car := factor(car, levels=car_order)]
  
  # we are creating a name which will be unique per dot, and include the rank
  df_plot[, 
    day_rank := factor(paste(rank(mean_pct_killed), 
      car, day, donor, t_type, sep= '|')), 
    by=c('k562','day','t_type','donor')]
  
  cast_y=enquo(cast_y)

  plot <- ggplot(df_plot,
    aes(x=day_rank, 
      y=mean_pct_killed, 
      fill=car, color=car, group=car)) +
    geom_linerange(aes(
      ymin=mean_pct_killed-std_dev_value_none,
      ymax=mean_pct_killed+std_dev_value_none)) +
    geom_point(
      color='grey30', 
      shape=21, position=position_dodge(width=1),
      size=pt_size) +
    facet_grid(vars(!!cast_y), vars(day_f), space='free', scales='free', switch=switch_facet) +
    theme_minimal(base_size=12) +
    theme(
      plot.title = element_text(size = 25),
      panel.spacing.y=unit(80,'pt'), 
      axis.text.x=element_blank(),
      panel.grid.minor = element_blank(),
      panel.grid.major = element_blank(),
      panel.border = element_rect(fill=NA)) +
    scale_fill_manual(values=rev(car_colors)) +
    scale_color_manual(values=rev(car_colors)) +
    scale_y_continuous(labels = scales::percent,
      limits=c(0,1.05),
      breaks=c(0, 0.25, 0.5, 0.75, 1)) +
    geom_hline(yintercept=1, color='gray60', linetype=2) +
    labs(x=" ", y=" ")

  return(plot)
}

combine_plots <- function(plot1, plot2, legend_pct, use_leg=T, num_col=1) {
  leg <- get_legend(plot1 + theme(legend.box.margin = margin(0, 0, 0, 12)))
  prow <- plot_grid(
    plot1 + theme(legend.position="none"),
    plot2 + theme(legend.position="none"),
    ncol= 1, align= 'v', axis= 'l')
  
  if (use_leg) {
    plot_grid(prow, leg, rel_widths = c(1-legend_pct, legend_pct))
  } else {
    prow
  }
}

combine_plots_vert <- function(plot1, plot2, legend_pct, use_leg=T, num_col=2, rel_widths=c(1,1)) {
  
  leg <- get_legend(plot1 + theme(legend.box.margin = margin(0, 0, 0, 12)))
  
  prow <- plot_grid(
    plot1 + theme(legend.position="none"),
    plot2 + theme(legend.position="none"),
    ncol= 2, align= 'h', axis= 't', rel_widths=rel_widths)
  
  if (use_leg) {
    plot_grid(prow, leg, rel_widths = c(1-legend_pct, legend_pct))
  } else {
    prow
  }
}

killing_plots_combined_cd8 <- combine_plots(
  plot_set_time(
    incucyte_new_dt[k562=='mkate_cd19' & !noise & t_type == 'CD8' & donor == 1 &
      measurement==chosen_measure & car!='none'], 30),
  plot_set_time(
    incucyte_new_dt[k562=='mkate_cd19' & !noise & t_type == 'CD8' & donor == 2 &
      measurement==chosen_measure & car!='none'], 32),
  0.2)

killing_plots_combined_cd4 <- combine_plots(
  plot_set_time(
    incucyte_new_dt[k562=='mkate_cd19' & !noise & t_type == 'CD4' & donor == 1 &
      measurement==chosen_measure & car!='none'], 80),
  plot_set_time(
    incucyte_new_dt[k562=='mkate_cd19' & !noise & t_type == 'CD4' & donor == 2 &
      measurement==chosen_measure & car!='none'], 76), 
  0.2)
  

### combined 4 and 8

cd4_mean_dt <- incucyte_new_dt[
  k562=='mkate_cd19' & !noise & t_type == 'CD4' & 
  measurement==chosen_measure & car!='none' & 
  ((donor == 1 & Elapsed == 80) | (donor == 2 & Elapsed == 76))][, 
    `:=`(
      Elapsed= 80, 
      mean_value_none=mean(mean_value_none, na.rm=T), 
      std_dev_value_none=sd(mean_value_none, na.rm=T)),
    by=c('day_f','car_f','t_type')]

cd8_mean_dt <- incucyte_new_dt[
  k562=='mkate_cd19' & !noise & t_type == 'CD8' & 
  measurement==chosen_measure & car!='none' & 
  ((donor == 1 & Elapsed == 30) | (donor == 2 & Elapsed == 32))][, 
    `:=`(
      Elapsed= 32, 
      mean_value_none=mean(mean_value_none, na.rm=T), 
      std_dev_value_none=sd(mean_value_none, na.rm=T)),
    by=c('day_f','car_f','t_type')]

killing_plots_combined_all <- combine_plots(
  plot_set_time(copy(cd4_mean_dt)[, `:=`(donor= 1, Elapsed=80)], 80, cast_y=t_type),
  plot_set_time(copy(cd8_mean_dt)[, `:=`(donor= 1, Elapsed=32)], 32, cast_y=t_type),
  0.2)

killing_plots_combined_all <- combine_plots(
  plot_set_time(copy(cd4_mean_dt)[, `:=`(donor= 1, Elapsed=80)], 80, cast_y=t_type),
  plot_set_time(copy(cd8_mean_dt)[, `:=`(donor= 1, Elapsed=32)], 32, cast_y=t_type),
  0.2, use_leg=F)

killing_plots_combined_all_vert_old <- combine_plots_vert(
  plot_set_time(copy(cd4_mean_dt)[, `:=`(donor= 1, Elapsed=80)], 80, cast_y=t_type, switch_facet='x'),
  plot_set_time(copy(cd8_mean_dt)[, `:=`(donor= 1, Elapsed=32)], 32, cast_y=t_type, switch_facet='x'),
  0.2, use_leg=F)

```

```{r}
# Killing curves normalized to no cells

incucyte_new_dt[, mean_value_none_rollmean5 := frollmean(mean_value_none, 5, algo='fast', align='center', fill=NA, na.rm=T), 
  by=c('measurement','donor','day','k562','well','car','image')]

incucyte_new_dt[, mean_value_none_rollmean10 := frollmean(mean_value_none, 10, algo='fast', align='center', fill=NA, na.rm=T), 
  by=c('measurement','donor','day','k562','well','car','image')]

incucyte_new_dt[Elapsed < 5, mean_value_none_rollmean10 := mean_value_none, 
  by=c('measurement','donor','day','k562','well','car','image')]
incucyte_new_dt[Elapsed < 2, mean_value_none_rollmean5 := mean_value_none, 
  by=c('measurement','donor','day','k562','well','car','image')]

incucyte_new_dt[noise==F, mean_value_none_rollmean10_rmnoise := frollmean(
    mean_value_none, 10, algo='fast', align='center', fill=NA, na.rm=T), 
  by=c('measurement','donor','day','k562','well','car','image')]

# pick days
cd4_days <- c(8,22)
cd8_days <- c(0,29)

killing_panel_spacing <- theme(
  panel.spacing.y = unit(0.6, "lines"), 
  panel.spacing.x = unit(0.9, "lines"))

plot_killing_cd4_log <- ggplot(incucyte_new_dt[
    k562=='mkate_cd19' & noise == F & t_type == 'CD4' & measurement == chosen_measure & 
    car!='none' & day_f %in% paste0('d',cd4_days) & donor %in% c(1,2)], 
  aes(x=Elapsed, y=mean_value_none_rollmean10, group=interaction(car, day_f,donor), fill=day_f)) + 
  geom_line(aes(color=car), size=1.2) + 
  facet_grid(donor~day_f, scales='free_y') + 
  theme_minimal(base_size=12) + geom_vline(xintercept=0) + geom_hline(yintercept=0) +
  theme(plot.title = element_text(size = 15)) + 
  scale_x_continuous(expand=c(0,0), limits=c(0,100)) +
  scale_y_continuous('% Tumor Cells remaining', limits=c(0.01, 1.05),
  trans=log10_trans(), labels=scales::percent_format(accuracy=1)) +
  theme(plot.title = element_text(hjust = 0.5)) + 
  scale_color_manual(values=car_colors) + 
  scale_fill_manual(values=car_colors) + 
  geom_hline(yintercept=1, color='gray60') +
  geom_vline(xintercept=80, linetype=2, color='gray60') +
  killing_panel_spacing + 
  theme(
    panel.spacing = unit(0.6, "lines"),
    panel.border = element_rect(fill=NA),
    strip.text.y = element_blank())

plot_killing_cd8_log <- ggplot(incucyte_new_dt[k562=='mkate_cd19' & !noise & t_type == 'CD8' & measurement == chosen_measure & 
    car != 'none' & day_f %in% paste0('d',cd8_days)  & donor %in% c(1,2)][,
      donor := factor(donor, labels=c('Donor 1',' Donor 2'))], 
  aes(x=Elapsed, y=mean_value_none_rollmean10, group=interaction(car, day_f,donor), fill=day_f)) + 
  geom_line(aes(color=car), size=1.2) + 
  facet_grid(donor~day_f, scales='free_y') + 
  theme_minimal(base_size=12) + geom_vline(xintercept=0) + geom_hline(yintercept=0) +
  theme(plot.title = element_text(size = 15)) + 
  scale_x_continuous(expand=c(0,0), limits=c(0,50)) +
  scale_y_continuous('', limits=c(0.01, 1.05),
  trans=log10_trans(), labels=scales::percent_format(accuracy=1)) +
  theme(plot.title = element_text(hjust = 0.5)) + 
  scale_color_manual(values=car_colors) + 
  scale_fill_manual(values=car_colors) + 
  geom_hline(yintercept=1,
            color='gray60') +
  geom_vline(xintercept=32, linetype=2, color='gray60') +
  killing_panel_spacing + 
  theme(panel.border = element_rect(fill=NA))

killing_plots_combined_all_vert <- combine_plots_vert(
  plot_set_time(cd4_mean_dt[, `:=`(donor= 1, Elapsed=80)], 80, cast_y=t_type, switch_facet=NULL, pt_size = 3.5) +
   theme(
     strip.text.y=element_blank(),
     plot.margin=margin(10,10,-20,10),
     panel.spacing.x=unit(-0.5,'pt')) + 
  labs(y='% Tumor Cells Killed'),
  plot_set_time(cd8_mean_dt[, `:=`(donor= 1, Elapsed=32)], 32, cast_y=t_type, switch_facet=NULL, pt_size = 3.5) +
   theme(
     strip.text.y=element_blank(),
     plot.margin=margin(10,25,-20,-6),
     axis.text.y=element_blank(),
     panel.spacing.x=unit(-0.5,'pt')),
  0.2, use_leg=F, rel_widths=c(0.53,0.47))

in_vitro_killing <- plot_grid(
  killing_plots_combined_all_vert,
  plot_grid(
    plot_killing_cd4_log
      + labs(x='Hours of co-culture', y='% Tumor Cells remaining')
      + theme(
          legend.position='none',
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank()),
    plot_killing_cd8_log
      + labs(x='Hours of co-culture', y='')
      + theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position='none',
        axis.text.y=element_blank(),
        plot.margin=margin(5.5,5.5,5.5,-5.5)),
    rel_widths=c(0.53,0.47)),
  ncol=1, rel_heights=c(0.4,0.6), labels=c('D','E'))

in_vitro_killing
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

### Donor 3 and 4 Killing (supp)

```{r}



d34_curves <- ggplot(incucyte_new_dt[
    k562=='mkate_cd19' & !noise & t_type == 'CD4' & measurement == chosen_measure & 
    car!='none' & donor %in% c(3,4) & car != 'zeta'][,
      donor := factor(donor, labels=c('Donor 3','Donor 4'))
    ], 
  aes(x=Elapsed, y=mean_value_none_rollmean10_rmnoise, group=interaction(car, day_f,donor), fill=day_f)) + 
  geom_line(aes(color=car)) + 
  facet_grid(donor~day_f, scales='free_y') + 
  theme_minimal(base_size=12) + geom_vline(xintercept=0) + geom_hline(yintercept=0) +
  theme(plot.title = element_text(size = 15)) + 
  scale_x_continuous(expand=c(0,0), limits=c(0,100)) +
  scale_y_continuous('% Tumor Cells remaining', limits=c(0.1, 1.05),
  trans=log10_trans(), labels=scales::percent_format(accuracy=1)) +
  theme(plot.title = element_text(hjust = 0.5)) + 
  scale_color_manual(values=car_colors) + 
  scale_fill_manual(values=car_colors) + 
  geom_hline(yintercept=1, color='gray60') +
  killing_panel_spacing + 
  theme(
    panel.spacing = unit(0.6, "lines"),
    panel.border = element_rect(fill=NA))


d34_rank <- combine_plots(
  plot_set_time(
    incucyte_new_dt[k562=='mkate_cd19' & !noise & t_type == 'CD4' & donor %in% c(3,4) &
      measurement==chosen_measure & car!='none'], 80),
  plot_set_time(
    incucyte_new_dt[k562=='mkate_cd19' & !noise & t_type == 'CD4' & donor == 4 &
      measurement==chosen_measure & car!='none'], 76), 
  0.2)

cd4_mean_34_dt <- incucyte_new_dt[
  k562=='mkate_cd19' & !noise & t_type == 'CD4' & 
  measurement==chosen_measure & car!='none' & car != 'zeta' &
  ((donor == 3 & Elapsed == 80) | (donor == 4 & Elapsed == 80))][, 
    `:=`(
      Elapsed= 80, 
      mean_value_none=mean(mean_value_none, na.rm=T), 
      std_dev_value_none=sd(mean_value_none, na.rm=T)),
    by=c('day_f','car_f','t_type')]

d34_combined <- plot_grid(
  plot_set_time(
    cd4_mean_34_dt[, `:=`(donor= 1, Elapsed=80)], 80, cast_y=t_type, switch_facet=NULL) +
    theme(
       strip.text.y=element_blank(),
       legend.position='none',
       plot.margin=margin(10,10,-20,10),
       panel.spacing.x=unit(-0.5,'pt')) + 
    labs(y='% Tumor Cells Killed'), 
  d34_curves +
      labs(x='Hours of co-culture', y='% Tumor Cells remaining') +
      theme(
          legend.position='none',
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank()),
  ncol=1)
```

### CD4 All donors

```{r}

cd4_mean_all_dt <- incucyte_new_dt[
  k562=='mkate_cd19' & !noise & t_type == 'CD4' & day != 29 &
  measurement==chosen_measure & car %in% c('41BB','CD28','BAFF-R','TACI') &
  ((donor %in% c(1,3,4) & Elapsed == 76) | (donor == 2 & Elapsed == 76))][, 
    `:=`(
      Elapsed= 76, 
      mean_value_none=mean(mean_value_none, na.rm=T), 
      std_dev_value_none=sd(mean_value_none, na.rm=T)),
    by=c('day_f','car_f','t_type')]

cd4_all_curves_dt <- incucyte_new_dt[
  k562=='mkate_cd19' & !noise & t_type == 'CD4' & measurement == chosen_measure & 
  car %in% c('41BB','CD28','BAFF-R','TACI') & day != 29][,
    donor := factor(donor, labels=paste0('Donor ',levels(donor)))
  ]

cd4_all_curves_dt[donor %in% c('Donor 3','Donor 4'),
  mean_value_none_rollmean10 := mean_value_none_rollmean10_rmnoise]

cd4_all_curves <- ggplot(cd4_all_curves_dt, 
    aes(
      x=Elapsed,
      y=mean_value_none_rollmean10,
      group=interaction(car, day_f,donor),
      fill=day_f)) + 
  geom_line(aes(color=car)) + 
  facet_grid(donor~day_f, scales='free_y') + 
  theme_minimal(base_size=12) + geom_vline(xintercept=0) + geom_hline(yintercept=0) +
  theme(plot.title = element_text(size = 15)) + 
  scale_x_continuous(expand=c(0,0), limits=c(0,80)) +
  scale_y_continuous('% Tumor Cells remaining', limits=c(0.05, 1.05),
  labels=scales::percent_format(accuracy=1)) +
  theme(plot.title = element_text(hjust = 0.5)) + 
  scale_color_manual(values=car_colors) + 
  scale_fill_manual(values=car_colors) + 
  geom_hline(yintercept=1, color='gray60') +
  geom_vline(xintercept=76, linetype=2, color='gray60') +
  killing_panel_spacing + 
  theme(
    panel.spacing = unit(0.6, "lines"),
    panel.border = element_rect(fill=NA))

cd4_all_combined <-  plot_grid(
  plot_set_time(
    cd4_mean_all_dt[, `:=`(donor= 1, Elapsed=76)], 76, cast_y=t_type, switch_facet=NULL) +
    theme(
       strip.text.y=element_blank(),
       legend.position='none',
       plot.margin=margin(10,10,-20,10),
       panel.spacing.x=unit(-0.5,'pt')) + 
    labs(y='% Tumor Cells Killed') + 
    scale_y_continuous(labels = scales::percent, trans=log10_trans(),
      limits=c(0.5,1.05),
      breaks=c(0.5, 0.75, 1)), 
  cd4_all_curves +
      labs(x='Hours of co-culture', y='% Tumor Cells remaining') +
      theme(
          legend.position='none',
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank()),
  ncol=1, rel_heights=c(1,2))
```

# killing ranking stats   

```{r}

endpoint_killing <- unique(rbind(
    cd4_mean_dt[, `:=`(Elapsed=80)], 
    cd8_mean_dt[, `:=`(Elapsed=32)])[,
        list(k562, day, t_type, donor, car, mean_value_none = as.numeric(mean_value_none),
         std_dev_value_none, day=as.numeric(day), Elapsed)])[,
  list(car, mean_value_none), by=.(day, t_type, donor)]

car_killing_order <- endpoint_killing[, levels(reorder(car, -mean_value_none))]

endpoint_killing_stats <- data.table(
  endpoint_killing[, car := factor(car, levels=car_killing_order)][] %>% 
    pairwise_wilcox_test(mean_value_none ~ car))

endpoint_killing_stats[, group1 := factor(group1, levels=car_killing_order)]
endpoint_killing_stats[, group2 := factor(group2, levels=car_killing_order[-1])]

endpoint_killing_stat_plot <- ggplot(endpoint_killing_stats, 
    aes(
      x=group1,
      y=group2,
      fill=-log10(p.adj),
      label=p.adj.signif)) + 
  geom_tile(color='white') + 
  scale_fill_distiller(palette='RdPu', direction=1,
    guide=guide_colorbar(
      barheight=0.7,
      direction = "horizontal",
      title.position = "top")) + 
  geom_text() + 
  coord_cartesian(clip = 'off') +
  annotate(geom='point', x=0.2, y=1:7, color=car_colors[car_killing_order[2:8]]) +
  annotate(geom='point', pch=17,
    y=0.2, x=1:7, color=car_colors[car_killing_order[1:7]]) +
  labs(x='', y='Overall Cytotoxicity Rank', fill='-log10(p), MWU') +
  theme_minimal() +
  theme(panel.grid=element_blank(),
        legend.position=c(1,0.05),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        legend.justification=c(1,0))
```
### cytokines

```{r}

parent_folder = here::here('..')
#flow.dt <- fread("/Users/camilliaazimi/Box\ Sync/tcsl/flow/TCSL105\ ALL\ FILES/Cytokines/tcsl105cytokines.csv")
#cytokine_fn <- "~/s3-roybal-tcsl/lenti_screen_compiled_data/data/csv/tcsl105_cytokines.csv"
cytokine_fn <- paste0(s3.data.dir, "/csv/tcsl105_cytokines.csv")

flow.dt <- fread(cytokine_fn)

#getting rid of outliers with the next line
flow.dt <- flow.dt[outlier == FALSE]

flow.means.dt <- flow.dt[, list(
  pct.mean= mean(pct, na.rm=T), 
  pct.stdev= sd(pct, na.rm=T)),
    by=c('k562','cell.type','car',
         'days','cytokine', 'donor')][,
    pct.mean.donor := mean(pct.mean, na.rm=T), 
      by=c('car','days','cell.type','k562','cytokine')]

cytokines <- ggplot(flow.means.dt[k562 == '+'][car=='Zeta', car := 'zeta'][car=='BAFFR', car := 'BAFF-R']) + 
  geom_tile(aes(x=as.factor(days), y=factor(car, levels=rev(car_order)), fill=pct.mean.donor), color='white') + 
  facet_grid( ~ cytokine) + scale_fill_viridis_c('% Positive Cells\n(mean of 2 donors)') +
  labs(x='Days in culture',y='') +
  theme_minimal() + 
  theme(
    panel.background=element_rect(fill="white", colour="white"),
    panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
    legend.position = "bottom") +
  theme(legend.title.align=0.5, plot.title = element_text(hjust = 0.5))

cytokines_d1_d10 <- ggplot(
  flow.means.dt[k562 == '+'][car=='Zeta', car := 'zeta'][car=='BAFFR', car := 'BAFF-R'][days < 18]) + 
  geom_tile(aes(x=as.factor(days), y=factor(car, levels=rev(car_order)), fill=pct.mean.donor), color='white') + 
  facet_grid( ~ cytokine) + scale_fill_viridis_c('% Positive,\nmean of\n2 donors') +
  labs(x='Days in culture',y='') +
  theme_minimal() + 
  theme(
    panel.background=element_rect(fill="white", colour="white"),
    panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
    legend.position = "bottom") +
  theme(legend.title.align=0.5, plot.title = element_text(hjust = 0.5))

cytokines_d1_d10_horiz <- ggplot(
  flow.means.dt[k562 == '+'][car=='Zeta', car := 'zeta'][car=='BAFFR', car := 'BAFF-R'][car=='TNR8', car := 'CD30'][days < 18]) + 
  geom_tile(aes(x=factor(days, levels=c(10,4,1)), y=factor(car, levels=gsub('TNR8','CD30',car_order)), fill=pct.mean.donor), color='white') + 
  facet_grid( ~ cytokine) + scale_fill_viridis_c('% Positive,\nmean of\n2 donors') +
  labs(x='Days in culture',y='') +
  coord_flip() +
  theme_minimal() + 
  theme(
    axis.text.x= element_text(
      #color=setNames(car_colors, gsub('TNR8','CD30', names(car_colors))),
      #face='bold', size=rel(1.1), 
      angle = 90, hjust=1, vjust=0.5),
    panel.background=element_rect(fill="white", colour="white"),
    panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
    legend.position = "right") +
  theme(legend.title.align=0.5, plot.title = element_text(hjust = 0.5))

```

### Cytokines all days separate donors supp

```{r}
flow.dt <- flow.dt[outlier == FALSE]

flow.all.means.dt <- flow.dt[, list(
  pct.mean= mean(pct, na.rm=T), 
  pct.stdev= sd(pct, na.rm=T)),
    by=c('k562','cell.type','car',
         'days','cytokine', 'donor')]

flow.all.means.dt <- flow.all.means.dt[k562 == '+'][
  car=='Zeta', car := 'zeta'][
  car=='BAFFR', car := 'BAFF-R'][
  car=='TNR8', car := 'CD30'][,
  donor := factor(donor, labels=c('Donor 1','Donor 2'))]

cytokines_all <- ggplot(flow.all.means.dt) + 
  geom_tile(aes(
      x=as.factor(days),
      y=factor(car, levels=rev(gsub('TNR8','CD30',car_order))),
      fill=pct.mean),
    color='white') + 
  facet_grid(donor ~ cytokine) + scale_fill_viridis_c('% Positive Cells') +
  labs(x='Days in culture',y='') +
  theme_minimal() + 
  theme(
    legend.key.height=unit(0.4, 'lines'),
    panel.background=element_rect(fill="white", colour="white"),
    panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
    legend.position = "bottom") +
  theme(legend.title.align=0.5, plot.title = element_text(hjust = 0.5))

cytokines_all

```

## jurkat signaling

```{r}

plots <- list()

#to make a data table with my csv 
# signaling.dt <- fread(paste0(
#   '/home/ec2-user/s3-roybal-tcsl/lenti_screen_compiled_data/data/csv/',
#   'tcsl148.csv'))

signaling.dt <- fread(paste0(
  s3.data.dir,'/csv/tcsl148.csv'))


#to make 0 hours no stimulation bar copy onto all of the stimulation types 
# (even though it did not get + or - stim)
map_day_0_sig <- function(df) {
    return(rbind(
        df,
        df[Stimulation=='none' & Hours == 0][, Stimulation := '+'],
        df[Stimulation=='none' & Hours == 0][, Stimulation := '-']
    ))}

# make labels that are easier to interpret
signaling.dt[, 
  line_lab := factor(as.character(Line), 
    levels=c('4045','4046', '4047'), 
    labels=c('AP1', 'NFAT', 'NFkB'))]

#this is to normalize the data to untransduced from the same day
signaling.dt[, 
    combo_mcherry_pct_v_unt := 
        # within each group, subtract each CAR pct from the untransduced
        combo_mcherry_percent - combo_mcherry_percent[CAR=='Unt'], 
    by=c('Hours','Line','Stimulation')]

signaling.dt[, 
    combo_mcherry_mfi_v_unt := 
        # within each group, subtract each CAR mfi from the untransduced
        combo_mcherry_mfi / combo_mcherry_mfi[CAR=='Unt'], 
    by=c('Hours','Line','Stimulation')]

car_colors_orig <- car_colors

car_labels <- c('41BB','BAFF-R','BAFF-R H159Y', 'CD28', 'CD40', 'KLRG1', 
                 'TACI', 'TNR8', 'Untransduced', 'Zeta')
car_names <- c('41BB','Baffr','Baffr mut', 'CD28', 'CD40', 'KLRG1', 
                'TACI', 'TNR8', 'Unt', 'Zeta')

car_colors_signaling <- car_colors_orig[gsub('\\s+.*','',car_labels)]
names(car_colors_signaling) <- car_labels

car_linetypes <- c(1,1,3,1,1,1,1,1,3,1)
names(car_linetypes) <- car_labels

plot.signaling.dt <- map_day_0_sig(signaling.dt)

plot.signaling.dt[, car_lab := factor(CAR, levels=car_names, labels=car_labels)]
plot.signaling.dt[, stim_lab := factor(Stimulation, 
  levels=c('-','+','none'), labels=c('CD19-','CD19+','none'))]

plots$combined_sig_plot <- ggplot(plot.signaling.dt[CAR != 'none' & stim_lab != 'none'], 
      aes(x=Hours, y=combo_mcherry_pct_v_unt, color=car_lab, linetype=car_lab)) + 
    facet_grid(line_lab ~ stim_lab, scales='free', drop=T) +
    geom_line() + 
    geom_point() +
    theme_cowplot() +
    scale_color_manual('', values=car_colors_signaling) +
    scale_linetype_manual('', values=car_linetypes) +
    scale_x_continuous(breaks=c(0,8,24,48), limits=c(0,48), label=label_percent()) +
    theme(axis.text.x = element_text(hjust = .5), 
      legend.title.align=0.5, 
      plot.title = element_text(hjust = 0.5)) +
    labs(x='Hours of Stimulation', y='Rel. Reporter Activity vs Untransduced') +
    theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank())

plots$combined_sig_plot_nomut <- ggplot(plot.signaling.dt[
        !(CAR %in% c('Baffr mut','Unt','none')) & grepl('CD19', stim_lab)], 
      aes(x=Hours, y=combo_mcherry_pct_v_unt, color=car_lab, linetype=car_lab)) + 
    facet_grid(stim_lab ~ line_lab, scales='free', drop=T) +
    geom_line(size=1) + 
    geom_point(size=2) +
    scale_color_manual('', values=setNames(car_colors_signaling, car_labels)) +
    scale_linetype_manual('', values=setNames(car_linetypes, car_labels)) +
    scale_x_continuous(breaks=c(0,8,24,48), limits=c(0,48)) +
    theme(axis.text.x = element_text(hjust = .5), 
      legend.title.align=0.5, 
      plot.title = element_text(hjust = 0.5)) +
    geom_hline(aes(yintercept=0), color='black', linetype=3) +
    labs(x='Hours of Stimulation', y='Rel. Reporter Activity vs Untransduced') +
    theme_minimal() +
    theme(
        panel.border = element_rect(fill=NA),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank())

supp_S4_all_reporters <- plots$combined_sig_plot_nomut

plots$combined_sig_plot_nomut_pos <- ggplot(plot.signaling.dt[
        !(CAR %in% c('Baffr mut','Unt','none')) & stim_lab == 'CD19+'], 
      aes(x=Hours, y=combo_mcherry_pct_v_unt/100, color=car_lab, linetype=car_lab)) + 
    facet_wrap(~line_lab, scales='free', drop=T) +
    geom_line() + 
    geom_point() +
    theme_minimal() +
    scale_color_manual('', values=setNames(car_colors_signaling, car_labels)) +
    scale_linetype_manual('', values=setNames(car_linetypes, car_labels)) +
    scale_x_continuous(breaks=c(0,8,24,48), limits=c(0,48)) +
    theme(axis.text.x = element_text(hjust = .5), 
      legend.title.align=0.5, 
      plot.title = element_text(hjust = 0.5)) +
    geom_hline(aes(yintercept=0), color='black', linetype=3) +
    scale_y_continuous(labels=label_percent(accuracy=1)) +
    labs(x='Hours of Stimulation', y='Î” % Reporter Activity vs Untransduced') +
    theme(
        panel.border = element_rect(fill=NA),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank())

plots$combined_sig_plot_v_none <- ggplot(plot.signaling.dt[, 
  mcherry_percent_v_none := (
    combo_mcherry_percent[Stimulation == '+'] -
    combo_mcherry_percent[Stimulation == 'none']), 
  by=c('CAR','Hours','Line')][Stimulation == '+' & !is.na(line_lab)], 
      aes(x=Hours, y=mcherry_percent_v_none/100, color=car_lab, linetype=car_lab)) + 
    facet_grid(line_lab ~ stim_lab, scales='free', drop=T) +
    geom_line() + 
    geom_point() +
    theme_cowplot() +
    scale_color_manual('', values=car_colors_signaling) +
    scale_linetype_manual('', values=car_linetypes) +
    scale_x_continuous(breaks=c(0,8,24,48), limits=c(0,48)) +
    scale_y_continuous(label=label_percent()) +
    theme(axis.text.x = element_text(hjust = .5), 
      legend.title.align=0.5, 
      plot.title = element_text(hjust = 0.5)) +
    labs(x='Hours of Stimulation', y='Rel. Reporter Activity vs Untransduced') +
    theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank())

plots$combined_sig_plot_nomut
plots$combined_sig_plot_nomut_pos
```

## Fig 4 Compile

```{r}

#https://stackoverflow.com/questions/48000292/center-align-legend-title-and-legend-keys-in-ggplot2-for-long-legend-titles
align_legend <- function(p, hjust = 0.5)
{
  # extract legend
  g <- cowplot::plot_to_gtable(p)
  grobs <- g$grobs
  legend_index <- which(sapply(grobs, function(x) x$name) == "guide-box")
  legend <- grobs[[legend_index]]

  # extract guides table
  guides_index <- which(sapply(legend$grobs, function(x) x$name) == "layout")

  # there can be multiple guides within one legend box  
  for (gi in guides_index) {
    guides <- legend$grobs[[gi]]

    # add extra column for spacing
    # guides$width[5] is the extra spacing from the end of the legend text
    # to the end of the legend title. If we instead distribute it by `hjust:(1-hjust)` on
    # both sides, we get an aligned legend
    spacing <- guides$width[5]
    guides <- gtable::gtable_add_cols(guides, hjust*spacing, 1)
    guides$widths[6] <- (1-hjust)*spacing
    title_index <- guides$layout$name == "title"
    guides$layout$l[title_index] <- 2

    # reconstruct guides and write back
    legend$grobs[[gi]] <- guides
  }

  # reconstruct legend and write back
  g$grobs[[legend_index]] <- legend
  g
}

fig4_compiled_v1 <- plot_grid(
  #top
  plot_grid(
    #A
    plot_grid(
      NULL,
      in_vitro_killing, 
      ncol=1,
      rel_heights=c(0.3, 0.7)),
    #B
    plot_grid(
      NULL,
      cytokines,
      ncol=1, 
      rel_heights=c(0.3,0.7)
    ),
  ncol=2, rel_widths=c(0.6,0.4), labels=c('A','B')),
  in_vivo_tumor_growth,
  ncol=1, rel_heights=c(0.65,0.35))


fig4_compiled_v2<- plot_grid(
  #left
  plot_grid(
    NULL,
    cytokines_d1_d10,
    in_vivo_tumor_growth,
    ncol=1, 
    labels=c('A','B',''),
    rel_heights=c(1,3,6)),
  #right
  plot_grid(
    NULL,
    in_vitro_killing,
    plots$combined_sig_plot_nomut_pos,
    ncol=1,
    labels=c('C','D','I'),
    rel_heights=c(1,6.5,2.5)),
  ncol=2, rel_widths=c(0.3,0.7), labels=c('',''))

in_vivo_tumor_growth_v3 <- plot_grid(
    NULL,
    tumor_a,
    tumor_b,
    rel_heights=c(0.2, 0.5, 0.5),
    labels=c('D','E','F'), ncol=1, align='v',axis='tb')

legend <- get_legend(
    # create some space to the left of the legend
    plots$cd8_gene_heatmap[[1]] + theme(
      legend.box.margin = margin(0, 0, 0, 12),
      legend.justification=c(1,1), legend.position=c(1,1),
      legend.key.width=unit(0.4, 'lines')))

fig4_compiled_v3<- plot_grid(
  #top
  plot_grid(
    # top left
    plot_grid(
      plot_grid(
        NULL,
        get_legend(plot_killing_cd8_log+guides(col = guide_legend(nrow = 4))),
        NULL, 
        ncol=3, rel_widths=c(0.1,0.3, 0.6)),
      in_vitro_killing,
      ncol=1,
      rel_heights=c(1,5),
      labels=c('A','B')
    ),
    in_vivo_tumor_growth_v3,
    ncol=2,
    rel_widths=c(0.65,0.35)
  ),
  #bottom
  plot_grid(
    plot_grid(
      NULL,
      align_legend(cytokines_d1_d10 + 
        theme(
          legend.position='right',
          legend.title = element_text(size=rel(0.9)),
          legend.title.align=0.5)),
      ncol=1,
      rel_heights=c(1,5)
    ),
    plots$combined_sig_plot_nomut_pos + 
      theme(
        legend.position='none',
        plot.title=element_text(size=12, hjust = 0),
        plot.margin=margin(25,5,10,10, unit='pt')) +
      labs(title='Jurkat Signaling Reporter Assay'),
    ncol=2, rel_widths=c(0.4,0.6), labels=c('F','G')
  ),
  ncol=1, rel_heights=c(0.65,0.35)
)

fig4_compiled_v4<- plot_grid(
  #cytokines horiz
  cytokines_d1_d10_horiz +
    theme(
      panel.spacing.x=unit(1,'lines'),
      plot.margin=margin(5,15,5,10, unit='pt')
    ),
  #killing
  plot_grid(
    # top left
    plot_grid(
      plot_grid(
        NULL,
        get_legend(plot_killing_cd8_log+guides(col = guide_legend(nrow = 4))),
        NULL, 
        ncol=3, rel_widths=c(0.1,0.3, 0.6)),
      in_vitro_killing,
      ncol=1,
      rel_heights=c(1,5),
      labels=c('B','C')
    ),
    in_vivo_tumor_growth_v3,
    NULL,
    ncol=3,
    rel_widths=c(0.65,0.35,0.05)
  ),
  # reporters
  plots$combined_sig_plot_nomut_pos + 
    theme(
      legend.position='none',
      plot.title=element_text(size=12, hjust = 0),
      panel.spacing.x=unit(2,'lines'),
      plot.margin=margin(5,35,10,15, unit='pt')) +
    labs(title='Jurkat Signaling Reporter Assay'),
  nrow=3, rel_heights=c(0.18,0.6,0.25), labels=c('A','','G'))

fig4_compiled_v5 <- plot_grid(
  
  #top row legend
  plot_grid(
    NULL,
    get_legend(plot_killing_cd8_log+guides(col = guide_legend(nrow = 4))), 
    ncol=2, rel_widths=c(0.5,0.5), labels=c('A','B')),
  
  #2nd row cytokines
  cytokines_d1_d10_horiz +
    theme(
      panel.spacing.x=unit(1,'lines'),
      plot.margin=margin(5,15,5,10, unit='pt')),
  
  #3rd row in vitro killing
  in_vitro_killing,
  
  #4th row significance and reporters
  plot_grid(
    endpoint_killing_stat_plot,
    plots$combined_sig_plot_nomut + 
      theme(
        legend.position='none',
        plot.title=element_text(size=12, hjust = 0),
        panel.spacing.x=unit(2,'lines'),
        plot.margin=margin(5,35,10,15, unit='pt')) +
      labs(title='Jurkat Signaling Reporter Assay'),
    ncol=2, rel_widths=c(1.5,2.5), labels=c('F','G')),
  
  nrow=4, rel_heights=c(.12,.18,.4,.3), labels=c('','C','',''))

ggsave(here::here('..','figs','compiled','fig4.newdraft.pdf'), fig4_compiled_v5, height=12, width=11, useDingbats=FALSE)


```

## Supp Fig ALPPL2 vs CD19 killing 

```{r}


growth_dt <- fread("~/s3-roybal-tcsl/lenti_screen_compiled_data/data/invivo/tcsl164_growth_r.csv")
growth_dt[, length_1 := as.numeric(length_1)]
growth_dt <- growth_dt[car != '']
growth_dt[, c('V7','V8') := NULL]

growth_dt <- rbindlist(
  list(
    growth_dt,
    growth_dt[, list(day=0, width_1=0, length_1=0), by=c('cage','mouse','car')]),
    fill=T)

growth_dt[, car := mapvalues(
  factor(car),
  from=levels(factor(car)), 
  to=c('41BB-CD19','41BB-ALPPL2','CD28-KO','CD28-Lenti','NT','Unt'))]

growth_dt[, vol_lww := length_1 * width_1^2 * 0.5]
growth_dt[, vol_lwl := length_1^2 * width_1 * 0.5]
growth_dt[, vol_lwlw := length_1 * width_1 * (length_1+width_1)/2 * 0.5]

ggplot(growth_dt,
  aes(x=day, y=as.numeric(length_1)*as.numeric(width_1)^2*0.5, color=car, group=interaction(car,cage,mouse))) + 
  geom_line() +
  facet_wrap(~car)

supp_invivo_burden <- ggplot(growth_dt[day < 45 & car != 'NT'],
    aes(
      x=day,
      y=vol_lwl,
      color=factor(car,levels=c(car_order,'Unt')),
      group=interaction(car,cage,mouse))) +
  geom_line() +
  facet_wrap(~car) +
  scale_color_manual(values=c(car_colors, 'Unt'='grey50')) +
  theme_minimal() + theme(legend.position = 'NT') +
  geom_vline(xintercept=-Inf) +
  geom_hline(yintercept=-Inf)

growth_dt_alppl_means <- growth_dt[, list(
  vol_lww = mean(vol_lww, na.rm=T),
  vol_lww_se = sd(vol_lww, na.rm=T)/sqrt(.N),
  vol_lwl = mean(vol_lwl, na.rm=T),
  vol_lwl_se = sd(vol_lwl, na.rm=T)/sqrt(.N),
  vol_lwlw = mean(vol_lwlw, na.rm=T),
  vol_lwlw_se = sd(vol_lwlw, na.rm=T)/sqrt(.N)),
  by=c('car','day')]

left_group <- c('NT','Unt','41BB-CD19','41BB-ALPPL2')
right_group <- c('NT','Unt','CD28-KO','CD28-Lenti')
car_linetypes <- 1+(levels(growth_dt_alppl_means[,car])=='NT')*1
names(car_linetypes) <- levels(growth_dt_alppl_means[,car])

plot_theme <- theme(
      legend.position = c(.05, .95),
      legend.justification = c("left", "top"),
      legend.box.just = "right",
      legend.box.background = element_rect(fill='white'),
      legend.title=element_blank(),
      legend.spacing.y = unit(2, 'pt'),
      legend.margin = margin(2, 3, 3, 3),
      legend.key.height=unit(15,'pt'),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.border = element_rect(fill=NA))


tumor_alppl2 <- ggplot(growth_dt_alppl_means[day <=30 & car %in% left_group],
        aes(x=day, y=vol_lwl, color=car, linetype=car)) +
      geom_line() + 
      geom_pointrange(aes(ymin=vol_lwl-vol_lwl_se, ymax=vol_lwl+vol_lwl_se), show.legend=F) + 
      scale_linetype_manual("", values=car_linetypes) +
      scale_color_manual("", values=c(
        'Unt'='#666666', 'NT'='#666666', '41BB-CD19'='#6BAED6', '41BB-ALPPL2'='#01578a')) +
      theme_minimal() + 
      plot_theme + 
      labs(y=bquote('Tumor Volume'~(mm^3)), x='')
```

##Supp Fig In vivo Killing

```{r}

all_group <- c('None','Untransduced','41BB','BAFF-R','CD28', 'CD40', 'KLRG1','TACI', 'zeta')
car_linetypes <- 1+(levels(growth_dt_means[,car])=='None')*1
names(car_linetypes) <- levels(growth_dt_means[,car])

plot_theme <- theme(
      legend.position = c(.05, .95),
      legend.justification = c("left", "top"),
      legend.box.just = "right",
      legend.box.background = element_rect(fill='white'),
      legend.title=element_blank(),
      legend.spacing.y = unit(2, 'pt'),
      legend.margin = margin(2, 3, 3, 3),
      legend.key.height=unit(15,'pt'),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.border = element_rect(fill=NA))


supp_all_tumors <- ggplot(
  growth_dt_means[day <=50 & car %in% all_group][car == 'Untransduced', car := 'Unt'],
      aes(x=day, y=vol_lwl, color=car, linetype=car)) +
    geom_line() + 
    geom_pointrange(aes(ymin=vol_lwl-vol_lwl_se, ymax=vol_lwl+vol_lwl_se), show.legend=F) + 
    scale_linetype_manual("", values=rename(car_linetypes, replace = c("Untransduced" = "Unt"))) +
    scale_color_manual("", values=c('Unt'='#666666', 'None'='#666666', car_colors)) +
    theme_minimal() + 
    plot_theme + 
    labs(y=bquote('Tumor Volume'~(mm^3)), x='Days post tumor injection')

supp_all_tumors

```

## Compile S4

```{r}

fig_s4_compiled <- (
  plot_grid(cytokines_all, plots$combined_sig_plot_nomut, nrow=1) /
  ((cd4_all_combined | (tumor_alppl2 / supp_all_tumors)) + 
     plot_layout(widths=c(2, 1)))) + 
  plot_layout(heights=c(1,1.5))

fig_scaling <- 1.4
ggsave(here::here('..','figs','compiled','figS4.pdf'), fig_s4_compiled,
       height=9*fig_scaling, width=8.5*fig_scaling, useDingbats=FALSE)

```

### In Vivo Killing

```{r}
#growth_dt <- fread("~/s3-roybal-tcsl/lenti_screen_compiled_data/data/invivo/tcsl166_growth.csv")
growth_dt <- fread(paste0(s3.data.dir, "/invivo/tcsl166_growth.csv"))
growth_dt[, length_1 := as.numeric(length_1)]
growth_dt[, length_2 := as.numeric(length_2)]
growth_dt <- growth_dt[car != '']

growth_dt <- rbindlist(
  list(
    growth_dt,
    growth_dt[, list(day=0, width_1=0, length_1=0), by=c('cage','mouse','car')]),
    fill=T)

growth_dt[, car := mapvalues(
  factor(car),
  from=levels(factor(car)), 
  to=c('41BB','BAFF-R','CD28','CD40','KLRG1','None','TACI','Untransduced','zeta'))]

growth_dt[, vol_lww := length_1 * width_1^2 * 0.5]
growth_dt[, vol_lwl := length_1^2 * width_1 * 0.5]
growth_dt[, vol_lwlw := length_1 * width_1 * (length_1+width_1)/2 * 0.5]

ggplot(growth_dt,
  aes(x=day, y=as.numeric(length_1)*as.numeric(width_1)^2*0.5, color=car, group=interaction(car,cage,mouse))) + 
  geom_line() +
  facet_wrap(~car)

supp_invivo_burden <- ggplot(growth_dt[day < 45 & car != 'None'],
    aes(
      x=day,
      y=vol_lwl,
      color=factor(car,levels=c(car_order,'Untransduced')),
      group=interaction(car,cage,mouse))) +
  geom_line() +
  facet_wrap(~car) +
  scale_color_manual(values=c(car_colors, 'Untransduced'='grey50')) +
  theme_minimal() + theme(legend.position = 'none') +
  geom_vline(xintercept=-Inf) +
  geom_hline(yintercept=-Inf)

growth_dt_means <- growth_dt[, list(
  vol_lww = mean(vol_lww, na.rm=T),
  vol_lww_se = sd(vol_lww, na.rm=T)/sqrt(.N),
  vol_lwl = mean(vol_lwl, na.rm=T),
  vol_lwl_se = sd(vol_lwl, na.rm=T)/sqrt(.N),
  vol_lwlw = mean(vol_lwlw, na.rm=T),
  vol_lwlw_se = sd(vol_lwlw, na.rm=T)/sqrt(.N)),
  by=c('car','day')]

all_cars <- ggplot(growth_dt_means[day <=45],
  aes(x=day, y=vol_lwl, color=car, linetype=car)) +
  geom_line(legend=F) + geom_point(show.legend=F) +
  geom_pointrange(aes(ymin=vol_lwl-vol_lwl_se, ymax=vol_lwl+vol_lwl_se), show.legend=F) + 
  scale_linetype_manual("", values=1+(levels(growth_dt_means[,car])=='None')*1) +
  scale_color_manual("", values=c('Untransduced'='#666666', 'None'='#666666', car_colors)) +
  labs(color="g", linetype="g") + theme_minimal()

left_group <- c('None','Untransduced','41BB','BAFF-R','CD28','TACI')
right_group <- c('None','Untransduced','KLRG1','zeta')
car_linetypes <- 1+(levels(growth_dt_means[,car])=='None')*1
names(car_linetypes) <- levels(growth_dt_means[,car])

plot_theme <- theme(
      legend.position = c(.05, .95),
      legend.justification = c("left", "top"),
      legend.box.just = "right",
      legend.box.background = element_rect(fill='white'),
      legend.title=element_blank(),
      legend.spacing.y = unit(2, 'pt'),
      legend.margin = margin(2, 3, 3, 3),
      legend.key.height=unit(15,'pt'),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.border = element_rect(fill=NA))


tumor_a <- ggplot(growth_dt_means[day <=50 & car %in% left_group][car == 'Untransduced', car := 'Unt'],
        aes(x=day, y=vol_lwl, color=car, linetype=car)) +
      geom_line() + 
      geom_pointrange(aes(ymin=vol_lwl-vol_lwl_se, ymax=vol_lwl+vol_lwl_se), show.legend=F) + 
      scale_linetype_manual("", values=rename(car_linetypes, replace = c("Untransduced" = "Unt"))) +
      scale_color_manual("", values=c('Unt'='#666666', 'None'='#666666', car_colors)) +
      theme_minimal() + 
      plot_theme + 
      labs(y=bquote('Tumor Volume'~(mm^3)), x='')

tumor_b <- ggplot(growth_dt_means[day <=50 & car %in% right_group][car == 'Untransduced', car := 'Unt'],
        aes(x=day, y=vol_lwl, color=car, linetype=car)) +
      geom_line() + 
      geom_pointrange(aes(ymin=vol_lwl-vol_lwl_se, ymax=vol_lwl+vol_lwl_se), show.legend=F) + 
      scale_linetype_manual("", values=rename(car_linetypes, replace = c("Untransduced" = "Unt"))) +
      scale_color_manual("", values=c('Unt'='#666666', 'None'='#666666', car_colors)) +
      theme_minimal() + 
      plot_theme + 
      theme(plot.margin=margin(3,3,3,20)) +
      labs(y=bquote('Tumor Volume'~(mm^3)), x='Days post tumor injection')

in_vivo_tumor_growth <- plot_grid(
    NULL,
    tumor_a,
    tumor_b,
    rel_heights=c(0.2, 0.5, 0.5),
    labels=c('F','G','H'), ncol=1, align='v',axis='tb')

in_vivo_tumor_growth

## STATS (after discussion with CSA, 5/12/21)

# first car is baseline, others are compared to it
cars_stats <- c('zeta', 'KLRG1')

summary(
  lm(
    data=growth_dt[car %in% cars_stats][, car :=factor(car, levels= cars_stats)],
    formula=vol_lwl ~ day + car))

```