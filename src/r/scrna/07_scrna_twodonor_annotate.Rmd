---
title: "Two Donor scRNAseq"
output:
  html_document:
    df_print: paged
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = here::here('..','html'))})
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(tidyr)
library(Seurat)
library(patchwork)
library(cluster)
library(parallelDist)
library(ggplot2)
library(data.table)
library(cowplot)
library(future)
library(SeuratDisk)
library(BiocParallel)

reload_data=F
source(here::here('r','fig_colors.R'))
source(here::here('r','scrna','HTOdemux.R'))
source(here::here('r','scrna','scrna_analysis_fxns.R'))

options(future.globals.maxSize = 14000 * 1024^2)
plan("sequential")
plan()
```

## CD8 ACT Loading

```{r}
## CD8 ACT

#load combined integrated if not already loaded
if (!('combined.integrated.data' %in% ls())) {
  combined.integrated.data <- readRDS(here::here(
    '..','..','scrnaseq_tcsl154',
    'rds','combined.integrated.umap.data.rds'))
}

scrna_cd8 <- LoadH5Seurat(here::here(
  '..','..','scrnaseq_tcsl154',
  'rds',
  paste0('scrna.wnn.int.CD8.act_clust.clean.h5Seurat')))

combined.integrated.data <- readRDS(here::here(
  '..','..','scrnaseq_tcsl154',
  'rds','combined.integrated.umap.data.rds'))

int_cd8_subset <- subset(combined.integrated.data,
    cells=intersect(
      names(scrna_cd8$cell), 
      names(combined.integrated.data$cell)))

scrna_cd8[['RNA']] <- int_cd8_subset@assays$RNA
scrna_cd8[['ADT']] <- int_cd8_subset@assays$ADT

cd8_metadata <- data.table(
  scrna_cd8@meta.data, keep.rownames=T)[,
    list(rn_orig=rn, sample, donor, orig_t_type=t_type)][
      donor == 'TCSL154', rn := gsub('(.*)-\\d_\\d','\\1',rn_orig)]

scrna.wnn.cd4_all_metadata <- readRDS("~/scrnaseq_tcsl154/rds/scrna.wnn.cd4_all_metadata.rds")
scrna.wnn.cd8_all_metadata <- readRDS("~/scrnaseq_tcsl154/rds/scrna.wnn.cd8_all_metadata.rds")

original_metadata <- rbind(
    data.table(scrna.wnn.cd4_all_metadata, keep.rownames=T)[, list(rn_154=rn, sample, t_type, Subtype)],
    data.table(scrna.wnn.cd8_all_metadata, keep.rownames=T)[, list(rn_154=rn, sample, t_type, Subtype)])[,
      rn := gsub('(.*)-\\d','\\1',rn_154)]

sample_subtype_map <- merge(cd8_metadata, original_metadata, by='rn', all=T)[!is.na(Subtype) & !is.na(rn_orig)]
scrna_cd8@meta.data[,'subtype_154'] <- factor(NA, levels=levels(sample_subtype_map$Subtype))
scrna_cd8@meta.data[sample_subtype_map$rn_orig,]$subtype_154 <- sample_subtype_map$Subtype

#CD8 act annotated clusters
cd8_act_cluster_annotations <- fread(text="
seurat_clusters   Activation    Subtype
0         ACT         STIM-GLYC
1         ACT         STIM-GNLY
2         ACT         STIM-OXPHOS
3         ACT         STIM-OXPHOS
4         ACT         STIM-IFNG
5         INACT       INACT
6         INACT       INACT
7         ACT         STIM-GLYC
8         INACT       INACT
9         INACT       INACT
10        ACT         STIM-OXPHOS
11        ACT         STIM-IFNG
12        INACT       INACT
13        ACT         STIM-OXPHOS
14        ACT         STIM-OXPHOS
")

cd8_act_cluster_annotations[, seurat_clusters := factor(seurat_clusters)]
addtl_metadata <- cd8_act_cluster_annotations[data.table(scrna_cd8@meta.data),
  on=c('seurat_clusters')]

scrna_cd8@meta.data$Activation <- addtl_metadata$Activation
scrna_cd8@meta.data$Subtype <- addtl_metadata$Subtype
scrna_cd8@meta.data$Subtype <- factor(scrna_cd8@meta.data$Subtype)
```

### CD8 ALL Loading

```{r}
scrna_cd8_all <- LoadH5Seurat(here::here(
  '..','..','scrnaseq_tcsl154',
  'rds',
  paste0('scrna.wnn.int.CD8.all.clean.h5Seurat')))

cd8_all_metadata <- data.table(
  scrna_cd8_all@meta.data, keep.rownames=T)[,
    list(rn_orig=rn, sample, donor, orig_t_type=t_type)][
      donor == 'TCSL154', rn := gsub('(.*)-\\d_\\d','\\1',rn_orig)]

sample_subtype_map <- merge(cd8_all_metadata, original_metadata, by='rn', all=T)[!is.na(Subtype) & !is.na(rn_orig)]

scrna_cd8_all@meta.data[,'subtype_154'] <- factor(NA, levels=levels(sample_subtype_map$Subtype))
scrna_cd8_all@meta.data[sample_subtype_map$rn_orig,]$subtype_154 <- sample_subtype_map$Subtype

scrna_cd8_all <- map_clusters(scrna_cd8, scrna_cd8_all, 'Subtype', 'Subtype')
scrna_cd8_all <- map_clusters(scrna_cd8, scrna_cd8_all, 'Activation', 'Activation')
scrna_cd8_all <- map_clusters(scrna_cd8, scrna_cd8_all, 'seurat_clusters', 'cd8_act_clust')

int_cd8_all_subset <- subset(combined.integrated.data,
    cells=intersect(
      names(scrna_cd8_all$cell), 
      names(combined.integrated.data$cell)))

scrna_cd8_all[['RNA']] <- int_cd8_all_subset@assays$RNA
scrna_cd8_all[['ADT']] <- int_cd8_all_subset@assays$ADT
rm(int_cd8_all_subset)

#CD8 all annotated cluters
cd8_all_cluster_annotations <- fread(text="
seurat_clusters Subtype Activation
0   NAIVE-CD62L   INACT
1   STIM-OXPHOS  ACT
2   NAIVE-CD7   INACT
3   STIM-GLYC    ACT
4   NAIVE-CD7   INACT
5   MEM-CD29    INACT
6   STIM-GNLY    ACT
7   MEM-CD29    ACT
8   NAIVE-CD7   INACT
9   STIM-UNTR    ACT
10  STIM-INACT    INACT
11  STIM-INACT    INACT
12  MEM-CD29    INACT
13  NAIVE-CD62L   INACT
14  MEM-CD29   INACT
15  MEM-CD29   INACT
16  REMOVE  REMOVE
17  STIM-UNTR    INACT
18  NAIVE-CD7   INACT
19  MEM-CD29    INACT
20  NAIVE-CD62L   INACT
21  NAIVE-CD62L   INACT
22  MEM-CD29    INACT
23  NAIVE-CD7  INACT
24  MEM-CD29    INACT
25  REMOVE  REMOVE
27  REMOVE  REMOVE
28  MEM-CD29    INACT
29  REMOVE  REMOVE
30  REMOVE  REMOVE
31  REMOVE  REMOVE
")

cd8_all_cluster_annotations[, seurat_clusters := factor(seurat_clusters)]

addtl_metadata <- cd8_all_cluster_annotations[
  data.table(scrna_cd8_all@meta.data), on=c('seurat_clusters')]

setnames(addtl_metadata,
  c('i.Activation','Activation','i.Subtype','Subtype'),
  c('Activation.act','Activation.inact','Subtype.act','Subtype.inact'))

# save inact subtypes and activation status to start
addtl_metadata[, Subtype := Subtype.inact]
addtl_metadata[, Activation := Activation.inact]

# if old subtype is missing or old subtype is 'INACT', then use new subtype
addtl_metadata[!is.na(Subtype.act) | Subtype.act != 'INACT',
  Subtype := Subtype.act]
addtl_metadata[!is.na(Subtype.act) | Subtype.act != 'INACT',
  Activation := Activation.act]
addtl_metadata[Subtype.act == 'INACT',
  Subtype := Subtype.inact]


scrna_cd8_all@meta.data$Activation <- as.character(addtl_metadata$Activation)
scrna_cd8_all@meta.data$Subtype <- as.character(addtl_metadata$Subtype)


cd8_all.h5.file <- here::here(
  '..','..','scrnaseq_tcsl154',
  'rds','scrna.wnn.int.cd8.all.annotated.h5Seurat')
SaveH5Seurat(scrna_cd8_all, cd8_all.h5.file, overwrite=T)
```


### CD4 ACT Loading

```{r}

scrna_cd4 <- LoadH5Seurat(here::here(
  '..','..','scrnaseq_tcsl154',
  'rds',
  paste0('scrna.wnn.int.CD4.act_clust.clean.h5Seurat')))

cd4_metadata <- data.table(
  scrna_cd4@meta.data, keep.rownames=T)[,
    list(rn_orig=rn, sample, donor, orig_t_type=t_type)][
      donor == 'TCSL154', rn := gsub('(.*)-\\d_\\d','\\1',rn_orig)]

original_metadata <- rbind(
    data.table(scrna.wnn.cd4_all_metadata, keep.rownames=T)[, list(rn_154=rn, sample, t_type, Subtype)],
    data.table(scrna.wnn.cd8_all_metadata, keep.rownames=T)[, list(rn_154=rn, sample, t_type, Subtype)])[,
      rn := gsub('(.*)-\\d','\\1',rn_154)]

sample_subtype_map <- merge(cd4_metadata, original_metadata, by='rn', all=T)[!is.na(Subtype) & !is.na(rn_orig)]
scrna_cd4@meta.data[,'subtype_154'] <- factor(NA, levels=levels(sample_subtype_map$Subtype))
scrna_cd4@meta.data[sample_subtype_map$rn_orig,]$subtype_154 <- sample_subtype_map$Subtype

int_cd4_subset <- subset(combined.integrated.data,
    cells=intersect(
      names(scrna_cd4$cell), 
      names(combined.integrated.data$cell)))

scrna_cd4[['RNA']] <- int_cd4_subset@assays$RNA
scrna_cd4[['ADT']] <- int_cd4_subset@assays$ADT

rm(int_cd4_subset)
```


### CD4 ALL Loading

```{r}
scrna_cd4_all <- LoadH5Seurat(here::here(
  '..','..','scrnaseq_tcsl154',
  'rds',
  paste0('scrna.wnn.int.CD4.clean.h5Seurat')))

cd4_all_metadata <- data.table(
  scrna_cd4_all@meta.data, keep.rownames=T)[,
    list(rn_orig=rn, sample, donor, orig_t_type=t_type)][
      donor == 'TCSL154', rn := gsub('(.*)-\\d_\\d','\\1',rn_orig)]

original_metadata <- rbind(
    data.table(scrna.wnn.cd4_all_metadata, keep.rownames=T)[, list(rn_154=rn, sample, t_type, Subtype, act_clusters)],
    data.table(scrna.wnn.cd8_all_metadata, keep.rownames=T)[, list(rn_154=rn, sample, t_type, Subtype, act_clusters)])[,
      rn := gsub('(.*)-\\d','\\1',rn_154)]

sample_subtype_map <- merge(cd4_all_metadata, original_metadata, by='rn', all=T)[!is.na(Subtype) & !is.na(rn_orig)]

scrna_cd4_all@meta.data[,'subtype_154'] <- factor(NA, levels=levels(sample_subtype_map$Subtype))
scrna_cd4_all@meta.data[,'act_clust_154'] <- factor(NA, levels=levels(sample_subtype_map$act_clusters))
scrna_cd4_all@meta.data[sample_subtype_map$rn_orig,]$subtype_154 <- sample_subtype_map$Subtype
scrna_cd4_all@meta.data[sample_subtype_map$rn_orig,]$act_clust_154 <- sample_subtype_map$act_clusters

int_cd4_all_subset <- subset(combined.integrated.data,
    cells=intersect(
      names(scrna_cd4_all$cell), 
      names(combined.integrated.data$cell)))

scrna_cd4_all[['RNA']] <- int_cd4_all_subset@assays$RNA
scrna_cd4_all[['ADT']] <- int_cd4_all_subset@assays$ADT

rm(int_cd4_all_subset)

#CD4 all annotated clusters
cd4_all_cluster_annotations <- fread(text="
seurat_clusters Subtype Activation
0   NAIVE-CD62L  INACT
1   NAIVE-CD62L  INACT
2   STAT1-IRF1  MIXED
3   STIM-OXPHOS ACT
4   MEM-CD29   INACT
5   STIM-GLYC   ACT
6   NAIVE-CD62L  INACT
7   STIM-IFNG   ACT
8   STIM-OXPHOS ACT
9   MEM-CD29   INACT
10  STAT1-IRF1  MIXED
11  NAIVE-CD62L  INACT
12  MEM-CD29    INACT
13  STIM-OXPHOS ACT
14  MEM-CD29   INACT
15  STAT1-IRF1  MIXED
16  STAT1-IRF1  MIXED
17  STAT1-IRF1  MIXED
18  MEM-CD29    INACT
19  TH2 MIXED
20  MEM-CD29    INACT
21  MEM-CD29    INACT
22  STIM-IFNG   ACT
23  REMOVE  REMOVE
24  REMOVE  REMOVE
25  STIM-UNTR   INACT
26  MEM-CD29    INACT
27  REMOVE  REMOVE
28  REMOVE  REMOVE
29  REMOVE  REMOVE
30  MEM-CD29    INACT
")

cd4_all_cluster_annotations[, seurat_clusters := factor(seurat_clusters)]

addtl_metadata <- cd4_all_cluster_annotations[
  data.table(scrna_cd4_all@meta.data), on=c('seurat_clusters')]

scrna_cd4_all@meta.data$Activation <- as.character(addtl_metadata$Activation)
scrna_cd4_all@meta.data$Subtype <- as.character(addtl_metadata$Subtype)

cd4_all.h5.file <- here::here(
  '..','..','scrnaseq_tcsl154',
  'rds','scrna.wnn.int.cd4.all.annotated.h5Seurat')
SaveH5Seurat(scrna_cd4_all, cd4_all.h5.file, overwrite=T)
```

### All T-Cells Loading

```{r}
scrna_all <- LoadH5Seurat(here::here(
  '..','..','scrnaseq_tcsl154',
  'rds',
  paste0('scrna.wnn.int.all.clean.h5Seurat')))

scrna_all <- map_clusters(scrna_cd8_all, scrna_all, 'Subtype', 'Subtype')
scrna_all <- map_clusters(scrna_cd8_all, scrna_all, 'Activation', 'Activation')
scrna_all <- map_clusters(scrna_cd8_all, scrna_all, 'seurat_clusters', 'cd8_all_clust')
scrna_all <- map_clusters(scrna_cd4_all, scrna_all, 'Subtype', 'Subtype')
scrna_all <- map_clusters(scrna_cd4_all, scrna_all, 'Activation', 'Activation')
scrna_all <- map_clusters(scrna_cd4_all, scrna_all, 'seurat_clusters', 'cd4_all_clust')

int_all_subset <- subset(combined.integrated.data,
    cells=intersect(
      names(scrna_all$cell), 
      names(combined.integrated.data$cell)))

scrna_all[['RNA']] <- int_all_subset@assays$RNA
scrna_all[['ADT']] <- int_all_subset@assays$ADT

rm(combined.integrated.data)
rm(int_all_subset)

all.h5.file <- here::here(
  '..','..','scrnaseq_tcsl154',
  'rds','scrna.wnn.int.all.annotated.h5Seurat')
SaveH5Seurat(scrna_all, all.h5.file, overwrite=T)
```

### GSEA subsets

```{r}
gsea_subsets <- c(
  "HALLMARK_PI3K_AKT_MTOR_SIGNALING",
  "KEGG_MTOR_SIGNALING_PATHWAY",
  "HALLMARK_MTORC1_SIGNALING",
  "GILMORE_CORE_NFKB_PATHWAY",
  "HALLMARK_GLYCOLYSIS",
  "HALLMARK_OXIDATIVE_PHOSPHORYLATION",
  "HALLMARK_IL6_JAK_STAT3_SIGNALING",
  "HALLMARK_MYC_TARGETS_V2",
  "GSE23321_CD8_STEM_CELL_MEMORY_VS_CENTRAL_MEMORY_CD8_TCELL_DN",
  "GSE23321_CD8_STEM_CELL_MEMORY_VS_CENTRAL_MEMORY_CD8_TCELL_UP",
  "GSE23321_CENTRAL_MEMORY_VS_NAIVE_CD8_TCELL_DN",
  "GSE23321_CENTRAL_MEMORY_VS_NAIVE_CD8_TCELL_UP",
  "GSE23321_CENTRAL_VS_EFFECTOR_MEMORY_CD8_TCELL_DN",
  "GSE23321_CENTRAL_VS_EFFECTOR_MEMORY_CD8_TCELL_UP",
  "BIOCARTA_CD40_PATHWAY",
  "BIOCARTA_41BB_PATHWAY",
  "BIOCARTA_NFKB_PATHWAY",
  "GO_LYMPHOCYTE_COSTIMULATION",
  "FATTY_ACID_OXIDATION",
  "HALLMARK_HYPOXIA",
  "GO_NEGATIVE_REGULATION_OF_TYPE_I_INTERFERON_PRODUCTION",
  "BIOCARTA_IFNG_PATHWAY",
  "PID_IL12_2PATHWAY",
  "HALLMARK_APOPTOSIS",
  "REACTOME_PD_1_SIGNALING",
  "HALLMARK_INTERFERON_GAMMA_RESPONSE",
  "KEGG_CELL_ADHESION_MOLECULES_CAMS",
  "REACTOME_INTERFERON_GAMMA_SIGNALING",
  "HALLMARK_IL2_STAT5_SIGNALING",
  "BIOCARTA_41BB_PATHWAY",
  "PID_CD40_PATHWAY",
  "PID_NFAT_TFPATHWAY",
  "GOBP_ACTIVATION_INDUCED_CELL_DEATH_OF_T_CELLS",
  "PID_IL2_PI3K_PATHWAY",
  "REACTOME_FASL_CD95L_SIGNALING",
  "PID_FAS_PATHWAY",
  "WP_TNF_ALPHA_SIGNALING_PATHWAY",
  "BIOCARTA_IFNA_PATHWAY")

scrna_cd8 <- map_geneset(scrna_cd8_all, gsea_subsets)
scrna_all <- map_geneset(scrna_all, gsea_subsets)

### Paper gene modules

Sheih_et_al_IRF <- c('CCL4','CCL5','CD27','CD74','FGFBP2','GNLY','GZMA','GZMB',
  'GZMH','GZMK','HLA-DRA','HLA-DRB1','HLA-DRB5','IFNG','LAG3', 'NKG7','STMN1')

Nicolet_et_al_CD29core <- c('PRSS23', 'FLNA', 'SELPLG', 'YWHAQ', 'ANXA1',
  'CX3CR1, PXN', 'FGFBP2', 'GZMH', 'TOB1', 'CD52', 'LITAF', 'FCGR3A',
  'ITGB1', 'LGALS1', 'HOPX', 'GZMB', 'GNLY', 'PATL2')

scrna_all <- AddModuleScore(scrna_all,
  features=list('1'=Nicolet_et_al_CD29core),name='Nicolet_et_al_CD29core')
scrna_all <- AddModuleScore(scrna_all,
  features=list('1'=Sheih_et_al_IRF),name='Sheih_et_al_IRF')

cd4_rna_subset_markers <- FindAllMarkers(
  scrna_cd4_all[, !(
    scrna_cd4_all[['car']] == c('CD30') |
    scrna_cd4_all[['Subtype']] == c('REMOVE') |
    scrna_cd4_all[['k_type']] == c('bead_stim'))],
  assay='SCT_INT')
```

```{r}

umap_dt <- data.table(cbind(scrna_all@meta.data, scrna_all@reductions$wnn.umap@cell.embeddings))

umap_dt <- umap_dt[Subtype != 'REMOVE' & !is.na(Subtype) & car != 'K_only']

labels_dt <- umap_dt[, 
  list(wnnUMAP_1=mean(wnnUMAP_1), wnnUMAP_2=mean(wnnUMAP_2)),
  by=c('Subtype','t_type')]

plots$subtypes<- ggplot(umap_dt, aes(x=wnnUMAP_1, y=wnnUMAP_2, color=Subtype)) +
  geom_point(size=0.3) + 
  coord_fixed() +
  geom_label_repel(
    data=labels_dt,
    aes(x=wnnUMAP_1, y=wnnUMAP_2, label=Subtype),
    fill= alpha(c("white"),0.9), force=0.5) + 
  scale_color_manual(values=all_colors) +
  theme_minimal() + 
  theme(
    axis.text=element_blank(),
    axis.line = element_blank(),
    axis.title=element_blank(),
    panel.grid=element_blank())

inset_umap_point_size = 0.05

# per car
plots$per_car <- ggplot() +
  geom_point(aes(x=wnnUMAP_1, y=wnnUMAP_2), 
    data=umap_dt[,list(wnnUMAP_1, wnnUMAP_2)], size=0.1, color='grey80') +
  geom_point(aes(x=wnnUMAP_1, y=wnnUMAP_2, color=k_type), data=umap_dt, size=0.2) + 
  facet_grid(k_type~car) +
  coord_fixed() + 
  theme_minimal() + 
  theme(
    axis.text=element_blank(),
    axis.line = element_blank(),
    axis.title=element_blank(),
    panel.grid=element_blank())

#per phase
plots$per_phase <- ggplot(
    umap_dt[order(Phase)], aes(x=wnnUMAP_1, y=wnnUMAP_2, color=Phase)) +
  geom_point(size=inset_umap_point_size, alpha=0.75) + 
  coord_fixed() +
  scale_color_manual(values=phase_colors) +
  theme_minimal() + 
  guides(color = guide_legend(override.aes = list(size = 5))) +
  theme(
    axis.text=element_blank(),
    axis.line = element_blank(),
    axis.title=element_blank(),
    legend.justification = c(0,1),
    panel.grid=element_blank())

#per donor
plots$per_donor <- ggplot(
    umap_dt[sample(.N)], aes(x=wnnUMAP_1, y=wnnUMAP_2, 
      color=factor(donor, labels=c('A','B')))) +
  geom_point(size=inset_umap_point_size, alpha=0.75) + 
  scale_color_discrete('Donor') +
  coord_fixed() +
  theme_minimal() + 
  guides(color = guide_legend(override.aes = list(size = 5))) +
  theme(
    axis.text=element_blank(),
    axis.line = element_blank(),
    axis.title=element_blank(),
    legend.justification = c(0,1),
    panel.grid=element_blank())

#stimulation
cluster_stim <- unique(data.table(umap_dt)[, list(n_clust_car= .N), 
  by=c(cluster_name, "car", "k_type","t_type")][, 
    pct_clust_car := n_clust_car/sum(n_clust_car), 
    by=.(car, k_type, t_type)][,
      cd19_clust_car_l2fc := log2(
          pct_clust_car[k_type == ifelse(.BY[2] == 'Untransduced', 'bead_stim', 'cd19+')]/
            pct_clust_car[k_type == 'baseline']), 
      by=.(get(cluster_name), car, t_type)][, 
        cd19_clust_act_l2fc := mean(
            cd19_clust_car_l2fc[!(car %in% c('KLRG1','Untransduced')) | k_type == 'bead_stim'], na.rm=T), 
        by=get(cluster_name)][, list(Subtype, t_type, cd19_clust_act_l2fc)])

cluster_stim[is.nan(cd19_clust_act_l2fc), cd19_clust_act_l2fc := 100]

plots$activation <- ggplot(
    umap_dt[cluster_stim, on=c('t_type','Subtype')][sample(.N)], 
    aes(x=wnnUMAP_1, y=wnnUMAP_2, 
      color=cd19_clust_act_l2fc)) +
  geom_point(size=inset_umap_point_size, alpha=0.75) + 
  scale_color_distiller(
    'Stim:Unstim',
    palette='PuOr', direction=-1, oob=scales::squish, limits=c(-5,5),
    breaks=c(-5,-3,0,3,5),
    labels=rev(c('>32x stim','8x stim','1:1','8x unstim','>32x unstim'))) +
  coord_fixed() +
  theme_minimal() + 
  theme(
    axis.text=element_blank(),
    axis.line = element_blank(),
    axis.title=element_blank(),
    panel.grid=element_blank(),
    legend.justification = c(0,1),
    legend.key.width=unit(0.4, 'lines'))

combined_inset_umap <- plot_grid(
  plots$per_phase,
  NULL,
  plots$per_donor,
  NULL,
  plots$activation,
  ncol=1,
  rel_heights=c(1,-0.1,1,-0.1,1))
```

# CAR vs clusters

```{r}

cd4_order <- c(
  'STIM-GLYC',
  'STIM-OXPHOS',
  'STIM-IFNG',
  'STAT1-IRF1',
  'TH2',
  'STIM-UNTR',
  'MEM-CD29',
  'NAIVE-CD62L'
)

cd8_order <- c(
  'STIM-GLYC',
  'STIM-OXPHOS',
  'STIM-IFNG',
  'STIM-GNLY',
  'STIM-INACT',
  'STIM-UNTR',
  'MEM-CD29',
  'NAIVE-CD7',
  'NAIVE-CD62L'
)

car_pct_dotplot(data.table(scrna_cd8_all@meta.data)[
    k_type == 'cd19+' & !is.na(Subtype) & car != 'CD30' & Subtype != 'REMOVE'],
    'cd8_order')

car_pct_dotplot <- function(car_metadata, subtype_order) {
  
  car_clust_pct_act <- data.table(car_metadata)[, .N, 
    by=c('car','Subtype')][, 
      pct_car := N/sum(N), by='car'][,
        clust_count := sum(N), by='Subtype'][,
          log2_clust_enrich := log2(pct_car/mean(pct_car)), by='Subtype']
  
  car_clust_pct_act[, log2_ce_trunc := ifelse(
    test= abs(log2_clust_enrich) > 1, 
    yes= 1 * sign(log2_clust_enrich), 
    no= log2_clust_enrich)]
  
  pct_dotplot <- ggplot(car_clust_pct_act) + 
    geom_point(aes(
      x=factor(Subtype, levels=rev(subtype_order)),
      y=factor(car, c("CD28","4-1BB","BAFF-R","TACI","CD40","TNR8","Zeta","KLRG1","Untransduced")),
      color=log2_ce_trunc, size=pct_car)) + 
    scale_color_distiller('log2\nCAR Enrichment', palette='PRGn', direction=1, 
      breaks=c(-1,-0.5,0,0.5,1), labels=c('< -1','-0.5','0','0.5','> 1')) + 
    scale_size('% CAR Cells', range=c(1,15)) + 
    theme_minimal() + 
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
    coord_flip() +
    labs(y='', x='')
  
  return(pct_dotplot)
}


# cd4 dots
car_clust_pct_act <- data.table(scrna_cd4_all@meta.data)[
  k_type == 'cd19+' & !is.na(Subtype) & car != 'CD30' & Subtype != 'REMOVE', .N, 
  by=c('car','Subtype')][, 
    pct_car := N/sum(N), by='car'][,
      clust_count := sum(N), by='Subtype'][,
        log2_clust_enrich := log2(pct_car/mean(pct_car)), by='Subtype']

car_clust_pct_act[, log2_ce_trunc := ifelse(
  test= abs(log2_clust_enrich) > 1, 
  yes= 1 * sign(log2_clust_enrich), 
  no= log2_clust_enrich)]

plots$cd4_stim_dots <- ggplot(car_clust_pct_act) + 
  geom_point(aes(
    x=factor(Subtype, levels=rev(cd4_order)),
    y=factor(car, c("CD28","4-1BB","BAFF-R","TACI","CD40","TNR8","Zeta","KLRG1","Untransduced")),
    color=log2_ce_trunc, size=pct_car)) + 
  scale_color_distiller('log2\nCAR Enrichment', palette='PRGn', direction=1, 
    breaks=c(-1,-0.5,0,0.5,1), labels=c('< -1','-0.5','0','0.5','> 1')) + 
  scale_size('% CAR Cells', range=c(1,15), breaks=c(0.1,0.2,0.3)) + 
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  coord_flip() +
  labs(y='', x='')

plot_grid(
  plots$cd4_stim_dots+theme(axis.text.x = element_blank()),
  plots$cd8_stim_dots,
  ncol=1,
  rel_heights=c(0.8,1))

```



```{r}
# find_genes_parallel <- function(seurat_obj, ident_name, 'SCT_INT', min.pct=0.25, features=NULL, test.use='wilcox') {
#   
#   idents=unique(seurat_obj[[ident_name]])[[1]]
#   
#   FindMarker.wrapper <- function(x) {
#   
#     message(paste0('Starting FindMarkers for: ',idents[x]))
#     
#     markers_dt <- data.table(
#       FindMarkers(seurat_obj,
#         ident.1=idents[x],
#         only.pos = TRUE, min.pct=min.pct,
#         features=features,
#         assay=assay, test.use=test.use),
#       keep.rownames=T)
#   
#     markers_dt$ident <- idents[x]
#     
#     message(paste0('Completed FindMarkers for: ',idents[x]))
#     
#     return(markers_dt)
#   }
#   gc()
#   subset_markers <- bplapply(
#     1:length(idents),
#     FindMarker.wrapper,BPPARAM=MulticoreParam(12, log=T))
#   
#   subset_markers <- rbindlist(subset_markers)
#   return(subset_markers)
# }
# 
# cd8_rna_mast_markers <- find_genes_parallel(scrna_cd8_all, 'Subtype', assay='RNA', min.pct=0.20, test.use='MAST')
# 
# cd8_rna_mast_markers <- find_genes_parallel(scrna_cd8_all, 'Subtype', assay='RNA', min.pct=0.20, test.use='MAST', features=scrna_cd8_all@assays$SCT_INT@var.features)
# 
# cd4_marker_genes.rds.file <- here::here(
#      '..','..','scrnaseq_tcsl154',
#      'rds',
#      paste0('cd4_marker_genes_.rds'))
# 
# cd8_marker_genes.rds.file <- here::here(
#      '..','..','scrnaseq_tcsl154',
#      'rds',
#      paste0('cd8_marker_genes_all.rds'))
# 
# saveRDS(cd8_rna_mast_markers, cd8_marker_genes.rds.file)
# saveRDS(cd8_rna_subset_markers, cd8_marker_genes.rds.file)
# 
# cd8_cast_markers <- dcast(cd8_rna_subset_markers, rn ~ Subtype, value.var='avg_log2FC', fill=0)
# rownames(cd8_cast_markers) <- cd8_cast_markers$rn
# 
# #cd8_rna_mast_markers <- readRDS(cd8_marker_genes.rds.file)
# 
# Idents(scrna_cd8_all) <- 'Subtype'
# all_genes <- AverageExpression(
#   prune_cells(scrna_cd8_all, rescale=T),
#   assays = 'SCT_INT',
#   features = cd8_rna_mast_markers$rn,
#   return.seurat = FALSE,
#   group.by = "Subtype",
#   add.ident="donor",
#   slot = "scale.data"
# )
# 
# melted_genes <- reshape2::melt(all_genes[[1]])
# melted_genes <- data.table(melted_genes)
# names(melted_genes) <- c('gene','subtype','zscore')
# melted_genes[, donor := gsub('.*_(.*)','\\1', subtype)]
# melted_genes[, subtype := gsub('(.*)_(.*)','\\1', subtype)]
# melted_genes[, subtype := factor(subtype, levels=cd8_order)]
# #melted_genes[, gene := factor(gene, row_dend$labels)]
# melted_genes[, best_subtype := subtype[which.max(zscore)], by=gene]
# melted_genes[, zdiff := zscore[which.max(zscore)] - mean(zscore), by=gene]
# gene_order <- unique(melted_genes[subtype == best_subtype, gene[order(zdiff)]])
# melted_genes[, gene := factor(gene, levels=gene_order)]
# 
# 
# 
# cd8_rna_subset_markers[p_val_adj < 0.05, best_subtype := Subtype[which.max(avg_log2FC)], by=rn]
# ggplot(cd8_rna_subset_markers) + geom_raster(aes(x=Subtype, y=rn, fill=avg_log2FC)) + facet_grid(best_subtype~., scales='free', space='free') + scale_fill_distiller(palette='PuOr', oob=scales::squish, limit=max(abs(melted_genes$zscore)) * c(-1, 1), type='div')
```

```{r}

cd4_genes <- list(
  'STIM-IFNG'= c(
    "GZMA", "GZMH", "CD2", "CD74", "HLA-DRA", "IFNG", "ITGB2",
    "PRF1", "EOMES", "GNLY", "LAG3"),
  'STIM-GLYC'= c(
    "HILPDA", "IL2RA", "BNIP3", "PGK1", "ARG2", "CTLA4", "TNFRSF9", "TNFRSF18"),
  'STIM-OXPHOS'= c(
    "HSPE1", "MT-CO3", "MT-CO2", "HSP90AA1", "FABP5",
    "MKI67", "SRM", "C1QBP", "MT-ND1", "MT-ATP6"),
  'STAT1-IRF1'= c(
    "STAT1", "STMN1", "IFITM1", "IFITM2", "IFITM3", "IRF1", "CALM2", "ID3"),
  'NAIVE-CD62L'= c(
    "SELL", "LRRN3", "SOCS2", "FAM13A"),
  'STIM-UNTR'= c(
    "CCR7", "CD7", "CD69", "CD27", "MAL"),
  'TH2'= c(
    "IL5", "IL13", "GATA3", "IL4"),
  'MEM-CD29'= c(
    "S100A4", "KLRB1", "ITGB1", "ITGA4", "GZMH", "HOPX",
    "NKG7", "NEAT1", "CXCR3", "KLRG1", "CCR5"))

cd8_genes <-list(
  "NAIVE-CD7"= c(
    "IFITM2", "VIM", "STMN1", "HMGN2", "STIM1", "CD7", "IFITM1", "TCF7"),
  "MEM-CD29"= c(
    "EOMES", "ITGA1", "ITGB2", "CXCR3","S100A4", "ANXA1", "KLRG1", "HOPX"),
  "STIM-IFNG"= c(
    "IFNG", "GZMH", "GZMK", "GZMB", "NKG7", "CCR5", "HLA-DQA1", "CD74",
    "CD2","CCL5","CCL3",'CCL4'),
  "STIM-GLYC"= c(
    "ARG2", "BNIP3", "BNIP3L", "LAYN", "HILPDA", "MT2",
    "LDHA", "FAM162A", "JUNB"),
  "STIM-UNTR"= c(
    "S100A10", "CD38", "LAYN", "ENO1", "PGK1", "IGFBP2", "NEAT1", "STAT1", "CD27", "TNFAIP2"),
  "STIM-OXPHOS"= c(
    "HMGA1", "FKBP4", "HSPD1", "HSP90AB1",
    "IL5", "C1QBP", "EIF5A", "HSPH1", "MD-ND3", "SRM",
    "IL2RA"),
  "STIM-INACT"= c(
    "CTSW", "DDX21", "CYP1B1", "BATF3", "GZMA", "TNFSF10", "PFN1"),
  "STIM-GNLY"= c(
    "GNLY", "LAYN", "TNFRSF18", "RUNX3", "CTSW", "CBLB", "LGALS3"),
  "NAIVE-CD62L"= c(
    "SELL", "MAL", "KLF2", "TXNIP", "IL7R", "LRRN3"))

make_gene_heatmap <- function(
    seurat_obj, subtype_order, max_genes=100, label_genes=NULL, 
    rescale=T, use_dendsort=T) {
  
  if (rescale)
    seurat_obj <- ScaleData(seurat_obj, assay='SCT_INT')
  
  all_genes <- AverageExpression(
    seurat_obj,
    assays = 'SCT_INT',
    features = NULL,
    return.seurat = FALSE,
    group.by = "Subtype",
    add.ident="donor",
    slot = "scale.data"
  )

  # melt, clean
  melted_genes <- reshape2::melt(all_genes[[1]])
  melted_genes <- data.table(melted_genes)
  names(melted_genes) <- c('gene','subtype','zscore')
  melted_genes[, donor := gsub('.*_(.*)','\\1', subtype)]
  melted_genes[, subtype := gsub('(.*)_(.*)','\\1', subtype)]
  melted_genes[, subtype := factor(subtype, levels=subtype_order)]
  melted_genes[, best_subtype := subtype[which.max(zscore)], by=gene]
  melted_genes[, zdiff := zscore[which.max(zscore)] - mean(zscore), by=gene]
  gene_order <- unique(melted_genes[subtype == best_subtype, gene[order(zdiff)]])
  melted_genes[, gene := factor(gene, levels=gene_order)]
  melted_genes[, max_score := max(abs(zscore)), by='gene']
  melted_genes[, mean_zscore := mean(zscore), by=c('gene','subtype')]
  
  #reorder
  new_gene_order <- c()
  for (group_i in rev(subtype_order)) {
    if (use_dendsort) {
      cast_group <- dcast(melted_genes[!is.na(subtype) & best_subtype == group_i], 
          gene ~ subtype + donor, value.var='zscore')
      
      group_gene_order <- dendsort(hclust(dist(
        cast_group[,-1])))$order
      group_genes <- as.character(cast_group$gene[group_gene_order])
    } else {
      group_genes <- melted_genes[
        !is.na(subtype) & best_subtype == group_i][
          subtype == best_subtype][order(mean_zscore), unique(as.character(gene))]
    }
    new_gene_order <- c(new_gene_order, group_genes)
  }
  
  melted_genes[, gene := factor(gene, levels=new_gene_order)]
  cast_formula <- "best_subtype ~."
  
  # subset on best genes per cluster
  best_genes <- unique(
    melted_genes[subtype == best_subtype][
      rev(new_gene_order), on='gene'][,
        list(subtype, mean_zscore), by='gene'])[order(-mean_zscore),
          gene[1:max_genes], by='subtype']$V1
  
  label_gene_list <- unique(unlist(label_genes, use.names=F))
  best_genes <- unique(c(best_genes, label_gene_list))
  
  # for annotation
  best_per_subtype <-unique(
    melted_genes[subtype == best_subtype][
      rev(new_gene_order), on='gene'][,
        list(subtype, mean(zscore)), by='gene'])[,
          is_best := gene %in% gene[1:max_genes], by='subtype']
  
  melted_genes[
    gene %in% best_genes &
    subtype == best_subtype &
    donor == donor[1],
      label := ifelse(gene %in% label_gene_list, as.character(gene), NA)]
    
  # alternate none with subtype name (two donors)
  row_names <- as.vector(t(cbind(rep('', length(subtype_order)), subtype_order)))
  unique_donor_subset <- unique(melted_genes[, list(donor, subtype)])
  n_lines <- unique_donor_subset[, length(unique(subtype))]
  
  max_x <- length(levels(melted_genes[gene %in% best_genes, interaction(donor,subtype)]))
  
  display_genes <- melted_genes[gene %in% best_genes]
  
  separator_table <- display_genes[
      subtype == best_subtype & donor == donor[1], list(n_genes= as.double(.N)), by='subtype']
      
  separator_table[rev(subtype_order), on='subtype', pos := cumsum(n_genes)+0.5]
  
  label_table <- display_genes[,
    paste(na.omit(label), collapse=', '), by='subtype'][
      separator_table, on='subtype']
  
  de_gene_heatmap <- ggplot(display_genes) + 
    geom_tile(aes(x=interaction(donor,subtype), y=gene, fill=zscore)) +
    scale_x_discrete(expand=c(0,0)) + 
    scale_y_discrete(expand=c(0,0)) +
    coord_cartesian(clip = 'off') +
    geom_vline(color='white', xintercept=0.5+c(1:n_lines-1)*2) +
    geom_segment(data=separator_table, color='black', linetype=2, 
      y=separator_table$pos, yend=separator_table$pos, x=0.5, xend=max_x+3.25) +
    scale_fill_distiller(palette='PuOr', oob=scales::squish, limit=c(-2, 2), type='div') +
    geom_label(
      data=label_table,
      label.size=0,
      fill=NA,
      nudge_x=0.55,
      size=2.25,
      aes(x=max_x, y=pos-2.5, label=stringr::str_wrap(V1, 22), vjust=1, hjust=0)
    ) +
    theme_minimal() +
    # geom_text_repel(
    #   force        = 0.5,
    #   nudge_x      = 0.15,
    #   hjust        = 0,
    #   segment.size = 0.2,
    #   size=2,
    #   xlim=c(max_x+0.5, max_x+0.5),
    #   aes(x=max_x+0.5, y=gene, label=label)) +
    theme(
      axis.text.x=element_blank(),
      strip.text.y=element_blank(),
      axis.text.y=element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank(),
      plot.margin = unit(c(5.5, 22, 0, 5.5), "points"))
  
  donor_idents <- ggplot(unique_donor_subset) + 
    geom_tile(aes(x=interaction(donor, subtype), fill=donor, y='a')) + 
    scale_x_discrete(labels=row_names, expand=c(0,0)) + 
    scale_y_discrete(expand=c(0,0)) +
    geom_vline(color='white', xintercept=0.5+c(1:n_lines-1)*2) +
    theme_minimal() +
    coord_fixed(ratio=1/8) +
    theme(
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank(),
      plot.margin = unit(c(0, 22, 0, 5.5), "points"))
  
  cluster_idents <- ggplot(unique_donor_subset) + 
    geom_tile(aes(x=interaction(donor, subtype), fill=subtype, y='a')) + 
    geom_vline(color='white', xintercept=0.5+c(1:n_lines-1)*2) +
    scale_x_discrete(labels=row_names, expand=c(0,0)) + 
    scale_y_discrete(expand=c(0,0)) +
    scale_fill_manual(values=all_colors) +
    theme_minimal() +
    coord_fixed(ratio=1/8) +
    theme(
      legend.position = 'none',
      axis.text.x = element_text(angle = 90, vjust = -1.5, hjust=1),
      axis.title.y= element_blank(),
      axis.title.x=element_blank(),
      axis.text.y=element_blank(),
      panel.background = element_blank(),
      plot.margin = unit(c(0, 22, 5.5, 5.5), "points"))

  return(de_gene_heatmap / donor_idents / cluster_idents)
}

# cd4_pruned <- prune_cells(scrna_cd4_all, rescale=T)
# cd8_pruned <- prune_cells(scrna_cd8_all, rescale=T)

cd4_gene_heatmap <- make_gene_heatmap(cd4_pruned, cd4_order, max_genes=50, label_genes=cd4_genes, rescale=F)
cd8_gene_heatmap <- make_gene_heatmap(cd8_pruned, cd8_order, max_genes=50, label_genes=cd8_genes, rescale=F)

cd4_gene_heatmap[[1]] <- cd4_gene_heatmap[[1]] + 
  scale_y_discrete('Top 50 DE genes per cluster') + ggtitle('CD4') + theme(
    legend.position='none', axis.title.y=element_text(angle = 90))
cd4_gene_heatmap[[2]] <- cd4_gene_heatmap[[2]] + theme(legend.position='none')

cd8_gene_heatmap[[1]] <- cd8_gene_heatmap[[1]] + ggtitle('CD8')
# cd8_gene_heatmap[[2]] <- cd8_gene_heatmap[[2]] + theme(legend.position='none')

(cd4_gene_heatmap | plot_spacer() | cd8_gene_heatmap | (
  (plot_spacer() / guide_area()) + plot_layout(heights=c(8,1)))) +
    plot_layout(widths=c(8,0.001,9,0.1), guides='collect')


)
```


### ADT


```{r}
adt_groups <- list(
  'Activation/Costimulation'= c(
    "IL2RA",
    "CD137",
    "OX40",
    "CD30",
    "CD80",
    "CD86",
    "CD38",
    "ICOS",
    "CD2",
    "CD69",
    "CD40",
    "HLA-ABC"),
  "Cytokines/Chemokines\nIntegrins"=c(
    "IL2RA",
    "IL7R",
    "CXCR3",
    "CXCR5",
    "CD49E",
    "ITGA1",
    "CD49b",
    "CD49E",
    "CCR5"),
  "Differentiation"=c(
    "CD45RO",
    "CD45RA",
    "CCR7",
    "CD62L",
    "CD7",
    "CD95",
    "CD27",
    "CD28"),
  "Inhibitory"=c(
    "PD1",
    "LAG3",
    "Tim3",
    "GITR"))


make_adt_heatmap <- function(seurat_obj, adt_groups, subtype_order) {
  
  seurat_obj <- ScaleData(seurat_obj, assay='SCT_ADT_INT')
  
  all_adt <- AverageExpression(
    seurat_obj,
    assays = 'SCT_ADT_INT',
    features = NULL,
    return.seurat = FALSE,
    group.by = "Subtype",
    slot = "scale.data"
  )

  # melt, clean
  melted_adt <- reshape2::melt(all_adt[[1]])
  melted_adt <- data.table(melted_adt)
  names(melted_adt) <- c('gene','subtype','zscore')
  melted_adt[, donor := gsub('.*_(.*)','\\1', subtype)]
  melted_adt[, subtype := gsub('(.*)_(.*)','\\1', subtype)]
  melted_adt[, subtype := factor(subtype, levels=subtype_order)]
  melted_adt[, best_subtype := subtype[which.max(zscore)], by=gene]
  melted_adt[, zdiff := zscore[which.max(zscore)] - mean(zscore), by=gene]
  gene_order <- unique(melted_adt[subtype == best_subtype, gene[order(zdiff)]])
  melted_adt[, gene := factor(gene, levels=gene_order)]
  melted_adt[, max_score := max(abs(zscore)), by='gene']
  
  # remove '.adt'
  melted_adt[, gene := gsub('\\.adt','',gene)]
  

  # assign groups
  if (!is.null(adt_groups)) {
    for(i in 1:length(adt_groups)) {
      melted_adt[gene %in% adt_groups[[i]], group := names(adt_groups)[i]]
    }
    #reorder
    new_adt_order <- c()
    for (group_i in na.omit(unique(melted_adt$group))) {
      
      cast_group <- dcast(melted_adt[!is.na(subtype) & group == group_i], 
          gene ~ subtype, value.var='zscore')
      
      group_adt_order <- dendsort(hclust(dist(
        dcast(melted_adt[group == group_i], 
          gene ~ subtype, value.var='zscore')[,-1])))$order
      group_adts <- cast_group$gene[group_adt_order]
      new_adt_order <- c(new_adt_order, group_adts)
    }
    melted_adt <- melted_adt[!is.na(group)]
    melted_adt[, gene := factor(gene, levels=new_adt_order)]
    cast_formula <- "group~."
  } else {
    cast_formula <- "best_subtype ~."
  }
  
  de_adt_heatmap <- ggplot(melted_adt) + 
    geom_raster(aes(x=subtype, y=gene, fill=zscore)) +
    facet_grid(as.formula(cast_formula), scales='free', space='free') +
    scale_fill_distiller(
      'CITE-seq z-score', palette='PuOr',
      oob=scales::squish, limit=c(-1, 1), type='div', breaks=c(-1,0,1),
      labels=c('>1', '0', '<1')) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
      axis.title.x=element_blank(),
      axis.title.y=element_blank(),
      plot.margin = unit(c(5.5, 5.5, 0, 5.5), "points"))
  
  return(de_adt_heatmap)
}

cd8_stim_subsets <- c('STIM-GLYC','STIM-OXPHOS','STIM-IFNG','STIM-GNLY','STIM-INACT','STIM-UNTR')
cd4_stim_subsets <- c('STIM-GLYC','STIM-OXPHOS','STIM-IFNG','STAT1-IRF1','STIM-UNTR')

scrna_cd8$Subtype <- NULL
scrna_cd8 <- map_clusters(scrna_cd8_all, scrna_cd8, 'Subtype', 'Subtype')
prune_cd8 <- prune_cells(scrna_cd8, subtypes= cd8_stim_subsets, k_types='cd19+')
cd8_stim_citeseq_map <- make_adt_heatmap(prune_cd8, adt_groups, cd8_order)

prune_cd4 <- prune_cells(scrna_cd4_all, subtypes= cd4_stim_subsets, k_types='cd19+')
cd4_stim_citeseq_map <- make_adt_heatmap(prune_cd4, adt_groups, cd4_order)

"NAIVE-CD7"=
 "IFITM2, VIM, STMN1, HMGN2, CAPG, STIM1, CD7, IFITM1, PLEKHO1, TCF7"
"MEM-CD29"=
 "SELL, ZEB2, EOMES, ITGA1, ITGB2, ITGB7, ITGA4, ITGB1, PLEK, CXCR3, CD59, ID2, IGFBP3, MHC-II, PYHIN1, PRR5L, S100A4, ANXA1, CCL5, TNFSF9, BATF, CX3CR1, FGFBP2, KLRG1, NKG7, GZMK, CST7, HOPX"
"STIM-IFNG"=
 "IFNG, GZMH, GZMK, GZMB, NKG7, CCR5, HLA-DQA1, CD74, PRDM1, CD2, LAG3, TNFRSF9, FABP5, CCL5, FAM162A, LGALS1, SRM, HLA-DRA, HLA-DQA2, ID2, GNLY, GZMB, ZBED2, ALDOC, HOPX, CTSD, ENO1, SLAMF1, DPP4, FCGR3A, PYHIN1"
"STIM-GLYC"=
 "ARG2, BNIP3, BNIP3L, LAYN, HILPDA, MT2, MT2A, MT1E, MT1X, LDHA, DDIT3, DDIT4, FAM162A, PKM, JUNB, XCL2, MTHFD2, DUSP4, LDHA, ALDOC, SLC2A3, LTA, GADD45A, JUND, TNFAIP3"
"STIM-UNTR"=
 "S100A10, CD38, LAYN, ENO1, PGK1, IGFBP2, NEAT1, STAT1, CD27, TNFAIP2"
"STIM-OXPHOS"=
 "HMGA1, HSP90AA1, FKBP4 (mtor), HSPD1, MT-CO3, HSP90AB1, CXCL10, IL5, C1QBP, EIF5A, HSPH1, MYC, MD-ND3, SRM, MTHFD2, MT-ATP6, HSPE1, HSP8, IL22, IL13, IL2RA"
"STIM-INACT"=
 "BATF, CTSW, DDX21, CYP1B1, BATF3, GZMA, TNFSF10, PFN1"
"NAIVE-CD62L"=
 "SELL, MAL, KLF2, TXNIP, IL7R, LRRN3"
"MEM-CD29"=
 "CD8A, CXCR3, CD28, CD45RO, CD29, HVEM"
"STIM-IFNG"=
 "CD2, CD49b, CD45RO, CD28"
"STIM-GLYC"=
 "IL2RA, PD1, LAG3"
"STIM-UNTR"=
 "CD5, CCR5, CCR7"
"STIM-OXPHOS"=
 "ICOS, CD2, LAG3, CD80, CD30, ICOS, IL2RA"
"STIM-INACT"=
 "Tim3, CD2, CD7, CCR6, TNFRSF18"

NAIVE-CD7: IFITM2, VIM, STMN1, HMGN2, CAPG, STIM1, CD7, IFITM1, PLEKHO1, TCF7

MEM-CD29_genes: SELL, ZEB2, EOMES, ITGA1, ITGB2, ITGB7, ITGA4, ITGB1, PLEK, CXCR3, CD59, ID2, IGFBP3, MHC-II, PYHIN1, PRR5L, S100A4, ANXA1, CCL5, TNFSF9, BATF, CX3CR1, FGFBP2, KLRG1, NKG7, GZMK, CST7, HOPX
MEM-CD29-proteins: CD8A, CXCR3, CD28, CD45RO, CD29, HVEM

STIM-IFNG-genes: PRDM1, CCR5, HLA-DQA1, CD2, LAG3, TNFRSF9, PRDM1, FABP5, CCL5, FAM162A, LGALS1, SRM, IFNG, HLA-DRA, HLA-DQA2, GZMK, ID2, GNLY, GZMB, ZBED2, ALDOC, HOPX, CTSD, ENO1, SLAMF1, DPP4, FCGR3A, PYHIN1, NKG7, CD74, GZMH, LTB, PLEK, ANXA1, KLRG1
STIM-IFNG-proteins: CD2, CD49b, CD45RO, CD28

STIM-GLYC-genes: ARG2, BNIP3, BNIP3L, LAYN, HILPDA, MT2, MT2A, MT1E, MT1X, LDHA, DDIT3, DDIT4, FAM162A, PKM, JUNB, XCL2, MTHFD2, DUSP4, LDHA, ALDOC, SLC2A3, LTA, GADD45A, JUND, TNFAIP3
STIM-GLYC-proteins: IL2RA, PD1, LAG3

STIM-UNTR-genes: S100A10, CD38, LAYN, ENO1, PGK1, IGFBP2, NEAT1, STAT1, CD27, TNFAIP2
STIM-UNTR-proteins: CD5, CCR5, CCR7

STIM-OXPHOS-genes: HMGA1, HSP90AA1, FKBP4 (mtor), HSPD1, MT-CO3, HSP90AB1, CXCL10, IL5,
C1QBP, EIF5A, HSPH1, MYC, MD-ND3, SRM, MTHFD2, MT-ATP6, HSPE1, HSP8, IL22, IL13, IL2RA
STIM-OXPHOS-proteins: ICOS, CD2, LAG3, CD80, CD30

STIM-INACT-genes: BATF, CTSW, DDX21, CYP1B1, BATF3, GZMA, TNFSF10, PFN1
STIM-INACT-proteins: Tim3, CD2, CD7, CCR6, GITR

```

## Protein expression
```{r}

protein_data <- 

FetchData(pruned_cd8


```


## PATHWAYS

```{r}

gsea_subsets <- c(
  "HALLMARK_PI3K_AKT_MTOR_SIGNALING",
  "KEGG_MTOR_SIGNALING_PATHWAY",
  "HALLMARK_MTORC1_SIGNALING",
  "BIOCARTA_NFKB_PATHWAY",
  "GILMORE_CORE_NFKB_PATHWAY",
  "HALLMARK_GLYCOLYSIS",
  "HALLMARK_OXIDATIVE_PHOSPHORYLATION",
  "HALLMARK_IL6_JAK_STAT3_SIGNALING",
  "HALLMARK_MYC_TARGETS_V2",
  "BIOCARTA_CD40_PATHWAY",
  "BIOCARTA_41BB_PATHWAY",
  "FATTY_ACID_OXIDATION",
  "HALLMARK_HYPOXIA",
  "GOBP_INTERFERON_GAMMA_MEDIATED_SIGNALING_PATHWAY",
  "GOBP_ACTIVATION_OF_NF_KAPPAB_INDUCING_KINASE_ACTIVITY",
  "GOBP_NEGATIVE_REGULATION_OF_TYPE_I_INTERFERON_PRODUCTION",
  "GOBP_NEGATIVE_REGULATION_OF_TYPE_I_INTERFERON_MEDIATED_SIGNALING_PATHWAY",
  "BIOCARTA_IFNG_PATHWAY",
  "PID_IL12_2PATHWAY",
  "HALLMARK_APOPTOSIS",
  "HALLMARK_INTERFERON_GAMMA_RESPONSE",
  "KEGG_CELL_ADHESION_MOLECULES_CAMS",
  "REACTOME_INTERFERON_GAMMA_SIGNALING",
  "HALLMARK_IL2_STAT5_SIGNALING",
  "PID_CD40_PATHWAY",
  "PID_NFAT_TFPATHWAY",
  "GOBP_ACTIVATION_INDUCED_CELL_DEATH_OF_T_CELLS",
  "PID_IL2_PI3K_PATHWAY",
  "REACTOME_FASL_CD95L_SIGNALING",
  "PID_FAS_PATHWAY",
  "WP_TNF_ALPHA_SIGNALING_PATHWAY",
  "BIOCARTA_IFNA_PATHWAY",
  "WP_TYPE_II_INTERFERON_SIGNALING_IFNG",
  "BIOCARTA_NKT_PATHWAY",
  "WP_ARYL_HYDROCARBON_RECEPTOR_PATHWAY",
  "REACTOME_INTERLEUKIN_12_SIGNALING",
  "PID_SHP2_PATHWAY",
  "BIOCARTA_CTL_PATHWAY",
  "BOSCO_TH1_CYTOTOXIC_MODULE",
  "PID_NFAT_TFPATHWAY",
  "GOBP_TYPE_I_INTERFERON_PRODUCTION",
  "KEGG_CALCIUM_SIGNALING_PATHWAY",
  "BIOCARTA_GATA3_PATHWAY",
  "PID_AP1_PATHWAY",
  "MOOTHA_FFA_OXYDATION",
  "MOOTHA_GLUCONEOGENESIS",
  "MOOTHA_GLYCOGEN_METABOLISM",
  "MOOTHA_GLYCOLYSIS",
  "MOOTHA_ROS",
  "MOOTHA_TCA",
  "MOOTHA_VOXPHOS"
  )

scrna_cd8_all <- LoadH5Seurat(here::here(
  '..','..','scrnaseq_tcsl154',
  'rds',
  paste0('scrna.wnn.int.cd8.all.annotated.h5Seurat')))
scrna_cd4_all <- LoadH5Seurat(here::here(
  '..','..','scrnaseq_tcsl154',
  'rds',
  paste0('scrna.wnn.int.cd4.all.annotated.h5Seurat')))
pruned_cd8_all <- prune_cells(scrna_cd8_all, rescale=T)
pruned_cd4_all <- prune_cells(scrna_cd4_all, rescale=T)
Idents(pruned_cd8_all) <- 'Subtype'

cd8_gsea_scores_rna <- map_geneset_parallel(pruned_cd8_all, gsea_subsets, assay='RNA', nbin=24)

cd8_all_gsea_scores_rna <- map_geneset_parallel(scrna_cd8_all, gsea_subsets, assay='RNA', nbin=24)
scrna_cd8_all[[names(cd8_all_gsea_scores_rna)]] <- cd8_all_gsea_scores_rna

cd4_all_gsea_scores_rna <- map_geneset_parallel(scrna_cd4_all, gsea_subsets, assay='RNA', nbin=24)
scrna_cd4_all[[names(cd4_all_gsea_scores_rna)]] <- cd4_all_gsea_scores_rna


pruned_cd8_all[[names(cd8_gsea_scores_rna)]] <- cd8_gsea_scores_rna

cd8_gsea_scores_rna <- map_geneset_parallel(prune_cells(scrna_cd8_all, rescale=T), gsea_subsets, assay='RNA', nbin=24)
scrna_cd8_all[[names(cd8_gsea_scores_rna)]] <- cd8_gsea_scores_rna

cd4_gsea_scores_rna <- map_geneset_parallel(prune_cells(scrna_cd4_all), gsea_subsets, assay='RNA', nbin=8)
scrna_cd4_all[[names(cd4_gsea_scores_rna)]] <- cd4_gsea_scores_rna

ggplot(data.table(scrna_cd8_all@meta.data, keep.rownames=T)[melt(data.table(cd8_gsea_scores_rna, keep.rownames=T), id.vars=c('rn')), on='rn']) + geom_boxplot(aes(y=value, x=Subtype, fill=Subtype), outlier.shape = NA) + facet_wrap(~variable, scales='free', ncol=4) +coord_flip() + scale_fill_manual(values=all_colors)

make_cdf <- function(seurat_obj, pathway_name, pathway_label, 
    subtypes=c('STIM-IFNG','STIM-GLYC','STIM-OXPHOS'), quant_limit=0.05, group.by='Subtype', colorlist=unlist(all_colors), return_val='cdf') {
  
  # pull out pathway
  data <- data.table(FetchData(seurat_obj, 
      c(pathway_name,'Subtype','car')))

  # subset on subtypes
  if (!is.null(subtypes)) {
    data <- data[Subtype %in% subtypes]
  }
  
  data[, c(group.by) := factor(get(group.by), levels=unique(get(group.by)))]
  
  # rescale z-scores within groups
  data[, c(pathway_name) := list(scale(get(pathway_name)))]
  
  # get quantiles for plotting
  min_quant <- data[, quantile(get(pathway_name), c(quant_limit), na.rm=T), by=group.by][, min(V1)]
  max_quant <- data[, quantile(get(pathway_name), c(1-quant_limit), na.rm=T), by=group.by][, max(V1)]

  test_results <- data.table()
  
  #ks_test
  for (group in levels(data[, get(group.by)])) {
    koltest <- ks.test(
        data[get(group.by) == group, get(pathway_name)],
        data[get(group.by) != group, get(pathway_name)], exact=T)
    test_results <- rbind(
      test_results,
      data.table(
        'p.value'=koltest$p.value, 
        'statistic'=koltest$statistic, 
        'mean'=data[get(group.by) == group, mean(get(pathway_name))],
        'group'=group))
  }
  
  return(switch(return_val,
   'cdf'= ggplot(data,
      aes(x=get(pathway_name), color=get(group.by))) + 
      stat_ecdf(geom='step') +
      theme_minimal() +
      scale_y_continuous(breaks=c(0,1)) +
      scale_color_manual(values=colorlist) +
      theme(legend.position = 'none', panel.grid = element_blank()) +
      geom_vline(xintercept=-Inf) +
      coord_cartesian(xlim=c(min_quant, max_quant)) +
      geom_hline(yintercept=-Inf) +
      labs(x=pathway_label, y=''),
   'pdf'= ggplot(data,
      aes(x=get(pathway_name), color=get(group.by))) + 
      geom_density() +
      theme_minimal() +
      scale_y_continuous(breaks=c(0,1)) +
      scale_color_manual(values=colorlist) +
      theme(legend.position = 'none', panel.grid = element_blank()) +
      geom_vline(xintercept=-Inf) +
      coord_cartesian(xlim=c(min_quant, max_quant)) +
      geom_hline(yintercept=-Inf) +
      labs(x=pathway_label, y=''),
    'test'= test_results))
}

pathway_list <- list(
  'IFNG'='BIOCARTA_IFNG_PATHWAY',
  'NFkB'='BIOCARTA_NFKB_PATHWAY',
  'Th1/Cytotoxic'='BOSCO_TH1_CYTOTOXIC_MODULE',
  'Ca2+ Signaling'='KEGG_CALCIUM_SIGNALING_PATHWAY',
  'Cell Adhesion/\nIntegrins'='KEGG_CELL_ADHESION_MOLECULES_CAMS',
  'OXPHOS'='HALLMARK_OXIDATIVE_PHOSPHORYLATION',
  'TCA'="MOOTHA_TCA",
  'Th2/GATA3'="BIOCARTA_GATA3_PATHWAY",
  'STAT5'="HALLMARK_IL2_STAT5_SIGNALING",
  'Glycolysis'='HALLMARK_GLYCOLYSIS',
  'HIF1a/Hypoxia'='HALLMARK_HYPOXIA',
  'AICD'='GOBP_ACTIVATION_INDUCED_CELL_DEATH_OF_T_CELLS',
  'Myc'='HALLMARK_MYC_TARGETS_V2',
  'IL2/PI3K'='PID_IL2_PI3K_PATHWAY'
)

plot_grid(
  plotlist=lapply(1:length(pathway_list), function(i) {
    make_cdf(cd4_pruned, pathway_list[[i]], pathway_label=names(pathway_list)[i])
  }),
  nrow=1,
  align='hv',
  axis='lr')

plot_grid(
  plotlist=lapply(1:length(pathway_list), function(i) {
    make_cdf(cd8_pruned, pathway_list[[i]], pathway_label=names(pathway_list)[i])
  }),
  nrow=1,
  align='hv',
  axis='lr')

plot_grid(
  plotlist=lapply(1:length(pathway_list), function(i) {
    make_cdf(cd8_pruned, pathway_list[[i]], pathway_label=names(pathway_list)[i], group.by='car', colorlist=car_colors)
  }),
  nrow=1,
  align='hv',
  axis='lr')

module_tile_grid <- function(seurat_obj, pathway_list, group.by, dots='F',
    subtypes=c('STIM-IFNG','STIM-GLYC','STIM-OXPHOS'),
    override_pathway_order=NULL, override_group_order=NULL) {
  
  test_table <- rbindlist(lapply(1:length(pathway_list), function(i) {
      test <- make_cdf(seurat_obj, pathway_list[[i]], 
        pathway_label=names(pathway_list)[i], subtypes=subtypes,
        group.by=group.by, return_val='test')
      test$pathway <- pathway_list[[i]]
      test$pathway_name <- names(pathway_list)[i]
      return(test)
      }))
  
  # remove duplicated pathways (I dont want to re-run addmodule)
  test_table <- unique(test_table)
  
  test_table[, pathway_name := factor(pathway_name)]
  

  pathway_order <- dendsort(hclust(t(dist(
    dcast(test_table, 
      pathway_name ~ group, value.var='mean')[,-1]))))$order
  group_order <- dendsort(hclust(t(dist(
    dcast(test_table, 
      group ~ pathway_name, value.var='mean')[,-1]))))$order
  if (!is.null(override_pathway_order))
    pathway_order <- override_pathway_order
  if (!is.null(override_group_order))
    group_order <- override_group_order
  
  test_table[, pathway_name := factor(pathway_name, levels=levels(pathway_name)[pathway_order])]
  test_table[, group := factor(group, levels=levels(factor(group))[group_order])]
  
  if (dots) {
    
    plot <- ggplot(test_table) + 
      geom_point(aes(
        y=group,
        x=pathway_name, color=mean, size=pmax(pmin(-log(p.value), 12), 0))) +
      scale_color_distiller('Module z-score',
        palette='PuOr', oob=scales::squish, limit=c(-1, 1), type='div',
        breaks=c(1, 0, -1), labels=c('>1','0','< -1')) + 
      scale_x_discrete('Gene Modules') +
      scale_y_discrete('') +
      theme_minimal() +
      theme(
        panel.border=element_rect(color='black', fill=NA),
        panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
      coord_flip()
  } else {
  
    plot <- ggplot(test_table) +
      geom_tile(aes(
        y=group,
        x=pathway_name, fill=mean)) +
      scale_fill_distiller('Module z-score',
        palette='PuOr', oob=scales::squish, limit=c(-1, 1), type='div',
        breaks=c(1, 0, -1), labels=c('>1','0','< -1')) + 
      scale_x_discrete('Gene Modules', expand=c(0,0)) +
      scale_y_discrete('', expand=c(0,0)) +
      theme_minimal() +
      theme(
        panel.border=element_rect(color='black', fill=NA),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
      coord_flip()
  }
  
  return(list(
    data=test_table, plot=plot, pathway_order=pathway_order, group_order=group_order))
}

# ACTIVATED SUBSET PATHWAYS
activated_subtypes <- c('STIM-GLYC','STIM-OXPHOS','STIM-IFNG')

pruned_cd8_cars <- prune_cells(scrna_cd8_all)
pruned_cd4_cars <- prune_cells(scrna_cd4_all)

cd8_module_tiles <- module_tile_grid(pruned_cd8_cars,
    pathway_list, group.by='Subtype', dots=F, subtypes=activated_subtypes)
cd4_module_tiles <- module_tile_grid(pruned_cd4_cars, pathway_list, group.by='Subtype', dots=F, 
  subtypes=activated_subtypes,
  override_pathway_order = cd8_module_tiles$pathway_order,
  override_group_order = cd8_module_tiles$group_order)

#combined cd4/cd8 plot:

combined_tile_data <- rbind(
  data.table(cd8_module_tiles$data)[, t_type := 'CD8'],
  data.table(cd4_module_tiles$data[, t_type := 'CD4']))

combined_tile_plot <- ggplot(combined_tile_data) +
      geom_tile(aes(
        y=group,
        x=pathway_name, fill=mean)) +
      scale_fill_distiller('Module z-score',
        palette='PuOr', oob=scales::squish, limit=c(-1, 1), type='div',
        breaks=c(1, 0, -1), labels=c('>1','0','< -1')) + 
      scale_x_discrete('Gene Modules', expand=c(0,0)) +
      scale_y_discrete('', expand=c(0,0)) +
      facet_grid(~t_type) +
      theme_minimal() +
      theme(
        panel.border=element_rect(color='black', fill=NA),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
      coord_flip()
```
