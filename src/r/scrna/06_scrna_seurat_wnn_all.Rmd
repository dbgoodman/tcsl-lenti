---
title: "05 SCRNA All"
output: html_notebook
---

```{r}
library(SeuratDisk)


SEURAT_RDS_FILE <- here::here(
    '..','..','scrnaseq_tcsl154',
    'rds','scrna.hashed.rds')

source(here::here('r','scrna','scrna_analysis_fxns.R'))
source(here::here('r','fig_colors.R'))
source(here::here('r','scrna','HTOdemux.R'))
```

## Load processed RNAseq, perform second round of doublet removal

```{r}
plots <- list()

scrna <- subset(
  readRDS(SEURAT_RDS_FILE),
  subset=(car != 'K_only'))

scrna@meta.data$sample <- paste(
  scrna@meta.data$car,
  ifelse(scrna@meta.data$k_type=='baseline', 'unstim','stim'),
  sep='.')

#second pass doublet removal
Idents(scrna) <- 'sample'
scrna <- janky_doublet_removal(scrna)
plots$hto_doublet_umap <- DimPlot(scrna, reduction='umap.hto', group.by='HTO_is_doublet', label=T)
scrna <- subset(scrna, subset = (HTO_keep == T))
```

## Recalculate CD4 v CD8s

``` {r}
scrna <- run_sct(scrna)
t_out <- reassign_t_type(scrna, n_clust=6, plots)
plots <- t_out$plots
scrna <- t_out$seurat_obj

plots$hto_doublet_t_typefix <- DimPlot(scrna, reduction='umap.hto', group.by='CD4v8', label=T, 
  cols=c('grey30','grey50','red'))
scrna <- subset(scrna, CD4v8 != 'DP')
```

## Run WNN Clustering on all cells
```{r}
scrna_output <- sct_umap(scrna, title='All cells')
scrna <- scrna_output$obj
plots <- c(plots, scrna_output$plots)

plots$combined_umap_2 <- (
  DimPlot(scrna, reduction = 'wnn.umap', label = TRUE, repel = TRUE, label.size = 2.5) + 
    NoLegend() +
  DimPlot(scrna, reduction = 'wnn.umap', group.by = 'CD4v8', label = TRUE, repel = TRUE, label.size = 2.5) + 
    NoLegend() +
  DimPlot(scrna, reduction = 'wnn.umap', group.by = 'k_type', label = TRUE, repel = TRUE, label.size = 2.5) +
    NoLegend() +
  DimPlot(scrna, reduction = 'wnn.umap', group.by = 'Phase', label = TRUE, repel = TRUE, label.size = 2.5) + 
    NoLegend())
```

## Filter mixed CD4/CD8 clusters

```{r}
clust_cutoff_pct = 0.15
pct_cd8_clust <- data.table(scrna@meta.data)[, list(pct_cd8= sum(CD4v8 == 'CD8')/.N), by='seurat_clusters']

# cells in these clusters have mixed 4s and 8s
mixed_clusters <- pct_cd8_clust[pct_cd8 > clust_cutoff_pct & pct_cd8 < 1-clust_cutoff_pct]
scrna@meta.data$t_type_mixed <- scrna@meta.data$seurat_clusters %in% mixed_clusters$seurat_clusters

# these cells are 4s in 8-dominated clusters, and vice versa
scrna@meta.data$t_type_opposing <- scrna@meta.data$seurat_clusters %in% c(29,32,26,24)

# cells in these clusters have mixed 4s and 8s
mixed_clusters <- pct_cd8_clust[pct_cd8 > clust_cutoff_pct & pct_cd8 < 1-clust_cutoff_pct]
scrna@meta.data$t_type_mixed <- scrna@meta.data$seurat_clusters %in% mixed_clusters

# these cells are 4s in 8-dominated clusters, and vice versa

scrna@meta.data$t_type_opposing <- `|`(
  scrna@meta.data$seurat_clusters %in% pct_cd8_clust[pct_cd8 > 1-clust_cutoff_pct, seurat_clusters] & 
    scrna@meta.data$CD4v8 == 'CD4',
  scrna@meta.data$seurat_clusters %in% pct_cd8_clust[pct_cd8 < clust_cutoff_pct, seurat_clusters] & 
    scrna@meta.data$CD4v8 == 'CD8')

scrna <- subset(scrna, t_type_opposing == F)

SEURAT_HDF5_FILE <- here::here(
  '..','..','scrnaseq_tcsl154',
  'rds','scrna.wnn.all.clean.h5Seurat')
SaveH5Seurat(scrna, filename = SEURAT_HDF5_FILE, overwrite=T)

saveRDS(plots,
  here::here(
    '..','..','scrnaseq_tcsl154',
    'rds',
    paste0('scrna.wnn.all.clean.data.rds')))
```

## Cluster Correlations
```{r}
plots$scrna_dendro <- make_dendroheatmap(get_ident_avg(scrna))
```

## Run CD4/CD8 job subsets

Ran 06_run_subset_job.R with `t_type=CD4` and `t_type=CD8`, generating h5Seurat files in `/home/ec2-user/scrnaseq_tcsl154/rds`.

```{r}
rds_dir <- here::here('..','..','scrnaseq_tcsl154','rds')
scrna_cd4_all <- LoadH5Seurat(paste0(rds_dir, '/scrna.wnn.CD4.clean.h5Seurat'))
scrna_cd4 <- LoadH5Seurat(paste0(rds_dir, '/scrna.wnn.CD4.stim.clean.h5Seurat'))
scrna_cd8_all <- LoadH5Seurat(paste0(rds_dir, '/scrna.wnn.CD8.clean.h5Seurat'))
scrna_cd8 <- LoadH5Seurat(paste0(rds_dir, '/scrna.wnn.CD8.stim.clean.h5Seurat'))
scrna_cd8_old <- readRDS(here::here('..','..','scrnaseq_tcsl154', 'rds','scrna.wnn.cd8.rds'))

if(!('scrna' %in% ls()))
  scrna <- LoadH5Seurat(paste0(rds_dir, '/scrna.wnn.all.clean.h5Seurat'))

## COMBINED CELLS:
#bad clusters:
bad_all_clusts <- c(24, 30, 29, 28, 26, 32, 23, 33)
bad_cd8_clusts <- c(20, 24, 28, 27, 25)

#CD8
#map STIM to UNSTIM
scrna_cd8_all <- map_clusters(scrna_cd8, scrna_cd8_all, 'seurat_clusters', 'act_clusters')

cd8_act_avg <- get_ident_avg(scrna_cd8_all, ident='act_clusters')
cd8_mixed_avg <- get_ident_avg(scrna_cd8_all, ident='seurat_clusters')
#heatmap(cor(cd8_act_avg, cd8_mixed_avg))

#map old to new for both
scrna_cd8 <- map_clusters(
  readRDS(here::here('..','..','scrnaseq_tcsl154', 'rds','scrna.wnn.cd8.rds')),
  scrna_cd8, 'seurat_clusters', 'old_clusters')
scrna_cd8_all <- map_clusters(
  readRDS(here::here('..','..','scrnaseq_tcsl154', 'rds','scrna.wnn.cd8.rds')),
  scrna_cd8_all, 'seurat_clusters', 'old_clusters')

DimPlot(scrna_cd8, reduction='wnn.umap',group.by='old_clusters', label=T) + 
  DimPlot(scrna_cd8, reduction='wnn.umap',group.by='seurat_clusters', label=T)

cd8_act_clust_data <- plot_clust_by_act(scrna_cd8_all)

#CD4
#map STIM to UNSTIM
scrna_cd4_all <- map_clusters(scrna_cd4, scrna_cd4_all, 'seurat_clusters', 'act_clusters')

#map old to new for both
scrna_cd4 <- map_clusters(
  readRDS(here::here('..','..','scrnaseq_tcsl154', 'rds','scrna.wnn.cd4.rds')),
  scrna_cd4, 'seurat_clusters', 'old_clusters')

scrna_cd4_all <- map_clusters(
  readRDS(here::here('..','..','scrnaseq_tcsl154', 'rds','scrna.wnn.cd4.all.rds')),
  scrna_cd4_all, 'seurat_clusters', 'old_clusters')

#map old to new for both
scrna_cd4 <- map_clusters(
  readRDS(here::here('..','..','scrnaseq_tcsl154', 'rds','scrna.wnn.cd4.rds')),
  scrna_cd8, 'seurat_clusters', 'old_clusters')
scrna_cd4_all <- map_clusters(
  readRDS(here::here('..','..','scrnaseq_tcsl154', 'rds','scrna.wnn.cd4.rds')),
  scrna_cd4, 'seurat_clusters', 'old_clusters')

DimPlot(scrna_cd4, reduction='wnn.umap',group.by='old_clusters', label=T) + 
  DimPlot(scrna_cd4, reduction='wnn.umap',group.by='seurat_clusters', label=T)

cd4_act_clust_data <- plot_clust_by_act(scrna_cd4_all)

cd4_act_umap_plot_rna <- umap_plot(scrna_cd4, assay='SCT', cluster_name='seurat_clusters', reduction='wnn.umap')
cd4_act_umap_plot_adt <- umap_plot(scrna_cd4, assay='SCT_ADT', cluster_name='seurat_clusters', reduction='wnn.umap')

scrna <- map_clusters(scrna_cd4, scrna, 'seurat_clusters', 'cd4_act_clusters')
scrna <- map_clusters(scrna_cd8, scrna, 'Subtype', 'cd8_act_clusters')

plot_clust_by_act
```

## CD8 Act cluster annotations
```{r}

#CD8 old annotated cluters
cluster_annotations <- fread(text="
old_clusters   Activation    Subtype
0         INACT         REST
1         ACT           ACT-GLYC
2         INACT         UNTR
3         ACT           ACT-OXPHOS
4         INACT         REST
5         INACT         REST-TCM
6         ACT           ACT-CD52
7         ACT           ACT-GLYC
8         INACT         REST
9         ACT           ACT-IFNG
10        ACT           ACT-TC2
11        INACT         REST-CXCR3
12        INACT         REST-CXCR3
")

cluster_annotations[, old_clusters := factor(old_clusters)]
addtl_metadata <- cluster_annotations[data.table(scrna_cd8@meta.data), on=c('old_clusters')]
scrna_cd8@meta.data$Activation <- addtl_metadata$Activation
scrna_cd8@meta.data$Subtype <- addtl_metadata$Subtype

scrna_cd8@meta.data$Subtype <- factor(scrna_cd8@meta.data$Subtype,
  levels=c('ACT-GLYC', 'ACT-OXPHOS', 'ACT-CD52','ACT-IFNG', 'ACT-TC2', 'REST', 'UNTR', 'REST-TCM', 'REST-CXCR3'))

scrna_cd8_all <- map_clusters(scrna_cd8, scrna_cd8_all, 'Subtype', 'cd8_act_subtype')
scrna_cd8_all <- map_clusters(scrna_cd8, scrna_cd8_all, 'old_clusters', 'cd8_act_old')

cluster_cols = c(
  'ACT-GLYC'=brewer.pal(9,'OrRd')[8],
  'ACT-OXPHOS'=brewer.pal(9,'YlOrRd')[5],
  'ACT-CD52'=brewer.pal(9,'YlOrRd')[3],
  'ACT-IFNG'=brewer.pal(9,'PuRd')[5],
  'ACT-TC2'=brewer.pal(9,'PuRd')[3],
  'REST'=brewer.pal(9,'YlGnBu')[6],
  'UNTR'=brewer.pal(9,'PuBu')[3],
  'REST-TCM'=brewer.pal(9,'YlGn')[6],
  'REST-CXCR3'=brewer.pal(9,'YlGn')[3])


car_clust_pct <- data.table(scrna_cd8@meta.data)[
  as.numeric(get(cluster_name)) %in% c(0:12,14), .N, 
  by=c('car',cluster_name)][, 
    pct_car := N/sum(N), by='car'][,
      clust_count := sum(N), by=cluster_name][,
        log2_clust_enrich := log2(pct_car/mean(pct_car)), by=cluster_name]

car_clust_pct[, log2_ce_trunc := ifelse(
  test= abs(log2_clust_enrich) > 2, 
  yes= 2 * sign(log2_clust_enrich), 
  no= log2_clust_enrich)]

ggplot(car_clust_pct) + 
  geom_point(aes(
    x=get(cluster_name),
    y=factor(car, c("CD28","4-1BB","BAFF-R","TACI","CD40","TNR8","Zeta","KLRG1","Untransduced")),
    color=log2_ce_trunc, size=pct_car)) + 
  scale_color_distiller(palette='PRGn', direction=1) + scale_size(range=c(1,10)) + theme_minimal()
```
# CD8 new mixed annotated clusters
```{r}
cd8_all_clust_annotations <- fread(text="
0	INACT1
1	INACT2
4	UNTR-STIM
5	INACT-STIM
6	INACT3
7	INACT3
8	INACT-CD29
9	INACT3
10	INACT-CD29
13	INACT3
12	INACT-CD29
15	INACT1
26	INACT-CD29
21	INACT-CD29
23	INACT3")

names(cd8_all_clust_annotations) <- c('seurat_clusters','Subtype')
cd8_all_clust_annotations[, seurat_clusters := factor(seurat_clusters)]
addtl_metadata <- cd8_all_clust_annotations[data.table(scrna_cd8_all@meta.data), on=c('seurat_clusters')]
scrna_cd8_all@meta.data$Inact_Subtype <- addtl_metadata$Subtype

cd8_act_subtype_annotations <- fread(text="
cd8_act_old    Activation    Subtype
1              ACT           ACT-GLYC
2              INACT         UNTR-STIM
3              ACT           ACT-OXPHOS
6              ACT           ACT-GNLY
7              ACT           ACT-GLYC
9              ACT           ACT-IFNG
10             ACT           ACT-TC2
", header=T)

CD8_subtype_order <- c(
  #inact
  'INACT1','INACT2','INACT3','INACT-CD29','INACT-STIM',
  #act
  'UNTR-STIM','ACT-GNLY','ACT-IFNG','ACT-OXPHOS','ACT-TC2','ACT-GLYC')

scrna_cd8_all@meta.data$Subtype <- factor(scrna_cd8_all@meta.data$Subtype, levels=rev(CD8_subtype_order))

cd8_act_subtype_annotations[, cd8_act_old := factor(cd8_act_old)]
addtl_metadata <- cd8_act_subtype_annotations[data.table(scrna_cd8_all@meta.data), on=c('cd8_act_old')]
scrna_cd8_all@meta.data$Act_Subtype <- addtl_metadata$Subtype

#Assign active subtypes, then assign inactives to anything missing
scrna_cd8_all@meta.data$Subtype <- scrna_cd8_all@meta.data$Act_Subtype
scrna_cd8_all@meta.data$Subtype[is.na(scrna_cd8_all@meta.data$Subtype)] <- (
  scrna_cd8_all@meta.data$Inact_Subtype[is.na(scrna_cd8_all@meta.data$Subtype)])

CD8_subtype_colors <- fread(text="
Subtype palette num tot
INACT1 Spectral 11 11
INACT2 YlGnBu 7 9
INACT3 YlGnBu 6 9
INACT-CD29 YlGn 7 9
INACT-STIM Spectral 7 11 
UNTR-STIM Spectral 8 11
ACT-GNLY Spectral 4 11
ACT-IFNG YlGn 9 9
ACT-OXPHOS Spectral 3 11
ACT-TC2 Spectral 2 11
ACT-GLYC Spectral 1 11
", header=T)
CD8_subtype_colors[, hex := brewer.pal(tot,palette)[num], by='Subtype']
CD8_color_list <- setNames(as.list(CD8_subtype_colors[, hex]), CD8_subtype_colors[, Subtype])

bad_cd8_all_clusts <- c(27,24,28,22,20)

#DimPlot(scrna_cd8_all, group.by=c('Subtype'), cols=CD8_color_list) # keep NAs

DimPlot(
  subset(
    subset(scrna_cd8_all, Subtype %in% names(CD8_color_list)),
    seurat_clusters %in% bad_cd8_all_clusts, invert=T
  ), group.by=c('Subtype'), cols=CD8_color_list)

# map all cells to activated only

bad_cd8_all_clusts <- c(27,24,28,22,20)

scrna_cd8_old <- map_clusters(scrna_cd8_all, scrna_cd8_old, 'Subtype', 'Subtype')



```

```{r}
###### CD8 COMPARE CLUSTERS
inact_clusters <- c(0,1,4,5,6,7,8,9,10,12,13,15,16,18,19,21,23,26)
Idents(scrna_cd8_all) <- 'seurat_clusters'
scrna_cd8_all_car_markers_clust <- FindAllMarkers(subset(scrna_cd8_all, seurat_clusters %in% inact_clusters), assay='SCT')
scrna_cd8_all_car_markers_clust_adt <- FindAllMarkers(subset(scrna_cd8_all, seurat_clusters %in% inact_clusters), assay='SCT_ADT')

clust_features <- unique(data.table(scrna_cd8_all_car_markers_clust)[,
  .SD[order(avg_log2FC)[1:5]], by='cluster'][p_val_adj < 0.01]$gene)

clust_features_adt <- unique(data.table(scrna_cd8_all_car_markers_clust_adt)[,
  .SD[order(avg_log2FC)[1:5]], by='cluster'][p_val_adj < 0.01]$gene)


heatmap_clust_v_genes(subset(scrna_cd8_all, seurat_clusters %in% inact_clusters),
  'seurat_clusters', 
  features=intersect(clust_features, rownames(scrna_cd8_all@assays$SCT@data)),
  assay='SCT', use_pct=F, use_slot='data', lfc_trunc=0.5)$plot

heatmap_clust_v_genes(subset(scrna_cd8_all, seurat_clusters %in% inact_clusters),
  'seurat_clusters', 
  features=intersect(clust_features_adt, rownames(scrna_cd8_all@assays$SCT_ADT@data)),
  assay='SCT_ADT', use_pct=F, use_slot='data', lfc_trunc=0.5)$plot


### melt and plot adt data
melted_adt_data <- melt(
  data.table(cbind(scrna_cd8_all@meta.data, t(scrna_cd8_all@assays$SCT_ADT@scale.data))),
    measure.vars=rownames(scrna_cd8_all@assays$SCT_ADT@scale.data))

melted_clust_data <- dcast(
  melted_adt_data[, list(sd=sd(value), mean=mean(value)), 
    by=c('seurat_clusters','variable')], 
  seurat_clusters ~ variable, value.var=c('sd', 'mean'))

ggplot(melted_clust_data, aes(
  x=mean_CD27.adt,
  xmin=mean_CD27.adt-sd_CD27.adt,
  xmax=mean_CD27.adt+sd_CD27.adt,
  y=mean_CD45RA.adt,
  ymin=mean_CD45RA.adt-sd_CD45RA.adt,
  ymax=mean_CD45RA.adt+sd_CD45RA.adt,
  color=seurat_clusters)) + geom_point() + geom_errorbar() + geom_errorbarh()

clust_6_v_0 <- FindMarkers(
    scrna_cd8_all, assay='SCT',
    ident.1 = '6', ident.2='0',
    logfc.threshold = 0.5, min.pct=0.25)


################

cluster_annotations <- fread(text="
old_clusters   Activation    Subtype
0              INACT         REST
1              ACT           ACT-GLYC
2              INACT         UNTR
3              ACT           ACT-OXPHOS
4              INACT         REST
5              INACT         REST-TCM
6              ACT           ACT-CD52
7              ACT           ACT-GLYC
8              INACT         REST
9              ACT           ACT-IFNG
10             ACT           ACT-TC2
11             INACT         REST-CXCR3
12             INACT         REST-CXCR3
")


```
# cytotoxicity
```{r}



heatmap_clust_v_genes(scrna_cd8, 'Subtype', features=c('IFNG','LTA','LTB','GNLY','GZMH','GZMA','PFN1','GZMB','GZMK','CCL5','ITGB1','IL2RA','GATA3','BATF3','IL5','IL13'), assay='SCT', use_pct=T)$plot

heatmap_clust_cell_comp <- function(seurat_obj, clust_a, clust_b, limits=NULL) {
  
  clust_cmp_data <- compare_clusters(seurat_obj, clust_a, clust_b)
  feature_dt <- clust_cmp_data$clust_co_counts
  names(feature_dt)[c(1,2)] <- c('clust_a','clust_b')
  
  feat.dt <- dcast(feature_dt[, list(clust_a, clust_b, pct_a_in_b)], clust_a ~ clust_b, fill=0)
  feat.mat <- as.matrix(feat.dt[, -'clust_a'])
  rownames(feat.mat) <- feat.dt[, clust_a]
  
  if (is.null(limits)) {
    limits <- c(0,max(feat.mat))
  }
  
  dendro_hm_plot <- make_dendroheatmap(
    feat.mat, row_labs=rownames(feat.mat), col_labs=colnames(feat.mat),
    limits=limits)
  return(list(
    plot=dendro_hm_plot,
    data=feature_dt
  ))
}

# all genes I have flagged in the sbwg slide

cd8_interesting_features=c('ANXA1','CXCR3','CD2','BIRC3','HOPX','CD74','CCL5','ITGB1','IFNG','PFN1','GZMB','GZMH','GZMK','GZMA',
           'GNLY','HSPE1','SRM','IL2RA','BATF3','C1QBP','FABP5','IL13','IL5','GATA3',
           'FAM162A','BNIP3','BNIP3L','HILPDA','LDHA','NAMPT','PGK1','ARG2','MT2A')

heatmap_clust_v_genes(scrna_cd8, 'seurat_clusters', features=features, assay='SCT', use_pct=T)$plot


# ggplot(feature_dt[!is.na(clusters)]) + 
#     geom_tile(
#       aes_string(x='clusters', y='gene', fill='log2_fc_trunc')) +
#     scale_fill_distiller('log2 FC\nvs\nmean',direction=1, palette='PiYG') + 
#     theme_minimal() + 
#     theme(panel.grid=element_blank()) + 
#     labs(x=split_name,y='mRNA expression') + coord_flip()

```
## compare CD4 to CD8
```{r}
make_dendroheatmap(cor(
  get_ident_avg(scrna_cd4, ident='seurat_clusters'),
  get_ident_avg(scrna_cd8, ident='old_clusters')))
```

# CD4 gene dendrogram
```{r}

cd4_act_umap_plot_rna <- umap_plot(scrna_cd4, assay='SCT', cluster_name='seurat_clusters', reduction='wnn.umap')
cd4_act_umap_plot_adt <- umap_plot(scrna_cd4, assay='SCT_ADT', cluster_name='seurat_clusters', reduction='wnn.umap')

features <- unique(data.table(cd4_act_umap_plots$marker_genes)[, .SD[order(avg_log2FC)[1:5]], by='cluster']$gene)
heatmap_clust_v_genes(scrna_cd4, 'seurat_clusters', features=features, assay='SCT', use_pct=T)$plot

# cd4_interesting_features=c(
#   'ANXA1','CXCR3','CD2','BIRC3','HOPX','CD74','CCL5','ITGB1','IFNG',
#   'PFN1','GZMB','GZMK','HSPE1','SRM','IL2RA','BATF3','C1QBP','FABP5',
#   'IL13','IL5','GATA3','FAM162A','BNIP3','BNIP3L','HILPDA','LDHA',
#   'NAMPT','PGK1','ARG2','MT2A'); 
features <- unique(data.table(cd4_act_umap_plots$marker_genes)[, .SD[order(avg_log2FC)[1:10]], by='cluster']$gene)

heatmap_clust_v_genes(subset(scrna_cd4, seurat_clusters %in% c(12,2) & car %in% c("CD28","4-1BB","BAFF-R","TACI","CD40","Zeta")), 'car', features=cd4_interesting_features, assay='SCT', use_pct=F)$plot
heatmap_clust_v_genes(subset(scrna_cd4, seurat_clusters %in% c(12,2) & car %in% c("CD28","4-1BB","BAFF-R","TACI","CD40","Zeta")), 'car', features=cd4_interesting_features, assay='SCT', use_pct=F)$plot


###### COMPARE CARS IN CLUSTER
clusters <- c(2,12,13,11,8)
Idents(scrna_cd4) <- 'car'
scrna_cd4_car_markers_clust <- FindAllMarkers(
  subset(scrna_cd4, seurat_clusters %in% clusters & 
    car %in% c("CD28","4-1BB","BAFF-R","TACI","CD40","Zeta")),
  assay='SCT')
clust_features <- unique(data.table(scrna_cd4_car_markers_clust)[, .SD[order(avg_log2FC)[1:20]], by='cluster']$gene)
heatmap_clust_v_genes(
  subset(scrna_cd4, seurat_clusters %in% clusters & 
    car %in% c("CD28","4-1BB","BAFF-R","TACI","CD40","Zeta")),
  'car', 
  features=intersect(clust_features, rownames(scrna_cd4@assays$SCT@data)),
  assay='SCT', use_pct=F, use_slot='data', lfc_trunc=0.5)$plot
################



heatmap_clust_v_genes(subset(scrna_cd4, seurat_clusters %in% c(12,2) & car %in% c("CD28","4-1BB","BAFF-R","TACI","CD40","Zeta")), 'car', features=intersect(rownames(scrna_cd4_car_markers_clust_12_2), rownames(scrna_cd4@assays$SCT@data)), assay='SCT', use_pct=F, use_slot='data')$plot



features <- unique(data.table(cd4_act_umap_plots$marker_genes)[, .SD[order(avg_log2FC)[1:10]], by='cluster']$gene)

```