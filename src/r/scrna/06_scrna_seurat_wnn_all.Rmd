---
title: "05 SCRNA All"
output: html_notebook
---

```{r}
library(SeuratDisk)


SEURAT_RDS_FILE <- here::here(
    '..','..','scrnaseq_tcsl154',
    'rds','scrna.hashed.rds')

source(here::here('r','scrna','scrna_analysis_fxns.R'))
source(here::here('r','fig_colors.R'))
source(here::here('r','scrna','HTOdemux.R'))
```

## Load processed RNAseq, perform second round of doublet removal

```{r}
plots <- list()

scrna <- subset(
  readRDS(SEURAT_RDS_FILE),
  subset=(car != 'K_only'))

scrna@meta.data$sample <- paste(
  scrna@meta.data$car,
  ifelse(scrna@meta.data$k_type=='baseline', 'unstim','stim'),
  sep='.')

#second pass doublet removal
Idents(scrna) <- 'sample'
scrna <- janky_doublet_removal(scrna)
plots$hto_doublet_umap <- DimPlot(scrna, reduction='umap.hto', group.by='HTO_is_doublet', label=T)
scrna <- subset(scrna, subset = (HTO_keep == T))
```

## Recalculate CD4 v CD8s

``` {r}
scrna <- run_sct(scrna)
t_out <- reassign_t_type(scrna, n_clust=6, plots)
plots <- t_out$plots
scrna <- t_out$seurat_obj

plots$hto_doublet_t_typefix <- DimPlot(scrna, reduction='umap.hto', group.by='CD4v8', label=T, 
  cols=c('grey30','grey50','red'))
scrna <- subset(scrna, CD4v8 != 'DP')
```

## Run WNN Clustering on all cells
```{r}
scrna_output <- sct_umap(scrna, title='All cells')
scrna <- scrna_output$obj
plots <- c(plots, scrna_output$plots)

plots$combined_umap_2 <- (
  DimPlot(scrna, reduction = 'wnn.umap', label = TRUE, repel = TRUE, label.size = 2.5) + 
    NoLegend() +
  DimPlot(scrna, reduction = 'wnn.umap', group.by = 'CD4v8', label = TRUE, repel = TRUE, label.size = 2.5) + 
    NoLegend() +
  DimPlot(scrna, reduction = 'wnn.umap', group.by = 'k_type', label = TRUE, repel = TRUE, label.size = 2.5) + 
    NoLegend() +
  DimPlot(scrna, reduction = 'wnn.umap', group.by = 'Phase', label = TRUE, repel = TRUE, label.size = 2.5) + 
    NoLegend())
```

## Filter mixed CD4/CD8 clusters

```{r}
clust_cutoff_pct = 0.15
pct_cd8_clust <- data.table(scrna@meta.data)[, list(pct_cd8= sum(CD4v8 == 'CD8')/.N), by='seurat_clusters']

# cells in these clusters have mixed 4s and 8s
mixed_clusters <- pct_cd8_clust[pct_cd8 > clust_cutoff_pct & pct_cd8 < 1-clust_cutoff_pct]
scrna@meta.data$t_type_mixed <- scrna@meta.data$seurat_clusters %in% mixed_clusters$seurat_clusters

# these cells are 4s in 8-dominated clusters, and vice versa
scrna@meta.data$t_type_opposing <- scrna@meta.data$seurat_clusters %in% c(29,32,26,24)

# cells in these clusters have mixed 4s and 8s
mixed_clusters <- pct_cd8_clust[pct_cd8 > clust_cutoff_pct & pct_cd8 < 1-clust_cutoff_pct]
scrna@meta.data$t_type_mixed <- scrna@meta.data$seurat_clusters %in% mixed_clusters

# these cells are 4s in 8-dominated clusters, and vice versa

scrna@meta.data$t_type_opposing <- `|`(
  scrna@meta.data$seurat_clusters %in% pct_cd8_clust[pct_cd8 > 1-clust_cutoff_pct, seurat_clusters] & 
    scrna@meta.data$CD4v8 == 'CD4',
  scrna@meta.data$seurat_clusters %in% pct_cd8_clust[pct_cd8 < clust_cutoff_pct, seurat_clusters] & 
    scrna@meta.data$CD4v8 == 'CD8')

scrna <- subset(scrna, t_type_opposing == F)

SEURAT_HDF5_FILE <- here::here(
  '..','..','scrnaseq_tcsl154',
  'rds','scrna.wnn.all.clean.h5Seurat')
SaveH5Seurat(scrna, filename = SEURAT_HDF5_FILE, overwrite=T)

saveRDS(plots,
  here::here(
    '..','..','scrnaseq_tcsl154',
    'rds',
    paste0('scrna.wnn.all.clean.data.rds')))
```

## Cluster Correlations
```{r}
plots$scrna_dendro <- make_dendroheatmap(get_ident_avg(scrna))
```

## Run CD4/CD8 job subsets

Ran 06_run_subset_job.R with `t_type=CD4` and `t_type=CD8`, generating h5Seurat files in `/home/ec2-user/scrnaseq_tcsl154/rds`.

```{r}
rds_dir <- here::here('..','..','scrnaseq_tcsl154','rds')
scrna_cd4_all <- LoadH5Seurat(paste0(rds_dir, '/scrna.wnn.CD4.clean.h5Seurat'))
scrna_cd4 <- LoadH5Seurat(paste0(rds_dir, '/scrna.wnn.CD4.stim.clean.h5Seurat'))
scrna_cd8_all <- LoadH5Seurat(paste0(rds_dir, '/scrna.wnn.CD8.clean.h5Seurat'))
scrna_cd8 <- LoadH5Seurat(paste0(rds_dir, '/scrna.wnn.CD8.stim.clean.h5Seurat'))

#CD8
#map STIM to UNSTIM
scrna_cd8_all <- map_clusters(scrna_cd8, scrna_cd8_all, 'seurat_clusters', 'act_clusters')

cd8_act_avg <- get_ident_avg(scrna_cd8_all, ident='act_clusters')
cd8_mixed_avg <- get_ident_avg(scrna_cd8_all, ident='seurat_clusters')
#heatmap(cor(cd8_act_avg, cd8_mixed_avg))

#map old to new for both
scrna_cd8 <- map_clusters(
  readRDS(here::here('..','..','scrnaseq_tcsl154', 'rds','scrna.wnn.cd8.rds')),
  scrna_cd8, 'seurat_clusters', 'old_clusters')
scrna_cd8_all <- map_clusters(
  readRDS(here::here('..','..','scrnaseq_tcsl154', 'rds','scrna.wnn.cd8.rds')),
  scrna_cd8, 'seurat_clusters', 'old_clusters')

DimPlot(scrna_cd8, reduction='wnn.umap',group.by='old_clusters', label=T) + 
  DimPlot(scrna_cd8, reduction='wnn.umap',group.by='seurat_clusters', label=T)

cd8_act_clust_data <- plot_clust_by_act(scrna_cd8_all)


#CD4
#map STIM to UNSTIM
scrna_cd4_all <- map_clusters(scrna_cd4, scrna_cd4_all, 'seurat_clusters', 'act_clusters')

#map old to new for both
scrna_cd4 <- map_clusters(
  readRDS(here::here('..','..','scrnaseq_tcsl154', 'rds','scrna.wnn.cd4.rds')),
  scrna_cd4, 'seurat_clusters', 'old_clusters')

scrna_cd4_all <- map_clusters(
  readRDS(here::here('..','..','scrnaseq_tcsl154', 'rds','scrna.wnn.cd4.all.rds')),
  scrna_cd4_all, 'seurat_clusters', 'old_clusters')

```


```{r}


```