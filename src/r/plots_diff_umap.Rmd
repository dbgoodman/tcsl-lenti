---
title: "Differentiation Plots for Arrayed Screens"
output:
  html_document:
    df_print: paged
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = here::here('..','html'))})
---

# Load packages and umap functions
```{r}
library(ggplot2)
library(data.table)
library(scales)
library(RColorBrewer)
library(reticulate)
library(uwot)
library(gridExtra)
library(spatstat)
library(ggdendro)
library(cowplot)
library(tidyverse)
library(grid)
library(gridExtra) # add to AWS
library(cowplot) # add to AWS
library(slingshot) # add to AWS
library(viridis) # add to AWS
library(reshape2)
library(RColorBrewer)
library(ggrepel)
library(Hmisc)
library(ggcorrplot) 

source('umap.R')

use_condaenv(condaenv = 'r-reticulate', required = TRUE)
```

# Load data
```{r}
data_dir <- here::here('..','data')
load(file.path(data_dir, 'diff.sampled.Rdata'))
diff_dt <- fread(file.path(data_dir, 'diff.sampled.csv.gz'))

censor_negative_min = -1500
redo_umap_clustering = F
redo_umap_param_search = F

#only redo param search if doing clustering also:
redo_umap_clustering = redo_umap_clustering && redo_umap_clustering

# map day 0 to both plus and minus
map_day_0 <- function(df) {
  return(rbind(
    df[k562!='none'], #gets all cd19+-
    #df[rep(keep_none, .N) & k562=='none' & day > 0], 
    df[k562=='none' & day == 0][, k562 := 'cd19+'], #none and day 0, assign as 19+
    df[k562=='none' & day == 0][, k562 := 'cd19-'], #none and day 0, assign as 19-
    df[car =='untrans' & day != 0][, k562 := 'cd19+'], #add back untrans
    df[car =='untrans' & day != 0][, k562 := 'cd19-']
  ))
}
```

# Filter Data
```{r, eval=redo_umap_clustering}
#filter diff_dt by cd4/8 type, cd19+ (map day 0)

#cd4, cd19+, donor 
diff_dt_cd4 <- diff_dt %>% map_day_0() %>% filter(t_type == 'cd4', k562=='cd19+')

#cd8, cd19+, donor
diff_dt_cd8 <- diff_dt %>% map_day_0() %>% filter(t_type == 'cd8', k562=='cd19+')


## Remove car/day combinations that aren't in both donors, by t_type
cd4_matches <- plyr::match_df(diff_dt %>% map_day_0 %>% filter(t_type == 'cd4', donor == 2, k562=='cd19+') %>% filter(!is.na(event_id)) %>% distinct(car, day), diff_dt %>% map_day_0 %>% filter(t_type == 'cd4', donor == 1, k562=='cd19+') %>% filter(!is.na(event_id)) %>% distinct(car, day)) %>% arrange(day) #43 matches

cd8_matches <- plyr::match_df(diff_dt %>% map_day_0 %>% filter(t_type == 'cd8', donor == 2, k562=='cd19+') %>% filter(!is.na(event_id)) %>% distinct(car, day), diff_dt %>% map_day_0 %>% filter(t_type == 'cd8', donor == 1, k562=='cd19+') %>% filter(!is.na(event_id)) %>% distinct(car, day)) %>% arrange(day) #40 matches

#filter diff_dt by matched combinations
diff_dt_cd4 <- plyr::match_df(diff_dt_cd4, cd4_matches)
diff_dt_cd8 <- plyr::match_df(diff_dt_cd8, cd8_matches)

# remove day 33
diff_dt_cd4 <- diff_dt_cd4 %>% filter(!day == 33)
diff_dt_cd8 <- diff_dt_cd8 %>% filter(!day == 33)

```

## Double checking car/day combinations that aren't in both donors
```{r, eval=F}
diff_dt %>% map_day_0 %>% filter(t_type == 'cd4', donor == 1, k562=='cd19+') %>% filter(!is.na(event_id)) %>% distinct(car, day) %>% arrange(day)
#Donor 1 CD4: 43 combinations available (33 BAFF-R and CD28 missing)

diff_dt %>% map_day_0 %>% filter(t_type == 'cd8', donor == 1, k562=='cd19+') %>% filter(!is.na(event_id)) %>% distinct(car, day) %>% arrange(day)
#Donor 1 CD8: 40 combinations available (24 zeta, 33 zeta, BAFF-R, TACI, and KLRG1 missing)

diff_dt %>% map_day_0 %>% filter(t_type == 'cd4', donor == 2, k562=='cd19+') %>% filter(!is.na(event_id)) %>% distinct(car, day) %>% arrange(day)
#Donor 2 CD4: all 45 combinations available

diff_dt %>% map_day_0 %>% filter(t_type == 'cd8', donor == 2, k562=='cd19+') %>% filter(!is.na(event_id)) %>% distinct(car, day) %>% arrange(day)
#Donor 2 CD8: 42 combinations available (33 zeta and KLRG1 missing)
```

# UMAP

For now, skip straight to high dimensional plotting.

## UMAP Functions
```{r}
#grab channel map from cd4 data (cd4/8 are the same)
channel_map <- diff_opt_cd4$channel_map

# for now use all variables in the channel map except cd4/8
umap_vars <- c(paste0(names(channel_map),'_t'))

# removing zombie, cd_t, myc_t, gfp_t
umap_vars <- umap_vars[!umap_vars %in% c('cd_t', 'zombie_t', 'myc_t', 'gfp_t')]
```

## Run UMAP
Scaling this to 200 events per well and checking CAR/condition separation.

```{r, eval=redo_umap_clustering}
umap_cd4_fcs_dt <- run_umap(diff_dt_cd4, 0.005, 15, 1000, umap_vars)
umap_cd8_fcs_dt <- run_umap(diff_dt_cd8, 0.005, 15, 1000, umap_vars)

fwrite(umap_cd4_fcs_dt, 
  compress='gzip', 
  file=file.path(here::here('..','data','diff.sampled.umap_cd4.csv.gz')))

fwrite(umap_cd8_fcs_dt, 
  compress='gzip', 
  file=file.path(here::here('..','data','diff.sampled.umap_cd8.csv.gz')))

# sync output back to s3
system('aws s3 sync \\
  --exclude "*" \\
  --include "*.Rdata" \\
  --include "*.csv*" \\
  ~/local-tcsl/data s3://roybal-tcsl//lenti_screen_compiled_data/data')
```
## Cluster Analysis

### UMAP Plots
```{r, fig.width=15, fig.height=15}
#read in cd8 umap data
umap_cd8_fcs_dt <- fread(
  file.path(
    here::here('..','data','diff.sampled.umap_cd8.csv.gz')))
umap_cd8_fcs_dt[, cluster := factor(cluster)]

umap_cd8_cluster_dt <- umap_cd8_fcs_dt[, list(
  mean_umap_1= mean(umap_1), 
  mean_umap_2= mean(umap_2), 
  size= .N), by=cluster]

#read in cd4 umap data
umap_cd4_fcs_dt <- fread(
  file.path(
    here::here('..','data','diff.sampled.umap_cd4.csv.gz')))
umap_cd4_fcs_dt[, cluster := factor(cluster)]

umap_cd4_cluster_dt <- umap_cd4_fcs_dt[, list(
  mean_umap_1= mean(umap_1), 
  mean_umap_2= mean(umap_2), 
  size= .N), by=cluster]

#plot umap
#CD8
ggumap(umap_cd8_fcs_dt, umap_cd8_cluster_dt)

#CD4
ggumap(umap_cd4_fcs_dt, umap_cd4_cluster_dt)
```

### UMAP Color Plots
```{r, fig.width=15, fig.height=10}
#cd8
color_plots(umap_cd8_fcs_dt, umap_vars)

#cd4
color_plots(umap_cd4_fcs_dt, umap_vars)
```

## Temporal UMAP Visualizations 
### Contour Plots

#### All CARs
```{r, fig.width=15, fig.height=3}
#all cars by day
all_by_day(umap_cd8_fcs_dt)

all_by_day(umap_cd4_fcs_dt)
```

#### Individual CARs
```{r fig.width=22, fig.height=15}
#CD8
umap_contour_plots(umap_cd8_fcs_dt)

#CD4
umap_contour_plots(umap_cd4_fcs_dt)
```

## Grouped Cluster Plots 

```{r, fig.width=22, fig.height=30}
#CD8
all_plots(umap_cd8_fcs_dt, channel_map, umap_vars, 'CD8', dendro=F)

#CD4
all_plots(umap_cd4_fcs_dt, channel_map, umap_vars, 'CD4', dendro=F)
```

### Labeled Leiden Clusters Map
```{r fig.width=15, fig.height=8, eval=F}
# manually determined 
#CD8
cd8_diff_by_cluster <- data.frame("cluster" = c(1:20), "cell_type" = c('1-TN', '2-TN', '3-TEM', '4-TSCM (cd95-)', '5-TCM', '6-TEM', '7-TEMRA', '8-TEFF (cd27+)', '9-TEM', '10-TEM (cd27+)', '11-TN', '12-TEM', '13-TCM', '14-TEM', '15-TEM (cd27+)', '16-TN', '17-TEM', '18-TEM', '19-TEFF', '20-TN'))
cd8_diff_by_cluster$cluster <- as.factor(cd8_diff_by_cluster$cluster)
umap_cd8_fcs_dt <- left_join(umap_cd8_fcs_dt, cd8_diff_by_cluster, by='cluster')

#CD4
cd4_diff_by_cluster <- data.frame("cluster" = c(1:20), "cell_type" = c('1-TN', '2-TN', '3-TEM', '4-TSCM', '5-TEM', '6-TCM', '7-TEM (cd27+)', '8-TEMRA (cd62l+, cd27+)', '9-TEMRA', '10-TEMRA (cd61l+, cd27+)', '11-TEM (cd27+)', '12-TCM', '13-TEM', '14-TEMRA', '15-TEM (cd27+)', '16-TEM (cd27+)', '17-TEM', '18-TEMRA (cd27+)', '19-TEM', '20-TEM'))
cd4_diff_by_cluster$cluster <- as.factor(cd4_diff_by_cluster$cluster)
umap_cd4_fcs_dt <- left_join(umap_cd4_fcs_dt, cd4_diff_by_cluster, by='cluster')

#Labeled Leiden Clusters Map

#cd8
visualize_clusters_umap(umap_cd8_fcs_dt)

#cd4
visualize_clusters_umap(umap_cd4_fcs_dt)
```

## Batch Effect (Run when using both donors for UMAP)
```{r fig.width=20, fig.height=11}
# bar plot showing points per cluster by donor
batch_effect_bars <- function(umap_df) {
  umap_df %>% 
  group_by(cluster, car, day) %>% 
  count(donor) %>% rename(donor_count = n) %>% 
  group_by(cluster, donor) %>% 
  summarise(Sum = sum(donor_count)) %>% 
  ggplot(., aes(x=cluster, y=Sum, fill=factor(donor))) + 
  geom_bar(stat="identity", position = position_dodge()) + 
  theme_minimal() + 
  scale_fill_discrete(name="Donor", breaks=c("1", "2"), labels=c("Donor 1", "Donor 2"))
}

batch_effect_bars(umap_cd8_fcs_dt)

label_donor_umap <- umap_cd8_fcs_dt %>% group_by(donor) %>% select(umap_1, umap_2) %>% summarize_all(mean)
ggplot(umap_cd8_fcs_dt, aes(x=umap_1, y=umap_2, color=as.factor(donor)))+geom_point(size=0.1,alpha = 0.5, position=position_jitter(h=0.15,w=0.15))+theme(panel.grid.major = element_blank(), panel.grid.minor=element_blank())+geom_label(aes(label=donor), data=label_donor_umap, size=5)+guides(colour=FALSE)+ggtitle('UMAP by Donor') + scale_color_viridis(discrete=TRUE)+theme_minimal()

batch_effect_bars(umap_cd4_fcs_dt)

label_donor_umap_cd4 <- umap_cd4_fcs_dt %>% group_by(donor) %>% select(umap_1, umap_2) %>% summarize_all(mean)
ggplot(umap_cd4_fcs_dt, aes(x=umap_1, y=umap_2, color=as.factor(donor)))+geom_point(size=0.1,alpha = 0.5, position=position_jitter(h=0.15,w=0.15))+theme(panel.grid.major = element_blank(), panel.grid.minor=element_blank())+geom_label(aes(label=donor), data=label_donor_umap_cd4, size=5)+guides(colour=FALSE)+ggtitle('UMAP by Donor') + scale_color_viridis(discrete=TRUE)+theme_minimal()
```

## Correlation

```{r fig.width=15, fig.height=11, eval=F}
#cd8
biomarker_corr_by_day(umap_cd8_fcs_dt)
biomarker_corr_by_car(umap_cd8_fcs_dt)

#cd4
biomarker_corr_by_day(umap_cd4_fcs_dt)
biomarker_corr_by_car(umap_cd4_fcs_dt)
```





