---
title: "Differentiation Plots for Arrayed Screens"
output:
  html_document:
    df_print: paged
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = here::here('..','html'))})
---

# Load Data 
```{r}
library(ggplot2)
library(data.table)
library(scales)
library(RColorBrewer)
library(reticulate)
library(uwot)
library(gridExtra)
library(spatstat)
library(ggdendro)
library(cowplot)
library(tidyverse)
library(grid)
library(gridExtra) # add to AWS
library(cowplot) # add to AWS
#library(slingshot) # add to AWS
library(viridis) # add to AWS
library(reshape2)
library(RColorBrewer)
library(ggrepel)
use_condaenv(condaenv = 'r-reticulate', required = TRUE)

data_dir <- here::here('..','data')
load(file.path(data_dir, 'diff.sampled.Rdata'))
diff_dt <- fread(file.path(data_dir, 'diff.sampled.csv.gz'))

censor_negative_min = -1500
redo_umap_clustering = F
redo_umap_param_search = F

#only redo param search if doing clustering also:
redo_umap_clustering = redo_umap_clustering && redo_umap_clustering

# map day 0 to both plus and minus
map_day_0 <- function(df) {
  return(rbind(
    df[k562!='none'],
    df[k562=='none'][, k562 := 'cd19+'],
    df[k562=='none'][, k562 := 'cd19-']
  ))
}
```

# UMAP

For now, skip straight to high dimensional plotting.

## UMAP Functions
```{r}

#grab channel map from cd4 data (cd4/8 are the same)
channel_map <- diff_opt_cd4$channel_map

# for now use all variables in the channel map except cd4/8
# removing zombie, cd_t, myc_t, gfp_t
umap_vars <- c(paste0(names(channel_map),'_t'))
umap_vars <- umap_vars[!(umap_vars %in% c('cd_t', 'zombie_t', 'myc_t', 'gfp_t'))]

run_umap <- function(dt, chosen_dist, chosen_n_neighbor, sample_n, umap_vars,
    chosen_learning_rate=0.1) {
  
  umap_dt <- dt[!is.na(event_id), 
    .SD[event_id %in% sample(unique(event_id), 
      min(sample_n, length(unique(event_id))))],
    by=c('well', 'plate', 'day')]
  
  #grab channel map from cd4 data (cd4/8 are the same)
  #channel_map <- diff_opt_cd4$channel_map
  
  # for now use all variables in the channel map
  #umap_vars <- c(paste0(names(channel_map),'_t'))
  
  #cast it so variables are columns and
  #subset sample umap data on variables
  umap_cast_dt <- data.table(dcast(umap_dt, 
    event_id + well + plate + day + t_type ~ variable, 
    value.var='value'))
  
  umap_dt_in <- umap_cast_dt[, ..umap_vars]
  
  # scale each input column
  umap_dt_in[ , 
    (names(umap_dt_in)) := lapply(.SD, scale), .SDcols = names(umap_dt_in)]
  
  # run umap via uwot library
  umap_out <- umap(umap_dt_in, min_dist=chosen_dist,
      learning_rate=chosen_learning_rate,
      n_sgd_threads=1,
      n_neighbors=chosen_n_neighbor, 
      verbose=T, n_threads=8, n_trees=50,
      ret_nn=T)
  
  # nearest neighbors in original space
  nearest_neighbors <- umap_out$nn$euclidean$idx
  neighbor_dist <- umap_out$nn$euclidean$dist
  edge_weights <- scales::rescale(-neighbor_dist, to=c(0,1))
  edge_weights <- edge_weights - min(edge_weights)
  umap_out <- data.table(umap_out$embedding)
  
  #nearest neighbors in embedding
  # umap_nn <- cbind(1:nrow(umap_fcs_dt), 
  #     nnwhich(umap_fcs_dt[, list(umap_1, umap_2)], k=c(1:3)))
  # umap_nd <- cbind(rep(0, nrow(umap_fcs_dt)), 
  #     nndist(umap_fcs_dt[, list(umap_1, umap_2)], k=c(1:3)))
  # umap_ew <- scales::rescale(-umap_nd, to=c(0,1))
  # umap_ew <- umap_ew - min(umap_ew)
      
  # rename the columns
  names(umap_out) <- c('umap_1','umap_2')
  
  # add the umap output to the input dt
  umap_fcs_dt <- cbind(umap_cast_dt[, 1:length(names(umap_cast_dt))], umap_out)
  umap_fcs_dt[, id := 1:.N]
  
  # add back the annotations
  umap_fcs_dt <- unique(umap_dt[, 
    .(donor, car, k562, t_type, day, well, event_id)])[
      umap_fcs_dt, on=.(t_type,well,day,event_id)]
  
  source_python(here::here('py/leiden_clust.py'))
  clust_membership <- leiden_clust(nearest_neighbors,
    edge_weights=scales::rescale(-neighbor_dist, to=c(0,1)))
  umap_fcs_dt[, cluster := factor(clust_membership+1)]
  
  #renumber the clusters
  cluster_ranks <- umap_fcs_dt[, list(mean_day=mean(day)), by=cluster][, rank_day := rank(mean_day)]
  
  umap_fcs_dt <- umap_fcs_dt[cluster_ranks, on='cluster'][, c('cluster', 'rank_day') := list(rank_day, NULL)]
  
  return(umap_fcs_dt)
}

```

## Checking UMAP Param space

Scaling this to 200 events per well and checking CAR/condition separation.

### UMAP
```{r, eval=redo_umap_clustering}
umap_cd4_fcs_dt <- run_umap(diff_dt[t_type == 'cd4'], 0.005, 15, 800, umap_vars)
umap_cd8_fcs_dt <- run_umap(diff_dt[t_type == 'cd8'], 0.005, 15, 800, umap_vars)
```

## Cluster Analysis

One issue with these clusters is that they are not contiguous in the UMAP embedding:

```{r, fig.width=15, fig.height=12}
# umap_cd4_fcs_dt <- fread(
#   file.path(
#     here::here('..','data','diff.sampled.umap_cd4.csv.gz')))
# umap_cd8_fcs_dt[, cluster := factor(cluster)]

umap_cd4_cluster_dt <- umap_cd4_fcs_dt[, list(
  mean_umap_1= mean(umap_1), 
  mean_umap_2= mean(umap_2), 
  size= .N), by=cluster]

umap_cd8_cluster_dt <- umap_cd4_fcs_dt[, list(
  mean_umap_1= mean(umap_1), 
  mean_umap_2= mean(umap_2), 
  size= .N), by=cluster]

# whole plot
ggplot() + 
  geom_point(data=umap_cd4_cluster_dt, 
    aes(x=umap_1, y=umap_2, color=cluster), size=0.2, alpha=0.2) +
  geom_label(data=umap_cd8_cluster_dt, aes(
    x=mean_umap_1, y=mean_umap_2,
    label=paste(cluster,size,sep='\n'), 
    color=cluster), alpha=0.3) +
  theme_minimal()

# individual plots
ggplot() + 
  geom_point(data=umap_cd4_cluster_dt, 
    aes(x=umap_1, y=umap_2, color=cluster), size=0.2, alpha=0.2) +
  geom_label(data=umap_cd8_cluster_dt, aes(
    x=mean_umap_1, y=mean_umap_2,
    label=paste(cluster,size,sep='\n'), 
    color=cluster), alpha=0.3) +
  facet_wrap(~cluster) +
  theme_bw()
```
### CD4 UMAP Plot
```{r, fig.width=15, fig.height=12}
umap_cd4_fcs_dt <- fread(
  file.path(
    here::here('..','data','diff.sampled.umap_cd4.csv.gz')))
umap_cd4_fcs_dt[, cluster := factor(cluster)]

umap_cd4_cluster_dt <- umap_cd4_fcs_dt[, list(
  mean_umap_1= mean(umap_1), 
  mean_umap_2= mean(umap_2), 
  size= .N), by=cluster]

# whole plot
ggplot() + 
  geom_point(data=umap_cd4_fcs_dt, 
    aes(x=umap_1, y=umap_2, color=cluster), size=0.2, alpha=0.2) +
  geom_label(data=umap_cd4_cluster_dt, aes(
    x=mean_umap_1, y=mean_umap_2,
    label=paste(cluster,size,sep='\n'), 
    color=cluster), alpha=0.3) +
  theme_minimal()

# individual plots
ggplot() + 
  geom_point(data=umap_cd4_fcs_dt, 
    aes(x=umap_1, y=umap_2, color=cluster), size=0.2, alpha=0.2) +
  geom_label(data=umap_cd4_cluster_dt, aes(
    x=mean_umap_1, y=mean_umap_2,
    label=paste(cluster,size,sep='\n'), 
    color=cluster), alpha=0.3) +
  facet_wrap(~cluster) +
  theme_bw()
```

```{r, fig.width=30, fig.height=20}
color_plots <- function(umap_df) {
  cd4_colors = brewer.pal('Greens', n=9)[c(2,4,6,8,9)]
  cd8_colors = brewer.pal('Oranges', n=9)[c(2,4,6,8,9)]
  color_time <- ggplot(umap_df[][, cd19 := (k562=='cd19+')], 
      aes(x=umap_1, y=umap_2, color=interaction(day, t_type))) +
    geom_point(size=0.1, alpha=0.5) +
    facet_grid(car~cd19) +
    scale_color_manual(values=c(cd4_colors, cd8_colors)) +
    guides(colour = guide_legend(override.aes = list(alpha=1, size=3)))
  
  color_density <- ggplot(umap_df, aes(x=umap_1, y=umap_2)) +
    geom_hex(bins = 70) +
    facet_grid(car~cd19) +
    scale_fill_continuous(
      type = "viridis", limits=c(0,30), oob=scales::squish) +
    theme_bw()
  
  color_markers <- ggplot(
      melt(umap_df, measure.vars=umap_vars)[, 
        value.scaled := scale(value), by='variable'][,
          cd19 := (k562=='cd19+')], 
      aes(x=umap_1, y=umap_2, z=value.scaled)) +
    stat_summary_hex(bins = 70) +
    facet_grid(variable~cd19) +
    scale_fill_distiller(palette='RdYlBu', limits=c(-3, 3), oob=scales::squish) +
    theme_bw()
  
  grid.arrange(color_time, color_density, color_markers, ncol=3)
}

color_plots(umap_cd4_fcs_dt)
color_plots(umap_cd8_fcs_dt)

```

```{r, fig.width=15, fig.height=8}
dendrogram <- function(umap_fcs_dt, cell_type) {
  cluster_pct_vars <- c(paste0(
    names(channel_map),'_t'), 
    'FSC-A','SSC-A','donor','cd19')
  
  max_cluster <- max(as.numeric(umap_fcs_dt$cluster), na.rm=T)
  
  umap_var_melt_dt <-melt(
    umap_fcs_dt[!is.na(donor)], measure.vars= c(umap_vars,'donor', 'cd19', 'myc_t', 'gfp_t')) #add back in previously removed vars
  
  # Use z scale to plot params
  umap_var_melt_dt[, value_scaled := scale(value), by=variable]
  param_cluster_pct_dt <- umap_var_melt_dt[
    !is.na(cluster) & variable %in% cluster_pct_vars,
    list(
      clust_mean = mean(value_scaled),
      clust_sd = sd(value_scaled)),
        by=c('variable','cluster')]
  
  # Make dendrogram
  cluster_mean_cast <- dcast(
    param_cluster_pct_dt, 
    variable ~ cluster, 
    value.var='clust_mean')
  
  cluster_dendro_m <- as.matrix(cluster_mean_cast[, -c(1)])
  rownames(cluster_dendro_m) <- unlist(cluster_mean_cast[,1])
  dendro_clusters <- as.dendrogram(hclust(d = dist(x = t(cluster_dendro_m))))
  dendro_vars <- as.dendrogram(hclust(d = dist(x = cluster_dendro_m)))
  
  # Create dendrogram plot
  dendro_vars_plot <- ggdendrogram(data = dendro_vars, rotate = TRUE) + 
    theme(axis.text.y = element_text(size = 6))
  dendro_clusters_plot <- ggdendrogram(data = dendro_clusters, rotate = TRUE) + 
    theme(axis.text.y = element_text(size = 6))
  
  # column order
  cluster_order <- order.dendrogram(dendro_clusters)
  cluster_names <- colnames(cluster_dendro_m[, cluster_order])
  param_cluster_pct_dt[, cluster:= factor(cluster, levels = cluster_names)]
  
  # row order
  var_order <- order.dendrogram(dendro_vars)
  var_names <- row.names(cluster_dendro_m[var_order, ])
  param_cluster_pct_dt$variable <- factor(
      param_cluster_pct_dt$variable,
      levels = var_names)
  
   #annotate clusters as per variable values (removed gfp, myc, cd, donor)
  '%notin%' <- Negate('%in%')
  annotations <- param_cluster_pct_dt %>%
  mutate(variable=gsub("\\_t$", "", variable)) %>%
  filter(variable %notin% c('gfp','myc','cd','donor')) %>%
  mutate(cluster=as.character(cluster)) %>%
  group_by(cluster) %>% 
  mutate(rk = rank(-abs(clust_mean))) %>%
  filter(rk <= 3) %>% 
  arrange(cluster, rk) %>%
  mutate(variable = ifelse(clust_mean > 0, paste(variable,'+',sep = ""), paste(variable,'-',sep = ""))) %>%
  summarise(variable = paste(variable, collapse=", ")) %>% 
  data.table::transpose()
  colnames(annotations) <- as.character(unlist(annotations[1,]))
  annotations = annotations[-1, ]
  annotations <- annotations[cluster_names]
  row.names(annotations) <- NULL 
  
  # heatmap
  var_heatmap <- ggplot(param_cluster_pct_dt) + 
      geom_tile(aes(x=cluster, y=variable, fill=clust_mean), color='black') + geom_text(aes(x=cluster, y=variable, label=round(clust_mean, 2)), size=3, color='black') +
      scale_fill_distiller(palette='PiYG', limits=c(-3,3), oob=scales::squish) +
      theme_minimal() # + theme(axis.text.x = element_text(angle=90, hjust=1))

  # col dendro
  dendro_data_col <- dendro_data(dendro_clusters, type = "rectangle")
  dendro_col <- axis_canvas(var_heatmap, axis = "x") + 
      geom_segment(data = segment(dendro_data_col), 
          aes(x = x, y = y, xend = xend, yend = yend))
  plot_dendroheat <- insert_xaxis_grob(var_heatmap, 
              dendro_col, grid::unit(0.2, "null"), position = "top")
  dendro_plot <- ggdraw(plot_dendroheat) + draw_label(label=cell_type, x = 0.95, y = 0.95, hjust = 0.95, vjust = 0.95, size=40) 
  
  # annotation table
  tt <- ttheme_default(core=list(fg_params = list(fontsize=10), colhead=list(fg_params = list(fontsize=10, parse=TRUE))))
  annotations[1,] = str_wrap(annotations[1,], 0)
  tbl <- tableGrob(annotations, rows=NULL, theme=tt)
  # tbl <- strwrap(tbl, width = 10, simplify = FALSE)
  tbl$widths <- unit(rep(1/ncol(tbl), ncol(tbl)), "npc")
  
  # print plot and table
  return(list(grid.arrange(dendro_plot, tbl, nrow = 2, as.table = TRUE), cluster_names))
} 

#cd8
cd8_dendro <- dendrogram(umap_cd8_fcs_dt, 'cd8')
cd8_colnames <- cd8_dendro[[2]]

#cd4
cd4_dendro <- dendrogram(umap_cd4_fcs_dt, 'cd4')
cd4_colnames <- cd4_dendro[[2]]
```

### Percent of cells in cluster, by day

```{r, echo=F, fig.width=15, fig.height=8}
day_cluster_total <- function(umap_fcs_dt, cell_type, cluster_names) {
  day_cluster_total_pct_dt <- map_day_0(umap_fcs_dt)[,
    data.table(table(day,cluster, t_type, k562))][,
      list(cluster, pct=N/sum(N)), by=c('k562','day','t_type')]
  
  day_cluster_total_pct_dt[, cluster := factor(cluster, levels = cluster_names)]
  
  ggplot(day_cluster_total_pct_dt[k562=='cd19+'], aes(
      x=cluster, 
      y=factor(day, levels=c(0,6,15,24,33)), 
      fill=pct)) + 
    geom_tile(color='black') +
    geom_text(aes(label=round(pct*100)), size=3, color='white') +
    facet_grid(k562+t_type~., scales='free') +
    scale_fill_viridis_b('',direction=1, limits=c(0, 0.6)) +
    labs(title='Percent of cells in each day by cluster', y='Day',
      subtitle='(rows sum to 100%)') +
    theme_minimal() + ggtitle(paste('Percent of ',as.character(cell_type),' cells in each day by cluster'))
}

#cd8
#day_cluster_total(umap_cd8_fcs_dt, 'CD8', cd8_colnames)

#cd4
#day_cluster_total(umap_cd4_fcs_dt, 'CD4', cd4_colnames)

```

### CAR differences per cluster
#### summed across cols
```{r, echo=F, fig.width=15, fig.height=8}

car_per_day_per_cluster <- function(umap_fcs_dt, cell_type, cluster_names) {
  car_cluster_day_indiv_k562_pct_dt <- map_day_0(umap_fcs_dt)[,
    data.table(table(car,cluster,k562,t_type, day))][,
      list(car, pct=N/sum(N)), by=c('cluster','k562','t_type','day')][,
        pct_delta := scale(pct), by=c('cluster','k562','t_type', 'day')]
  
  car_cluster_day_indiv_k562_pct_dt[,
    cluster := factor(cluster, levels = cluster_names)]
  
  car_cluster_day_indiv_k562_pct_dt$day <- factor(car_cluster_day_indiv_k562_pct_dt$day, levels=c('0','6','15','24','33'))
  
  min_col <- brewer.pal(name='BrBG', n=11)[2]
  
  ggplot(car_cluster_day_indiv_k562_pct_dt[k562=='cd19+']) + 
      geom_tile(aes(x=cluster, y=car, fill=pct_delta), color='black') +
      facet_grid(day~k562, scales='free') +
      scale_fill_distiller('',
        palette='BrBG', 
        direction=1,
        #limits=c(-2.8, 2.8), 
        na.value=min_col) +
      labs(title='CAR enrichment\nper day per cluster', y='CAR',
        subtitle='CAR enrichment in cluster\n(z-score) (summed across cols)') +
      theme_minimal() + ggtitle(paste(as.character(cell_type),' CAR enrichment\nper day per cluster'))
}

#cd8
car_per_day_per_cluster(umap_cd8_fcs_dt, "CD8", cd8_colnames)

#cd4
car_per_day_per_cluster(umap_cd4_fcs_dt, "CD4", cd4_colnames)
```

```{r, echo=F, fig.width=15, fig.height=8}
car_per_day_per_cluster_total <- function(umap_fcs_dt, cell_type, cluster_names) {
  car_cluster_day_indiv_k562_total_pct_dt <- map_day_0(umap_fcs_dt)[,
    data.table(table(car,cluster,k562,t_type,day))][,
      list(cluster, pct=N/sum(N)), by=c('car','k562','t_type','day')][,
        pct_delta := scale(pct), by=c('car','k562','t_type','day')]
  
  car_cluster_day_indiv_k562_total_pct_dt[,
  cluster := factor(cluster, levels = cluster_names)]
  
  car_cluster_day_indiv_k562_total_pct_dt$day <- factor(car_cluster_day_indiv_k562_total_pct_dt$day, levels=c('0','6','15','24','33'))
  
  min_col <- brewer.pal(name='BrBG', n=11)[2]
  
  ggplot(car_cluster_day_indiv_k562_total_pct_dt[k562=='cd19+']) + 
      geom_tile(aes(x=cluster, y=car, fill=pct_delta), color='black') +
      facet_grid(day~k562, scales='free') +
      scale_fill_distiller('',
        palette='BrBG', 
        direction=1,
        #limits=c(-2.8, 2.8), 
        na.value=min_col) +
      labs(title='CAR enrichment\nper day per cluster', y='CAR',
        subtitle='CAR enrichment in cluster\n(z-score) (summed across rows)') +
      theme_minimal() + ggtitle(paste(as.character(cell_type),' CAR enrichment\nper day per cluster')) 
}

#cd8
#car_per_day_per_cluster_total(umap_cd8_fcs_dt, "CD8", cd8_colnames)

#cd4
#car_per_day_per_cluster_total(umap_cd4_fcs_dt, "CD4", cd4_colnames)
```

#### Bar charts showing how each CAR changes cluster by day
```{r fig.width=15, fig.height=8}

car_clusters_by_day <- function(umap_fcs_dt, cell_type, cluster_names) {
  car_cluster_day_indiv_k562_bar_pct_dt <- map_day_0(umap_fcs_dt)[,
    data.table(table(car,cluster,k562,t_type,day))][,
      list(day, pct=N/sum(N)), by=c('car','k562','t_type','cluster')][,
        pct_delta := scale(pct), by=c('car','k562','t_type','cluster')]
  
  car_cluster_day_indiv_k562_bar_pct_dt[,
  cluster := factor(cluster, levels = cluster_names)]
  
  car_cluster_day_indiv_k562_bar_pct_dt$day <- factor(car_cluster_day_indiv_k562_bar_pct_dt$day, levels=c('0','6','15','24','33'))
  
  #filter for CD19+, only CARs > 10% in a cluster in a given day
  car_cluster_day_indiv_k562_bar_pct_dt %>% 
    filter(k562=='cd19+', pct > 0.10) %>%
    ggplot() + geom_bar(aes(x=cluster, y=pct), color='black', stat='identity') +
      facet_grid(car~day, scales='free_x', space='free_x') +
      labs(title='CAR enrichment (>10%)\nper cluster per day', y='CAR',
        subtitle='CAR enrichment in cluster\n(absolute %) (summed across rows by cluster number)') + ggtitle(paste(as.character(cell_type),' CAR enrichment (>10%)\nper cluster per day'))
}

#cd8
car_clusters_by_day(umap_cd8_fcs_dt, "CD8", cd8_colnames)

#cd4
car_clusters_by_day(umap_cd4_fcs_dt, "CD4", cd4_colnames)
```

#### Bar charts showing distribution of each CAR in clusters per day 
```{r fig.width=15, fig.height=8}
car_clusters_by_square <- function(umap_fcs_dt, cell_type, cluster_names) {
  car_cluster_day_indiv_k562_total_pct_dt <- map_day_0(umap_fcs_dt)[,
      data.table(table(car,cluster,k562,t_type,day))][,
        list(cluster, pct=N/sum(N)), by=c('car','k562','t_type','day')][,
          pct_delta := scale(pct), by=c('car','k562','t_type','day')]
    
    car_cluster_day_indiv_k562_total_pct_dt[,
    cluster := factor(cluster, levels = cluster_names)]
    
    car_cluster_day_indiv_k562_total_pct_dt$day <- factor(car_cluster_day_indiv_k562_total_pct_dt$day, levels=c('0','6','15','24','33'))
  #filter for  CD19+, only CARs > 10% in a cluster in a given day
  car_cluster_day_indiv_k562_total_pct_dt %>% 
    filter(k562=='cd19+', pct>.10) %>%
    ggplot() + geom_bar(aes(x=cluster, y=pct), color='black', stat='identity') +
      facet_grid(car~day, scales='free_x', space='free_x') +
      labs(title='CAR enrichment (>10%)\nper day per cluster', y='CAR',
        subtitle='CAR enrichment in cluster\n(z-score) (summed across CAR x day (each square))') + ggtitle(paste(as.character(cell_type),' CAR enrichment (>10%)\nper day per cluster'))
}

#cd8
car_clusters_by_square(umap_cd8_fcs_dt, "CD8", cd8_colnames)

#cd4
car_clusters_by_square(umap_cd4_fcs_dt, "CD4", cd4_colnames)

```

## Grouped Plots

### CD8 Cluster Plots
```{r, fig.width=15, fig.height=30}
  all_plots <- function(umap_fcs_dt, cell_type, dendro=T) {
  cluster_pct_vars <- c(paste0(
    names(channel_map),'_t'), 
    'FSC-A','SSC-A','donor','cd19')
  
    max_cluster <- max(as.numeric(umap_fcs_dt$cluster), na.rm=T)
  
  umap_fcs_dt[, cluster:= factor(cluster, levels = as.character(1:max_cluster))]
  
  
  umap_var_melt_dt <-melt(
    umap_fcs_dt[!is.na(donor)], measure.vars= c(umap_vars,'donor', 'cd19', 'myc_t', 'gfp_t')) #add back in previously removed vars
  
  # Use z scale to plot params
  umap_var_melt_dt[, value_scaled := scale(value), by=variable]
  param_cluster_pct_dt <- umap_var_melt_dt[
    !is.na(cluster) & variable %in% cluster_pct_vars,
    list(
      clust_mean = mean(value_scaled),
      clust_sd = sd(value_scaled)),
        by=c('variable','cluster')]
  
  if (dendro) {
    # Make dendrogram
    cluster_mean_cast <- dcast(
      param_cluster_pct_dt, 
      variable ~ cluster, 
      value.var='clust_mean')
    
    cluster_dendro_m <- as.matrix(cluster_mean_cast[, -c(1)])
    rownames(cluster_dendro_m) <- unlist(cluster_mean_cast[,1])
    dendro_clusters <- as.dendrogram(hclust(d = dist(x = t(cluster_dendro_m))))
    dendro_vars <- as.dendrogram(hclust(d = dist(x = cluster_dendro_m)))
    
    # Create dendrogram plot
    dendro_vars_plot <- ggdendrogram(data = dendro_vars, rotate = TRUE) + 
      theme(axis.text.y = element_text(size = 6))
    dendro_clusters_plot <- ggdendrogram(data = dendro_clusters, rotate = TRUE) + 
      theme(axis.text.y = element_text(size = 6))
    
    # column order
    cluster_order <- order.dendrogram(dendro_clusters)
    cluster_names <- colnames(cluster_dendro_m[, cluster_order])
    param_cluster_pct_dt[, cluster:= factor(cluster, levels = cluster_names)]
    
    # row order
    var_order <- order.dendrogram(dendro_vars)
    var_names <- row.names(cluster_dendro_m[var_order, ])
    param_cluster_pct_dt$variable <- factor(
        param_cluster_pct_dt$variable,
        levels = var_names)
  } else {
    param_cluster_pct_dt[, cluster:= factor(cluster, levels = as.character(1:max_cluster))]
  }
  
   #annotate clusters as per variable values (removed gfp, myc, cd, donor)
  '%notin%' <- Negate('%in%')
  annotations <- param_cluster_pct_dt %>%
  mutate(variable=gsub("\\_t$", "", variable)) %>%
  filter(variable %notin% c('gfp','myc','cd','donor')) %>%
  mutate(cluster=as.character(cluster)) %>%
  group_by(cluster) %>% 
  mutate(rk = rank(-abs(clust_mean))) %>%
  filter(rk <= 3) %>% 
  arrange(cluster, rk) %>%
  mutate(variable = ifelse(clust_mean > 0, paste(variable,'+',sep = ""), paste(variable,'-',sep = ""))) %>%
  summarise(variable = paste(variable, collapse=", ")) %>% 
  data.table::transpose()
  colnames(annotations) <- as.character(unlist(annotations[1,]))
  annotations = annotations[-1, ]
  if (dendro) {
    annotations <- annotations[cluster_names]
  } else {
    annotations <- annotations[as.character(1:max_cluster)]
  }
  row.names(annotations) <- NULL 
  
  # heatmap
  var_heatmap <- ggplot(param_cluster_pct_dt) + 
      geom_tile(aes(x=cluster, y=variable, fill=clust_mean), color='black') + 
      geom_text(aes(x=cluster, y=variable, label=round(clust_mean, 2)), size=3, color='black') +
      scale_fill_distiller(palette='PiYG', limits=c(-3,3), oob=scales::squish) +
      theme_minimal() # + theme(axis.text.x = element_text(angle=90, hjust=1))

  # col dendro
  if (dendro) {
    dendro_data_col <- dendro_data(dendro_clusters, type = "rectangle")
    dendro_col <- axis_canvas(var_heatmap, axis = "x") + 
        geom_segment(data = segment(dendro_data_col), 
            aes(x = x, y = y, xend = xend, yend = yend))
    plot_dendroheat <- insert_xaxis_grob(var_heatmap, 
                dendro_col, grid::unit(0.2, "null"), position = "top")
    dendro_plot <- ggdraw(plot_dendroheat)
  }
  
  # annotation table
  tt <- ttheme_default(core=list(fg_params = list(fontsize=10), colhead=list(fg_params = list(fontsize=10, parse=TRUE))))
  annotations[1,] = str_wrap(annotations[1,], 0)
  tbl <- tableGrob(annotations, rows=NULL, theme=tt)
  # tbl <- strwrap(tbl, width = 10, simplify = FALSE)
  tbl$widths <- unit(rep(1/ncol(tbl), ncol(tbl)), "npc")
  
  # CLUSTERS BY DAY
  day_cluster_total_pct_dt <- map_day_0(umap_fcs_dt)[,
    data.table(table(day,cluster, t_type, k562))][,
      list(cluster, pct=N/sum(N)), by=c('k562','day','t_type')]
  
  if (dendro) {
    day_cluster_total_pct_dt[, cluster := factor(cluster, levels = cluster_names)]
  } else {
    day_cluster_total_pct_dt[, cluster := factor(cluster, levels = as.character(1:max_cluster))]
  }
  
  clusters_by_day <- ggplot(day_cluster_total_pct_dt[k562=='cd19+'], aes(
      x=cluster, 
      y=factor(day, levels=c(0,6,15,24,33)), 
      fill=pct)) + 
    geom_tile(color='black') +
    geom_text(aes(label=round(pct*100)), size=3, color='white') +
    facet_grid(k562+t_type~., scales='free') +

    scale_fill_viridis_c('',direction=1, limits=c(0, 0.6)) +
    labs(title='Percent of cells in each day by cluster', y='Day',
      subtitle='(rows sum to 100%)') +
    theme_minimal() + ggtitle(paste('Percent of ',as.character(cell_type),' cells in each day by cluster'))

  # CARs BY CLUSTER/DAY
  car_cluster_day_indiv_k562_total_pct_dt <- map_day_0(umap_fcs_dt)[,
    data.table(table(car,cluster,k562,t_type,day))][,
      list(cluster, pct=N/sum(N)), by=c('car','k562','t_type','day')][,
        pct_delta := scale(pct), by=c('car','k562','t_type','day')]
  
  if (dendro) {
    car_cluster_day_indiv_k562_total_pct_dt[, cluster := factor(cluster, levels = cluster_names)] 
  } else {
    car_cluster_day_indiv_k562_total_pct_dt[, cluster := factor(cluster, levels = as.character(1:max_cluster))]
  }
  
  car_cluster_day_indiv_k562_total_pct_dt$day <- factor(car_cluster_day_indiv_k562_total_pct_dt$day, levels=c('0','6','15','24','33'))
  
  min_col <- brewer.pal(name='BrBG', n=11)[2]
  
  cars_by_cluster <- ggplot(car_cluster_day_indiv_k562_total_pct_dt[k562=='cd19+']) + 
      geom_tile(aes(x=cluster, y=car, fill=pct_delta), color='black') +
      facet_grid(day~k562, scales='free') +
      scale_fill_distiller('',
        palette='BrBG', 
        direction=1,
        #limits=c(-2.8, 2.8), 
        na.value=min_col) +
      labs(title='CAR enrichment\nper day per cluster', y='CAR',
        subtitle='CAR enrichment in cluster\n(z-score) (summed across rows)') +
      theme_minimal() + ggtitle(paste(as.character(cell_type),' CAR enrichment\nper day per cluster')) 
  
  # print all plots and table
  plot_grid(var_heatmap, clusters_by_day, cars_by_cluster, tbl, labels = c('A', 'B', 'C', 'D'), nrow=4, rel_heights = c(1/8, 1/8, 1/2, 1/8))
} 

all_plots(umap_cd8_fcs_dt, 'CD8', dendro=F)
```

### CD4 Cluster Plots
```{r, fig.width=15, fig.height=30}
all_plots(umap_cd4_fcs_dt, 'CD4')
```
## Pseudotime Analysis

### CD8 - prepare data
```{r fig.width=15, fig.height=11}
# cluster labels
clusterLabels_cd8 <- as.vector(umap_cd8_fcs_dt$cluster)

# reduced dimensional matrix
rd_matrix_cd8 <- umap_cd8_fcs_dt %>% remove_rownames %>% column_to_rownames(var="id") %>% select(umap_1, umap_2) %>% as.matrix()

# get lineages, set clusters 5,6,10 as start and 13,8,11 as end (based on above cluster plot B)
lin_cd8_path1 <- getLineages(rd_matrix_cd8, clusterLabels_cd8, start.clus = '5', end.clus = '11')
lin_cd8_path2 <- getLineages(rd_matrix_cd8, clusterLabels_cd8, start.clus = '5', end.clus = '8')
lin_cd8_path3 <- getLineages(rd_matrix_cd8, clusterLabels_cd8, start.clus = '5', end.clus = '13')
lin_cd8_path4 <- getLineages(rd_matrix_cd8, clusterLabels_cd8, start.clus = '6', end.clus = '11')
lin_cd8_path5 <- getLineages(rd_matrix_cd8, clusterLabels_cd8, start.clus = '6', end.clus = '8')
lin_cd8_path6 <- getLineages(rd_matrix_cd8, clusterLabels_cd8, start.clus = '6', end.clus = '13')
lin_cd8_path7 <- getLineages(rd_matrix_cd8, clusterLabels_cd8, start.clus = '10', end.clus = '11')
lin_cd8_path8 <- getLineages(rd_matrix_cd8, clusterLabels_cd8, start.clus = '10', end.clus = '8')
lin_cd8_path9 <- getLineages(rd_matrix_cd8, clusterLabels_cd8, start.clus = '10', end.clus = '13')



# assign colors to each cluster (because slingshot does not support ggplot)
cell_pal <- function(cell_vars, pal_fun,...) {
  if (is.numeric(cell_vars)) {
    pal <- pal_fun(100, ...)
    return(pal[cut(cell_vars, breaks = 100)])
  } else {
    categories <- sort(unique(cell_vars))
    pal <- setNames(pal_fun(length(categories), ...), categories)
    return(pal[cell_vars])
  }
}
cell_colors_clust_cd8 <- cell_pal(clusterLabels_cd8, hue_pal())
```

```{r}
# plot lineages
plot_lineages <- function(lin_path, cluster_start, cluster_end) {
  plot(rd_matrix_cd8, col = cell_colors_clust_cd8, pch = 16, cex = 0.5, main=paste('Start:' ,as.character(cluster_start),' End:', as.character(cluster_end)))
  lines(lin_path, lwd = 2, type = 'lineages', col = 'black', show.constraints = TRUE)
}

#1
plot_lineages(lin_cd8_path1, '5','11')

#2
plot_lineages(lin_cd8_path2, '5','8')

#3
plot_lineages(lin_cd8_path3, '5','13')

#4
plot_lineages(lin_cd8_path4, '6','11')

#5
plot_lineages(lin_cd8_path5, '6','8')

#6
plot_lineages(lin_cd8_path6, '6','13')

#7
plot_lineages(lin_cd8_path7, '10','11')

#8
plot_lineages(lin_cd8_path8, '10','8')

#9
plot_lineages(lin_cd8_path9, '10','13')



```



### CD8 Fit curve (This takes a long time)
```{r}
# get smooth curves for lineages
crv_cd8_path1 <- getCurves(lin_cd8_path1, approx_points=25)

# compute the rest of these later
#crv_cd8_path2 <- getCurves(lin_cd8_path2, approx_points=10)

#crv_cd8_path3 <- getCurves(lin_cd8_path3, approx_points=10)

#crv_cd8_path4 <- getCurves(lin_cd8_path4, approx_points=10)

#crv_cd8_path5 <- getCurves(lin_cd8_path5, approx_points=10)

#crv_cd8_path6 <- getCurves(lin_cd8_path6, approx_points=10)

#crv_cd8_path7 <- getCurves(lin_cd8_path7, approx_points=10)

#crv_cd8_path8 <- getCurves(lin_cd8_path8, approx_points=10)

#crv_cd8_path9 <- getCurves(lin_cd8_path9, approx_points=10)
```

```{r}
# save the trajectory inference data
save(crv_cd8_path1, file=file.path(here::here('..','data','diff.sampled.umap_cd8_trajectory.Rdata')))

# sync output back to s3
system('aws s3 sync \\
  --exclude "*" \\
  --include "*.Rdata" \\
  --include "*.csv*" \\
  ~/local-tcsl/data s3://roybal-tcsl//lenti_screen_compiled_data/data')
```

### load trajectory data
```{r}
load(file.path(data_dir, 'diff.sampled.umap_cd8_trajectory.Rdata'))
```

### CD8 trajectory plots
```{r}
# plot trajectory on umap alongside original umap
plot(rd_matrix_cd8, col = cell_colors_clust_cd8, pch = 16, cex = 0.5)
lines(crv_cd8_path1, lwd = 2, type = 'lineages', col = 'black', show.constraints = TRUE)
```

```{r}
# Psuedotime values for each lineage
nc <- 3
pt <- slingPseudotime(crv_cd8_path1)
nms <- colnames(pt)
nr <- ceiling(length(nms)/nc)
pal <- viridis(100, end = 0.95)
par(mfrow = c(nr, nc))
for (i in nms) {
  colors <- pal[cut(pt[,i], breaks = 100)]
  plot(reducedDim(lin_cd8_path1), col = colors, pch = 16, cex = 0.5, main = i)
  lines(crv_cd8_path1, lwd = 2, col = 'black', type = 'lineages')
}
```

### Visualize parameters on umap
```{r}
viz.umap <- function(dat,dr,param.name,limits=NULL){
  ColVal <- pull(dat %>% select(param.name))
  if(is.null(limits)){
    Lim <- quantile(ColVal,probs=seq(0,1,0.01))[c(2,100)]
    p <- ggplot(dat, aes(x = umap_1, y =umap_2)) +geom_point(aes(color = ColVal), size=0.1)+theme_classic()+scale_color_distiller(name=param.name, palette = "RdYlBu", limits=Lim, oob=squish)+theme_bw()+theme(panel.grid.major = element_blank(), panel.grid.minor=element_blank())+ggtitle(param.name)
  } else {
    p <- ggplot(dat, aes(x = umap_1, y = umap_2)) +geom_point(aes(color = ColVal), size=0.1)+theme_classic()+scale_color_distiller(name=param.name, palette = "RdYlBu", limits=c(limits[1],limits[2]), oob=squish)+theme_bw()+theme(panel.grid.major = element_blank(), panel.grid.minor=element_blank())+ggtitle(param.name)
  }
  p
}
```

#### CD8 markers 
```{r}
param_test <- colnames(umap_cd8_fcs_dt)[c(7, 9:13)]

as.data.frame(umap_cd8_fcs_dt)[, param_test]

#function to visualize diffusion map
visualize_params_umap <- function(df) {
  parameters <- colnames(df)[c(7, 9:13)]
  for (i in 1:length(parameters)) {
  p <- viz.umap(dat=df, param.name=parameters[i])
  print(p)
  }
}

visualize_params_umap(umap_cd8_fcs_dt)
```

#### visualize leiden clusters on umap (CD8)
```{r}
visualize_clusters_umap <- function(df) {
  label_clusters_umap <- df %>% group_by(cluster) %>% select(umap_1, umap_2) %>% summarize_all(mean)
  ggplot(df, aes(x=umap_1, y=umap_2, color=as.factor(cluster)))+geom_point(size=0.1)+theme_bw()+theme(panel.grid.major = element_blank(), panel.grid.minor=element_blank())+geom_label_repel(aes(label=cluster), data=label_clusters_umap)+guides(colour=FALSE)+ggtitle('Leiden clusters')
}
  
visualize_clusters_umap(umap_cd8_fcs_dt)
```

#### visualize days UMAP
```{r}
visualize_days_umap <- function(df) {
  label_days_umap <- df %>% group_by(day) %>% select(umap_1, umap_2) %>% summarize_all(mean)
  ggplot(df, aes(x=umap_1, y=umap_2, color=as.factor(day)))+geom_point(size=0.1)+theme_bw()+theme(panel.grid.major = element_blank(), panel.grid.minor=element_blank())+geom_label_repel(aes(label=day), data=label_days_umap)+guides(colour=FALSE)+ggtitle('UMAP by Day')
}

visualize_days_umap(umap_cd8_fcs_dt)

```

#### visualize CARS UMAP
```{r fig.width=15, fig.height=11}
visualize_cars_umap <- function(df) {
  label_cars_umap <- df %>% group_by(car) %>% select(umap_1, umap_2) %>% summarize_all(mean)
  ggplot(df, aes(x=umap_1, y=umap_2, color=as.factor(car)))+geom_point(size=0.1)+theme_bw()+theme(panel.grid.major = element_blank(), panel.grid.minor=element_blank(), legend.title = element_blank()) + guides(colour = guide_legend(override.aes = list(size=5)))
}

#ALL CARS
plot_grid(umap_cd8_fcs_dt %>% filter(day==0) %>% visualize_cars_umap()
, umap_cd8_fcs_dt %>% filter(day==6) %>% visualize_cars_umap(), umap_cd8_fcs_dt %>% filter(day==15) %>% visualize_cars_umap(), umap_cd8_fcs_dt %>% filter(day==24) %>% visualize_cars_umap(), umap_cd8_fcs_dt %>% filter(day==33) %>% visualize_cars_umap(), labels = c('Day 0', 'Day 6', 'Day 15', 'Day 24', 'Day 33'), nrow=3)

# Day 0
#umap_cd8_fcs_dt %>% filter(day==0) %>% visualize_cars_umap()

# Day 6
#umap_cd8_fcs_dt %>% filter(day==6) %>% visualize_cars_umap()

# Day 15
#umap_cd8_fcs_dt %>% filter(day==15) %>% visualize_cars_umap()

# Day 24
#umap_cd8_fcs_dt %>% filter(day==24) %>% visualize_cars_umap()

# Day 33
#umap_cd8_fcs_dt %>% filter(day==33) %>% visualize_cars_umap()


#41BB
cars_by_day_umap <- function(car_type) {
plot_grid(car_type %>% filter(day==0) %>% visualize_cars_umap()
, car_type %>% filter(day==6) %>% visualize_cars_umap(), car_type %>% filter(day==15) %>% visualize_cars_umap(), car_type %>% filter(day==24) %>% visualize_cars_umap(), car_type %>% filter(day==33) %>% visualize_cars_umap(), labels = c('Day 0', 'Day 6', 'Day 15', 'Day 24', 'Day 33'), nrow=3)
}

umap_cd8_41bb <- umap_cd8_fcs_dt %>% filter(car=='41BB')
cars_by_day_umap(umap_cd8_41bb)


#BAFFR
umap_cd8_baffr <- umap_cd8_fcs_dt %>% filter(car=='BAFF-R')
cars_by_day_umap(umap_cd8_baffr)

#CD28
umap_cd8_cd28 <- umap_cd8_fcs_dt %>% filter(car=='CD28')
cars_by_day_umap(umap_cd8_cd28)

#CD40
umap_cd8_cd40 <- umap_cd8_fcs_dt %>% filter(car=='CD40')
cars_by_day_umap(umap_cd8_cd40)

#KLGR1
umap_cd8_klrg1 <- umap_cd8_fcs_dt %>% filter(car=='KLRG1')
cars_by_day_umap(umap_cd8_klrg1)

#TACI
umap_cd8_taci <- umap_cd8_fcs_dt %>% filter(car=='TACI')
cars_by_day_umap(umap_cd8_taci)

#TNR8
umap_cd8_tnr8 <- umap_cd8_fcs_dt %>% filter(car=='TNR8')
cars_by_day_umap(umap_cd8_tnr8)

#untransduced
umap_cd8_untrans <- umap_cd8_fcs_dt %>% filter(car=='untrans')
cars_by_day_umap(umap_cd8_untrans)

#zeta
umap_cd8_zeta <- umap_cd8_fcs_dt %>% filter(car=='zeta')
cars_by_day_umap(umap_cd8_zeta)

```


#### cd8 frequencies
```{r}
# Calculate the percentage of a certain sample (donor) present in a certain cluster
visualize_counts <- function(df) {
  counts <- as.data.frame.matrix(table(df$donor,df$cluster))
  counts_percofsample = counts/rowSums(counts)*100
  counts_percofsample$total <- rowSums(counts)
  counts_percofsample$donor <- row.names(counts_percofsample)
  counts_percofsample <- melt(counts_percofsample,  id.vars=c('donor', 'total'), variable.name='cluster', value.name='frequency')
  ggplot(counts_percofsample, aes(x=reorder(cluster, frequency, FUN=median), y=frequency))+ geom_boxplot(position='dodge2', outlier.shape=NA)+geom_jitter(aes(colour=donor), size=2)+xlab('cluster')+ggtitle(" frequency = % of sample in cluster")
}

as.data.frame.matrix(table(umap_cd8_fcs_dt$donor,umap_cd8_fcs_dt$cluster))

umap_cd8_fcs_dt$donor %>% head()
visualize_counts(umap_cd8_fcs_dt)
```

#### visualize psuedotime (CD8)
```{r}
umap_cd8_fcs_pseudotime_dt <- cbind(umap_cd8_fcs_dt, slingPseudotime(crv_cd8_path1) %>% as.data.frame())

pseudotimevalues <- umap_cd8_fcs_pseudotime_dt %>% select(c(umap_1, umap_2, cluster, curve1, curve2, curve3, curve4))

#reshape table 
pseudotimevalues <- melt(pseudotimevalues, id.vars=c('cluster', 'umap_1', 'umap_2'), variable.name='lineage', value.name = 'pseudotime')

#rename curve to lineage
pseudotimevalues$lineage <- gsub('curve','lineage', pseudotimevalues$lineage)

#exclude cells with NA pseudotimevalues (those cells are not present in all lineages and have NA values for the lineages in which they are absent)
pseudotimevaluesexclNA <- pseudotimevalues%>%filter(pseudotime!='NA')

#generate colorpalette
colors <- colorRampPalette(rev(brewer.pal(11, 'Spectral'))[-6])(100)

# plot lineages: cells are colored by psuedotime
ggplot(pseudotimevaluesexclNA%>%arrange(pseudotime), aes(x=umap_1, y=umap_2))+geom_point(aes(color=pseudotime),size=0.1, alpha=0.3) +facet_wrap(~lineage)+scale_color_gradientn(colours=colors)+theme_bw()+theme(panel.grid.major = element_blank(), panel.grid.minor=element_blank())

# plot lineages: cells are colorted by cluster
ggplot(pseudotimevaluesexclNA%>%arrange(pseudotime), aes(x=umap_1, y=umap_2))+geom_point(aes(color=cluster),size =0.1)+facet_wrap(~lineage)+theme_bw()+ guides(colour = guide_legend(override.aes = list(size=5)))

# jitterplot per lineage: cells are colored by cluster
ggplot(pseudotimevaluesexclNA%>%arrange(pseudotime), aes(x=pseudotime, y=lineage)) + geom_jitter(aes(color=cluster), size=0.1)+theme_bw()+theme(panel.grid.major = element_blank(), panel.grid.minor=element_blank())+ guides(colour = guide_legend(override.aes = list(size=5)))
```


### CD4 - prepare data
```{r fig.width=15, fig.height=11}
# cluster labels
clusterLabels_cd4 <- as.vector(umap_cd4_fcs_dt$cluster)

# reduced dimensional matrix
rd_matrix_cd4 <- umap_cd4_fcs_dt %>% remove_rownames %>% column_to_rownames(var="id") %>% select(umap_1, umap_2) %>%  as.matrix()

# get lineages, set cluster 14 as the start (since likely naive T cells)
lin_cd4 <- getLineages(rd_matrix_cd4, clusterLabels_cd4, start.clus = '6')

cell_colors_clust_cd4 <- cell_pal(clusterLabels_cd4, hue_pal())
# plot lineage (without curves)
plot(rd_matrix_cd4, col = cell_colors_clust_cd4, pch = 16, cex = 0.5)
lines(lin_cd4, lwd = 2, type = 'lineages', col = 'black', show.constraints = TRUE)

lin_cd4
```

### CD4 Fit curve (This isn't working yet) - normally approx_points=100, but both 100 and even 50 currently crashing

```{r}
# get smooth curves for lineages
# crv_cd4 <- getCurves(lin_cd4, approx_points=50) 
```

#### CD4 markers

#### visualize params on umap (CD4)
```{r}
visualize_params_umap(umap_cd4_fcs_dt)
```

#### visualize leiden clusters on umap (CD4)
```{r}
visualize_clusters_umap(umap_cd4_fcs_dt)
```

#### cd4 frequencies 
```{r}
visualize_counts(umap_cd4_fcs_dt)
```