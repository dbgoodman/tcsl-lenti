---
title: "PCA Analysis for Differentiation Samples"
output:
  html_document:
    df_print: paged
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = here::here('..','html'))})
---


# Load Data 
```{r}
library(ggplot2)
library(data.table)
library(scales)
library(RColorBrewer)
library(reticulate)
#library(uwot)
library(gridExtra)
#library(spatstat)
#use_condaenv(condaenv = 'r-reticulate', required = TRUE)
library(ggsci)

data_dir <- here::here('..','data')
load(file.path(data_dir, 'diff.sampled.Rdata'))
#diff_dt <- fread(file.path(data_dir, 'diff.sampled.csv.gz'))

# # map day 0 to both plus and minus
# map_day_0 <- function(df) {
#   return(rbind(
#     df[k562!='none'],
#     df[k562=='none'][, k562 := 'cd19+'],
#     df[k562=='none'][, k562 := 'cd19-']
#   ))
# }
```

# PCA
```{r}

diff_means_dt <- diff_dt[!is.na(day) & !is.na(donor) & !is.na(value), 
  list(m= mean(value), sd= sd(value), n= .N), 
  by=c('day','donor','car','k562','t_type','variable')]


diff_cast_dt <- dcast(diff_means_dt[!is.na(m) & n > 20], 
  day + donor + car + k562 + t_type ~ variable, 
  value.var=c('m','sd'))


diff_pca <- prcomp(diff_cast_dt[,-c(1:5)], scale. = T, center = T)


ggplot(data.table(diff_pca$x), aes(x=PC1, y=PC2)) + geom_point()


# getting pca for cd19+ only, cd4 only, cd8 only with sd
cd19_cast_dt <- diff_cast_dt[k562=='cd19+']
cd4_cast_dt <- diff_cast_dt[t_type=='cd4']
cd8_cast_dt <- diff_cast_dt[t_type=='cd8']

cd19_pca <- prcomp(cd19_cast_dt[,-c(1:5)], scale. = T, center = T)
cd4_pca <- prcomp(cd4_cast_dt[,-c(1:5)], scale. = T, center = T)
cd8_pca <- prcomp(cd8_cast_dt[,-c(1:5)], scale. = T, center = T)


# cbind these pca with original table
diff_cbind_dt <- cbind(diff_cast_dt, data.table(diff_pca$x))
cd19_cbind_dt <- cbind(cd19_cast_dt, data.table(cd19_pca$x))
cd4_cbind_dt <- cbind(cd4_cast_dt, data.table(cd4_pca$x))
cd8_cbind_dt <- cbind(cd8_cast_dt, data.table(cd8_pca$x))


# plot these altogether w/ gridExtra
a <- ggplot(diff_cbind_dt, aes(x=PC1, y=PC2)) + 
  geom_point(aes(color=car, shape=k562, alpha=as.factor(donor))) +
  labs(title='general PCA')
b <- ggplot(cd19_cbind_dt, aes(x=PC1, y=PC2)) + 
  geom_point(aes(color=car, shape=k562, alpha=as.factor(donor))) +
  labs(title='CD19+ only PCA')
c <- ggplot(cd4_cbind_dt, aes(x=PC1, y=PC2)) + 
  geom_point(aes(color=car, shape=k562, alpha=as.factor(donor))) +
  labs(title='CD4 only PCA')
d <- ggplot(cd8_cbind_dt, aes(x=PC1, y=PC2)) + 
  geom_point(aes(color=car, shape=k562, alpha=as.factor(donor))) +
  labs(title='CD8 only PCA')

grid.arrange(a, b, c, d, ncol=2)


# use cbind to add PCs to original diff_cast_dt
# use pc2/3 instead of 1/2
# rank input vars against which PCs they contribute to
# plot points by car, day, donor, etc
# connect points up by day (bonus points: use directional arrows by day)

```

# quality checks
```{r}

# scree plot of different PCs -- this just checks quality(?). PC1 should have highest variance
screeplot(diff_pca, npcs=length(diff_pca$sdev))


# getting list of input variables as data.table
rotation_rows <- data.table(row.names(diff_pca$rotation))
setnames(rotation_rows, "V1", "input_var")

# cbind variances with input variable names
rotation_dt <- cbind(rotation_rows, data.table(diff_pca$rotation))


# rank input variables against which PCs they contribute to
# adds new column of which PC has highest rotation for each input variable
rotation_dt[, highest_pc := names(rotation_dt[, 2:ncol(rotation_dt)])[max.col(abs(rotation_dt[, 2:ncol(rotation_dt)]))]]

rotation_dt[, c("input_var", "highest_pc")]

# ordering input variables for top 3 PCs by absolute value
pc1_dt <- rotation_dt[, 1:2][order(-abs(PC1)), ]
pc2_dt <- rotation_dt[, c(1,3)][order(-abs(PC2)), ]
pc3_dt <- rotation_dt[, c(1,4)][order(-abs(PC3)), ]

```


# general PCA plots
```{r}

# cd19+ vs. t_type
ggplot(diff_cbind_dt[k562=='cd19+' & t_type=='cd4'], aes(x=PC2, y=PC3)) + 
  geom_point(aes(color=car, shape=as.factor(donor), size=1)) +
  scale_color_npg() +
  labs(title="PCA - CD4 CD19+") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5, size = 24),
        legend.title = element_text(size=20),
        legend.text = element_text(size=18),
        axis.title = element_text(size=20))

ggplot(diff_cbind_dt[k562=='cd19+' & t_type=='cd8'], aes(x=PC2, y=PC3)) + 
  geom_point(aes(color=car, shape=as.factor(donor), size=1)) +
  scale_color_npg() +
  labs(title="PCA - CD8 CD19+") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5, size = 24),
        legend.title = element_text(size=20),
        legend.text = element_text(size=18),
        axis.title = element_text(size=20))


# cd19- vs. t_type
ggplot(diff_cbind_dt[k562=='cd19-' & t_type=='cd4'], aes(x=PC2, y=PC3)) + 
  geom_point(aes(color=car, shape=as.factor(donor), size=1)) +
  scale_color_npg() +
  labs(title="PCA - CD4 CD19-") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5, size = 24),
        legend.title = element_text(size=20),
        legend.text = element_text(size=18),
        axis.title = element_text(size=20))

ggplot(diff_cbind_dt[k562=='cd19-' & t_type=='cd8'], aes(x=PC2, y=PC3)) + 
  geom_point(aes(color=car, shape=as.factor(donor), size=1)) +
  scale_color_npg() +
  labs(title="PCA - CD8 CD19-") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5, size = 24),
        legend.title = element_text(size=20),
        legend.text = element_text(size=18),
        axis.title = element_text(size=20))


# facet plots
ggplot(diff_cbind_dt, aes(x=PC2, y=PC3)) + 
  geom_point(aes(color=car, shape=as.factor(donor))) +
  scale_color_npg() +
  labs(title="PCA - PC2/PC3") +
  facet_grid(t_type + k562 ~ day) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5, size = 24),
        legend.title = element_text(size=20),
        legend.text = element_text(size=18),
        axis.title = element_text(size=20))

ggplot(diff_cbind_dt, aes(x=PC1, y=PC2)) + 
  geom_point(aes(color=car, shape=as.factor(donor))) +
  scale_color_npg() +
  labs(title="PCA - PC1/PC2") +
  facet_grid(t_type + k562 ~ day) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5, size = 24),
        legend.title = element_text(size=20),
        legend.text = element_text(size=18),
        axis.title = element_text(size=20))

ggplot(diff_cbind_dt[k562=='cd19+'], aes(x=PC2, y=PC3)) + 
  geom_point(aes(color=car, shape=as.factor(donor))) +
  scale_color_npg() +
  labs(title="PCA - CD19+") +
  facet_grid(t_type + k562 ~ day) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5, size = 24),
        legend.title = element_text(size=20),
        legend.text = element_text(size=18),
        axis.title = element_text(size=20))



```


# cd19 only, cd4 only, cd8 only PCA plots for comparisons
```{r}

ggplot(cd8_cbind_dt, aes(x=PC2, y=PC3)) + 
  geom_point(aes(color=as.factor(day), shape=as.factor(donor))) +
  scale_color_npg() +
  labs(title="CD8 only PCA") +
  facet_grid(car ~ k562) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5, size = 24),
        legend.title = element_text(size=20),
        legend.text = element_text(size=18),
        axis.title = element_text(size=20))



```

