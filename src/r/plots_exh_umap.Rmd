---
title: "Exhaustion Plots for Arrayed Screens"
output:
  html_document:
    df_print: paged
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = here::here('..','html'))})
---

# Load packages and umap functions 
```{r setup}
library(ggplot2)
library(data.table)
library(scales)
library(RColorBrewer)
library(reticulate)
library(uwot)
library(gridExtra)
library(spatstat)
library(ggdendro)
library(cowplot)
library(tidyverse)
library(grid)
library(gridExtra) # add to AWS
library(cowplot) # add to AWS
library(slingshot) # add to AWS
library(viridis) # add to AWS
library(reshape2)
library(RColorBrewer)
library(ggrepel)

source('umap.R')

use_condaenv(condaenv = 'r-reticulate', required = TRUE)
```

# Load data
```{r}
data_dir <- here::here('..','data')
load(file.path(data_dir, 'exh.sampled.Rdata'))
#file not found, but exh_dt is already an object in the .Rdata file
#exh_dt <- fread(file.path(data_dir, 'exh.sampled.csv.gz'))

censor_negative_min = -1500
redo_umap_clustering = F
redo_umap_param_search = F

#only redo param search if doing clustering also:
redo_umap_param_search = redo_umap_param_search && redo_umap_clustering

# map day 0 to both plus and minus
map_day_0 <- function(df) {
  return(rbind(
    df[k562!='none'], #gets all cd19+-
    #df[rep(keep_none, .N) & k562=='none' & day > 0], 
    df[k562=='none' & day == 0][, k562 := 'cd19+'], #none and day 0, assign as 19+
    df[k562=='none' & day == 0][, k562 := 'cd19-'], #none and day 0, assign as 19-
    df[car =='untrans' & day != 0][, k562 := 'cd19+'], #add back untrans
    df[car =='untrans' & day != 0][, k562 := 'cd19-']
  ))
}

censor_negative_min = -1500
redo_umap_clustering = F
redo_umap_param_search = F

```

# Filter Data
## Separate CD4 and CD8
```{r, eval=redo_umap_clustering}
#filter exh_dt by cd4/8 type, cd19+ (map day 0), by donor if needed

#cd4, cd19+, donor 
exh_dt_cd4 <- exh_dt %>% map_day_0() %>% filter(t_type == 'cd4', k562=='cd19+')

#cd8, cd19+, donor
exh_dt_cd8 <- exh_dt %>% map_day_0() %>% filter(t_type == 'cd8', k562=='cd19+')
```

## Run this chunk when using both donors
```{r, eval=redo_umap_clustering}
## Remove car/day combinations that aren't in both donors, by t_type
cd4_matches <- plyr::match_df(exh_dt %>% map_day_0 %>% filter(t_type == 'cd4', donor == 2, k562=='cd19+') %>% filter(!is.na(event_id)) %>% distinct(car, day), exh_dt %>% map_day_0 %>% filter(t_type == 'cd4', donor == 1, k562=='cd19+') %>% filter(!is.na(event_id)) %>% distinct(car, day)) %>% arrange(day)

cd8_matches <- plyr::match_df(exh_dt %>% map_day_0 %>% filter(t_type == 'cd8', donor == 2, k562=='cd19+') %>% filter(!is.na(event_id)) %>% distinct(car, day), exh_dt %>% map_day_0 %>% filter(t_type == 'cd8', donor == 1, k562=='cd19+') %>% filter(!is.na(event_id)) %>% distinct(car, day)) %>% arrange(day)

#filter exh_dt by matched combinations
exh_dt_cd4 <- plyr::match_df(exh_dt_cd4, cd4_matches)
exh_dt_cd8 <- plyr::match_df(exh_dt_cd8, cd8_matches)
```

## Remove Day 33
```{r, eval=redo_umap_clustering}
# remove day 33
exh_dt_cd4 <- exh_dt_cd4 %>% filter(!day == 33) %>% filter(!car %in% c('KLRG1', 'untrans'))
exh_dt_cd8 <- exh_dt_cd8 %>% filter(!day == 33) %>% filter(!car %in% c('KLRG1', 'untrans'))
```

# UMAP

For now, skip straight to high dimensional plotting.

## UMAP Functions
```{r}
#grab channel map from cd4 data (cd4/8 are the same)
channel_map <- exh_opt_cd4$channel_map

# for now use all variables in the channel map except cd4/8
umap_vars <- c(paste0(names(channel_map),'_t'))

# removing zombie, cd_t, myc_t, gfp_t
umap_vars <- umap_vars[!umap_vars %in% c('cd8_t', 'zombie_t', 'myc_t', 'gfp_t')]
```

## Run UMAP
Scaling this to 200 events per well and checking CAR/condition separation.

```{r, eval=redo_umap_clustering}
umap_cd4_fcs_dt <- run_umap(exh_dt_cd4, 0.005, 15, 1000, umap_vars)
umap_cd8_fcs_dt <- run_umap(exh_dt_cd8, 0.005, 15, 1000, umap_vars)

fwrite(umap_cd4_fcs_dt, 
  compress='gzip',
  file=file.path(here::here('..','data','exh.sampled.umap_cd4.csv.gz')))

fwrite(umap_cd8_fcs_dt, 
  compress='gzip',
  file=file.path(here::here('..','data','exh.sampled.umap_cd8.csv.gz')))

# sync output back to s3
system('aws s3 sync \\
  --exclude "*" \\
  --include "*.Rdata" \\
  --include "*.csv*" \\
  ~/local-tcsl/data s3://roybal-tcsl/lenti_screen_compiled_data/data')
```

## Cluster Analysis

### UMAP Plots
```{r, fig.width=15, fig.height=15}
#read in cd8 umap data
umap_cd8_fcs_dt <- fread(
  file.path(
    here::here('..','data','exh.sampled.umap_cd8.csv.gz')))
umap_cd8_fcs_dt[, cluster := factor(cluster)]

umap_cd8_cluster_dt <- umap_cd8_fcs_dt[, list(
  mean_umap_1= mean(umap_1), 
  mean_umap_2= mean(umap_2), 
  size= .N), by=cluster]

#read in cd4 umap data
umap_cd4_fcs_dt <- fread(
  file.path(
    here::here('..','data','exh.sampled.umap_cd4.csv.gz')))
umap_cd4_fcs_dt[, cluster := factor(cluster)]

umap_cd4_cluster_dt <- umap_cd4_fcs_dt[, list(
  mean_umap_1= mean(umap_1), 
  mean_umap_2= mean(umap_2), 
  size= .N), by=cluster]

#plot umap
#CD8
ggumap(umap_cd8_fcs_dt, umap_cd8_cluster_dt)

#CD4
ggumap(umap_cd4_fcs_dt, umap_cd4_cluster_dt)
```

### UMAP Color Plots
```{r, fig.width=15, fig.height=10}
#cd8
color_plots(umap_cd8_fcs_dt, umap_vars)

#cd4
color_plots(umap_cd4_fcs_dt, umap_vars)
```

## Temporal UMAP Visualizations 
### Contour Plots

#### All CARs
```{r, fig.width=15, fig.height=3}
#all cars by day
all_by_day(umap_cd8_fcs_dt)

all_by_day(umap_cd4_fcs_dt)
```

#### Individual CARs
```{r fig.width=22, fig.height=15}
#CD8
umap_contour_plots(umap_cd8_fcs_dt)

#CD4
umap_contour_plots(umap_cd4_fcs_dt)
```

## Grouped Cluster Plots 

```{r, fig.width=22, fig.height=30}
#CD8
all_plots(umap_cd8_fcs_dt, channel_map, umap_vars, 'CD8', dendro=F)

#CD4
all_plots(umap_cd4_fcs_dt, channel_map, umap_vars, 'CD4', dendro=F)
```

```{r fig.width=30, fig.height=20}
# LAG3 PD1 scatter plot
exh_fcs_dt_cd4 <- exh_dt_cd4 %>% spread(variable, value) %>% drop_na()
exh_fcs_dt_cd8 <- exh_dt_cd8 %>% spread(variable, value) %>% drop_na()

#cd4
# 1480.128, 524.7249 (donor 1)
# # 1488.827, 532.0457 (donor 2)

normalized_exh_fcs_dt_cd4 <- exh_fcs_dt_cd4 %>% 
  mutate(pd1_plus_lag3 = pd1_t + lag3_t) %>%
  mutate(pd1_minus_lag3 = pd1_t - lag3_t) %>% 
  group_by(car, day, donor) %>% 
  mutate(mean_pd1_plus_lag3 = mean(pd1_plus_lag3), mean_pd1_minus_lag3 = mean(pd1_minus_lag3)) %>%
  select(mean_pd1_plus_lag3, mean_pd1_minus_lag3) %>% 
  mutate(scaled_mean_pd1_plus_lag3 = ifelse(donor == 1, scale(mean_pd1_plus_lag3, center = 1480.128, scale=F), scale(mean_pd1_plus_lag3, center = 1488.827, scale=F)),
         scaled_mean_pd1_minus_lag3 = ifelse(donor == 1, scale(mean_pd1_minus_lag3, center = 524.7249, scale=F), scale(mean_pd1_minus_lag3, center = 532.0457, scale=F))) 


#cd8
# 1476.901, 432.5879 (donor 1)
# # 1437.787, 392.5497 (donor 2)

normalized_exh_fcs_dt_cd8 <- exh_fcs_dt_cd8 %>% 
  mutate(pd1_plus_lag3 = pd1_t + lag3_t) %>%
  mutate(pd1_minus_lag3 = pd1_t - lag3_t) %>% 
  group_by(car, day, donor) %>% 
  mutate(mean_pd1_plus_lag3 = mean(pd1_plus_lag3), mean_pd1_minus_lag3 = mean(pd1_minus_lag3)) %>%
  select(mean_pd1_plus_lag3, mean_pd1_minus_lag3) %>% 
  mutate(scaled_mean_pd1_plus_lag3 = ifelse(donor == 1, scale(mean_pd1_plus_lag3, center = 1476.901, scale=F), scale(mean_pd1_plus_lag3, center = 1437.787, scale=F)),
         scaled_mean_pd1_minus_lag3 = ifelse(donor == 1, scale(mean_pd1_minus_lag3, center = 432.5879, scale=F), scale(mean_pd1_minus_lag3, center = 392.5497, scale=F))) 

label_biomarkers_day_cd4 <- normalized_exh_fcs_dt_cd4 %>% distinct(car, day, donor, scaled_mean_pd1_minus_lag3, scaled_mean_pd1_plus_lag3)%>% filter(!day ==33)

label_biomarkers_day_cd8 <- normalized_exh_fcs_dt_cd8 %>% distinct(car, day, donor, scaled_mean_pd1_minus_lag3, scaled_mean_pd1_plus_lag3) %>% filter(!day ==33)

normalized_exh_fcs_dt_cd8 %>%
  filter(!day == 33) %>%
  arrange(car, day, donor) %>%
  ggplot(., aes(x=scaled_mean_pd1_minus_lag3, y = scaled_mean_pd1_plus_lag3, color=car)) +
  geom_point(size=2) + 
  geom_path() + 
  geom_label_repel(aes(label=day), fill='white', data=label_biomarkers_day_cd8) + 
  theme_minimal() + 
  facet_grid(. ~ donor) + 
  theme(panel.spacing = unit(2, "lines")) + 
  ggtitle('CD8 CARs - LAG3 vs. PD1 relationship')


normalized_exh_fcs_dt_cd4 %>%
  filter(!day == 33) %>%
  arrange(car, day, donor) %>%
  ggplot(., aes(x=scaled_mean_pd1_minus_lag3, y = scaled_mean_pd1_plus_lag3, color=car)) +
  geom_point(size=2) + 
  geom_path() + 
  geom_label_repel(aes(label=day), fill='white', data=label_biomarkers_day_cd4) + 
  theme_minimal() + 
  facet_grid(. ~ donor) + 
  theme(panel.spacing = unit(2, "lines")) + 
  ggtitle('CD4 CARs - LAG3 vs. PD1 relationship')

```




### Labeled Leiden Clusters Map
```{r fig.width=15, fig.height=8, eval=F}
# manually determined 
#CD8
cd8_diff_by_cluster <- data.frame("cluster" = c(1:20), "cell_type" = c('1-TN', '2-TN', '3-TEM', '4-TSCM (cd95-)', '5-TCM', '6-TEM', '7-TEMRA', '8-TEFF (cd27+)', '9-TEM', '10-TEM (cd27+)', '11-TN', '12-TEM', '13-TCM', '14-TEM', '15-TEM (cd27+)', '16-TN', '17-TEM', '18-TEM', '19-TEFF', '20-TN'))
cd8_diff_by_cluster$cluster <- as.factor(cd8_diff_by_cluster$cluster)
umap_cd8_fcs_dt <- left_join(umap_cd8_fcs_dt, cd8_diff_by_cluster, by='cluster')

#CD4
cd4_diff_by_cluster <- data.frame("cluster" = c(1:20), "cell_type" = c('1-TN', '2-TN', '3-TEM', '4-TSCM', '5-TEM', '6-TCM', '7-TEM (cd27+)', '8-TEMRA (cd62l+, cd27+)', '9-TEMRA', '10-TEMRA (cd61l+, cd27+)', '11-TEM (cd27+)', '12-TCM', '13-TEM', '14-TEMRA', '15-TEM (cd27+)', '16-TEM (cd27+)', '17-TEM', '18-TEMRA (cd27+)', '19-TEM', '20-TEM'))
cd4_diff_by_cluster$cluster <- as.factor(cd4_diff_by_cluster$cluster)
umap_cd4_fcs_dt <- left_join(umap_cd4_fcs_dt, cd4_diff_by_cluster, by='cluster')

#Labeled Leiden Clusters Map

#cd8
visualize_clusters_umap(umap_cd8_fcs_dt)

#cd4
visualize_clusters_umap(umap_cd4_fcs_dt)
```

## Batch Effect (Run when using both donors for UMAP)
```{r fig.width=20, fig.height=11}
# bar plot showing points per cluster by donor
batch_effect_bars <- function(umap_df) {
  umap_df %>% 
  group_by(cluster, car, day) %>% 
  count(donor) %>% rename(donor_count = n) %>% 
  group_by(cluster, donor) %>% 
  summarise(Sum = sum(donor_count)) %>% 
  ggplot(., aes(x=cluster, y=Sum, fill=factor(donor))) + 
  geom_bar(stat="identity", position = position_dodge()) + 
  theme_minimal() + 
  scale_fill_discrete(name="Donor", breaks=c("1", "2"), labels=c("Donor 1", "Donor 2"))
}

batch_effect_bars(umap_cd8_fcs_dt)

label_donor_umap <- umap_cd8_fcs_dt %>% group_by(donor) %>% select(umap_1, umap_2) %>% summarize_all(mean)
ggplot(umap_cd8_fcs_dt, aes(x=umap_1, y=umap_2, color=as.factor(donor)))+geom_point(size=0.1,alpha = 0.5, position=position_jitter(h=0.15,w=0.15))+theme(panel.grid.major = element_blank(), panel.grid.minor=element_blank())+geom_label(aes(label=donor), data=label_donor_umap, size=5)+guides(colour=FALSE)+ggtitle('UMAP by Donor') + scale_color_viridis(discrete=TRUE)+theme_minimal()

batch_effect_bars(umap_cd4_fcs_dt)

label_donor_umap_cd4 <- umap_cd4_fcs_dt %>% group_by(donor) %>% select(umap_1, umap_2) %>% summarize_all(mean)
ggplot(umap_cd4_fcs_dt, aes(x=umap_1, y=umap_2, color=as.factor(donor)))+geom_point(size=0.1,alpha = 0.5, position=position_jitter(h=0.15,w=0.15))+theme(panel.grid.major = element_blank(), panel.grid.minor=element_blank())+geom_label(aes(label=donor), data=label_donor_umap_cd4, size=5)+guides(colour=FALSE)+ggtitle('UMAP by Donor') + scale_color_viridis(discrete=TRUE)+theme_minimal()
```

## Correlation

```{r fig.width=15, fig.height=11, eval=F}
#cd8
biomarker_corr_by_day(umap_cd8_fcs_dt)
biomarker_corr_by_car(umap_cd8_fcs_dt)

#cd4
biomarker_corr_by_day(umap_cd4_fcs_dt)
biomarker_corr_by_car(umap_cd4_fcs_dt)
```
